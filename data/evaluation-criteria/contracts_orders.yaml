name: contracts-orders-criteria
version: "1.0"
step: contracts_orders
description: Rules for contracts and orders table generation

criteria:
  - id: CO-001
    name: price-step-up-segments
    description: Each pricing period must appear as separate line item
    severity: critical
    patterns: [step-up, ramp, introductory, promotional, price change]
    check:
      type: behavioral
      rule: |
        If input has multiple price periods (e.g., introductory pricing,
        annual ramps), output MUST have one row per price period with:
        - Distinct Revenue Start Date and Revenue End Date
        - Correct Unit Sell Price for that specific period
        - Extended amounts calculated for that period only
        - Separate Line Item Num for each segment
    examples:
      passing:
        - scenario: "3 months @ $15, then 9 months @ $20"
          expected: "Two lines: Line 1 for $45 (3x$15), Line 2 for $180 (9x$20)"
      failing:
        - scenario: "3 months @ $15, then 9 months @ $20"
          incorrect: "Single line for $225 total"
          why: "Should be 2 lines with distinct dates and amounts per period"

  - id: CO-002
    name: revenue-date-alignment
    description: Revenue dates must match service period for each segment
    severity: critical
    patterns: [revenue date, service period, recognition period]
    check:
      type: behavioral
      rule: |
        Revenue Start Date and Revenue End Date must match the
        actual service period for each charge segment:
        - For segment 1 of a ramp: contract start to segment 1 end
        - For segment 2: day after segment 1 ends to segment 2 end
        Revenue dates should NOT span across different pricing periods.

  - id: CO-003
    name: extended-price-calculation
    description: Extended prices must be mathematically correct
    severity: critical
    patterns: [extended price, Ext Sell Price, Ext List Price, calculation]
    check:
      type: numeric
      rule: |
        Ext Sell Price = Unit Sell Price x Ordered Qty x Terms Months
        Ext List Price = Unit List Price x Ordered Qty x Terms Months
        These calculations must be accurate for each line item.
      threshold: 0.01

  - id: CO-004
    name: line-item-identification
    description: Line Item Num must uniquely identify each charge
    severity: medium
    patterns: [line item, charge, identifier]
    check:
      type: behavioral
      rule: |
        Line Item Num identifies the charge/POB. It is equal to the chargeName. Simple.
        Each charge from the subscription spec gets its own Line Item Num.
        For ramp segments of the same service, each segment is a separate line.

  - id: CO-005
    name: currency-consistency
    description: All currency values must use the transaction currency
    severity: high
    patterns: [currency, USD, EUR, transaction currency]
    check:
      type: behavioral
      rule: |
        All monetary amounts in the table must use the
        transaction currency specified in the input.
        Currency symbols/codes should be consistent.

  - id: CO-006
    name: pob-satisfied-accuracy
    description: POB Satisfied must indicate recognition timing
    severity: high
    patterns: [POB Satisfied, over time, point in time]
    check:
      type: behavioral
      rule: |
        POB Satisfied must be a string indicating recognition pattern:
        - "Over Time" for ratable recognition (OT POB templates)
        - "Point In Time" for immediate recognition (PIT POB templates)
        The value must match the POB template type (OT vs PIT).

  - id: CO-007
    name: charge-name-consistency
    description: Charge names must match subscription spec
    severity: medium
    patterns: [charge name, line item num, product, service name]
    check:
      type: behavioral
      rule: |
        Line Item Num & POB Name in contracts/orders must match the
        chargeName from the subscription specification.
        For multi-segment charges, include segment identifier
        (e.g., "Service - Promo Period", "Service - Standard").

  - id: CO-008
    name: sales-order-date-accuracy
    description: Sales Order Date must match contract effective date
    severity: high
    patterns: [sales order date, contract date, order date]
    check:
      type: behavioral
      rule: |
        Sales Order Date should be the contract effective date in
        MM/DD/YYYY format, representing when the order was placed.
        All line items in the same contract share the same Sales Order Date.

  - id: CO-009
    name: ssp-allocation-math
    description: SSP allocation must be mathematically correct
    severity: critical
    patterns: [SSP, allocation, percent, allocated price]
    check:
      type: numeric
      rule: |
        When is_allocations = true:
        1. SSP Percent = (Ext SSP Price / Total Ext SSP) x 100
        2. Ext Allocated Price = Total Transaction Price x (SSP Percent / 100)
        3. Sum of all Ext Allocated Price = Sum of all Ext Sell Price
        Allocation must redistribute transaction price by SSP ratios.
      threshold: 0.01

  - id: CO-010
    name: carves-balance
    description: Carves adjustments must net to zero
    severity: high
    patterns: [carves, adjustment, carve-in, carve-out]
    check:
      type: numeric
      rule: |
        If Carves Adjustment is used on any line items:
        - Carve-out (negative) reduces source POB
        - Carve-in (positive) increases destination POB
        - Sum of all Carves Adjustment across all lines = 0
      threshold: 0.01

  - id: CO-011
    name: pob-identifier-match
    description: POB identifiers must match the POB mapping
    severity: critical
    patterns: [POB IDENTIFIER, POB Template, mapping]
    check:
      type: behavioral
      rule: |
        The output includes both contracts_orders and pob_mapping.
        POB IDENTIFIER and POB Template on each line in
        contracts_orders.zr_contracts_orders must exactly match
        pob_identifier values from pob_mapping.charge_pob_map.
        No invented identifiers allowed.
  - id: CO-012
    name: date-format-consistency
    description: Dates must use correct formats per field
    severity: high
    patterns:
      [date format, Revenue Start Date, Revenue End Date, Sales Order Date]
    check:
      type: behavioral
      rule: |
        Different date fields require different formats:
        - Revenue Start Date: YYYY-MM-DD format
        - Revenue End Date: YYYY-MM-DD format
        - Sales Order Date: MM/DD/YYYY format
        Do not mix formats between these fields.
