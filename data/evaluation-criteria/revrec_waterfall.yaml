name: revrec-waterfall-criteria
version: "1.0"
step: revrec_waterfall
description: Rules for revenue recognition waterfall generation

criteria:
  - id: RR-001
    name: recognition-period-alignment
    description: Recognition periods must align with service delivery
    severity: critical
    patterns: [recognition period, service period, revenue timing]
    check:
      type: behavioral
      rule: |
        Revenue recognition periods must match when service is
        delivered, not when billed. For ratable revenue:
        - Daily recognition over the service period
        - Recognition amount = (Annual Amount / Days) × Days in Period
        For point-in-time: full recognition at delivery.

  - id: RR-002
    name: monthly-recognition-accuracy
    description: Monthly recognition amounts must be correct
    severity: critical
    patterns: [monthly, recognition, amount]
    check:
      type: numeric
      rule: |
        For daily-prorated ratable revenue (no '-PM' at the end of the POB Template):
        Monthly Amount = (Annual Amount / Total Days) × Days in Month
        Account for varying days per month (28-31 days).
      threshold: 0.01

  - id: RR-003
    name: ramp-revenue-handling
    description: Ramp pricing must use average rate per ASC 606
    severity: critical
    patterns: [ramp, step-up, pricing change]
    check:
      type: behavioral
      rule: |
        For ramp scenarios with different prices across periods:
        1. Calculate average rate: Total Value / Total Months
        2. Recognize using average rate each month (consistent amounts)
        This creates a straight-line recognition regardless of
        billing amounts, per ASC 606 requirements.
    examples:
      passing:
        - scenario: "Y1: $10,000, Y2: $12,000, Y3: $14,000"
          expected: "Every month recognizes $1,000 ($36,000/36 months)"
      failing:
        - scenario: "Y1: $10,000, Y2: $12,000, Y3: $14,000"
          incorrect: "Y1: $833/mo, Y2: $1,000/mo, Y3: $1,167/mo"
          why: "Must use averaged rate across entire term"

  - id: RR-004
    name: event-driven-zero-rule
    description: Event-driven POBs must show $0 without event data
    severity: critical
    patterns: [event-driven, EVT-PIT, consumption, usage]
    check:
      type: behavioral
      rule: |
        For event-driven, point-in-time POB templates (EVT-PIT-*):
        - If no usage/event data is provided, Amount = $0 for ALL periods
        - Add open_question asking for usage/consumption data
        - Do NOT spread ratably or invent amounts
        Revenue only recognized when actual consumption events occur.

  - id: RR-005
    name: line-item-amount-reconciliation
    description: Sum of amounts per line must equal Ext Allocated Price
    severity: critical
    patterns: [total revenue, allocated price, sum]
    check:
      type: numeric
      rule: |
        The output includes revrec_waterfall, contracts_orders, and pob_mapping.
        For each Line Item Num in revrec_waterfall.zr_revrec, the sum
        of all Amount values across all periods must equal the
        Ext Allocated Price from contracts_orders.zr_contracts_orders
        for that line.
        Sum(Amount for Line X) = Ext Allocated Price for Line X
      threshold: 0.01

  - id: RR-006
    name: recognition-by-pob
    description: Recognition must be broken down by POB
    severity: medium
    patterns: [POB, performance obligation, allocation]
    check:
      type: behavioral
      rule: |
        If multiple POBs exist, revenue recognition should
        be shown separately for each POB, allowing the user
        to see how each obligation is being satisfied.

  - id: RR-007
    name: period-consistency
    description: Recognition periods must be consistent
    severity: medium
    patterns: [period, monthly, calendar]
    check:
      type: behavioral
      rule: |
        Recognition periods should be calendar months
        (or matching the reporting period). First and last
        months may be partial based on service dates.

  - id: RR-008
    name: allocation-accuracy
    description: SSP allocations must be applied correctly
    severity: high
    patterns: [allocation, SSP, standalone selling price]
    check:
      type: behavioral
      rule: |
        If allocation is required (multiple elements have Allocation Eligible Flag set to true):
        - Calculate SSP ratios
        - Apply ratios to total transaction price
        - Recognize based on allocated amounts, not list prices
        Allocated Amount = (SSP / Total SSP) × Transaction Price

  - id: RR-009
    name: period-format
    description: Period must use MMM-YY format
    severity: high
    patterns: [period, format, date]
    check:
      type: behavioral
      rule: |
        The Period field must use "MMM-YY" format:
        - Examples: "Jan-26", "Feb-26", "Dec-27"
        - Three-letter month abbreviation with hyphen and 2-digit year
        Do not use full dates, ISO format, or month numbers.

  - id: RR-010
    name: recognition-pattern-alignment
    description: Recognition must follow the POB template pattern
    severity: critical
    patterns: [ratable, point-in-time, OT, PIT]
    check:
      type: behavioral
      rule: |
        The output includes revrec_waterfall, contracts_orders, and pob_mapping.
        Recognition pattern in revrec_waterfall.zr_revrec must match
        the POB template from pob_mapping.charge_pob_map:
        - BK-OT-*, BL-OT-* (Over Time): Spread ratably over revenue window
        - BK-PIT-*, BL-PIT-* (Point-in-Time): 100% in single period
        - EVT-PIT-* (Event-Driven): $0 until events, then per-event
        Follow WATERFALL INSTRUCTIONS from the POB mapping exactly.

  - id: RR-011
    name: ppdd-recognition-patterns
    description: PPDD charges must follow correct recognition pattern
    severity: high
    patterns: [PPDD, prepaid, drawdown, consumption]
    check:
      type: behavioral
      rule: |
        Prepaid with Drawdown (PPDD) has two patterns:
        - BK-OT-CONSUMP-RATABLE: Prepaid spread ratably over term,
          NOT tied to consumption events
        - EVT-PIT-CONSUMP-USAGE: Revenue = $0 until consumption,
          then Amount = Units × Unit Rate per event
        Do not mix these patterns.
