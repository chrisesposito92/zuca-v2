name: design-subscription-criteria
version: "1.0"
step: design_subscription
description: Rules for subscription specification and POB mapping

criteria:
  - id: DS-001
    name: price-step-up-segments
    description: Each pricing period must create separate charge segments
    severity: critical
    patterns: [step-up, ramp, introductory, promotional, price change]
    check:
      type: behavioral
      rule: |
        If the contract has different prices for different periods
        (e.g., "first 3 months at $15, then $20 for remaining months"),
        the output MUST have separate charges for each period:
        - Charge 1: Promo period with its dates and price
        - Charge 2: Standard period with its dates and price
        DO NOT collapse into a single charge with averaged pricing.
    examples:
      passing:
        - scenario: "3 months @ $15, then 9 months @ $20"
          expected: "Two charges: Promo Period ($15) and Standard Period ($20)"
      failing:
        - scenario: "3 months @ $15, then 9 months @ $20"
          incorrect: "Single charge at $225 total or $18.75 average"
          why: "Must be separate charges per pricing period"

  - id: DS-002
    name: charge-effective-dates
    description: Charge effective dates must match service periods
    severity: critical
    patterns: [effective date, service period, start, end]
    check:
      type: behavioral
      rule: |
        Each charge's effectiveStart and effectiveEnd must accurately
        reflect when that specific price/service applies. For ramps:
        - First segment: starts at contract start
        - Subsequent segments: start when previous ends + 1 day
        - Last segment: ends at contract end

  - id: DS-003
    name: charge-type-accuracy
    description: Charge type must match the billing model
    severity: high
    patterns: [recurring, one-time, usage, charge type]
    check:
      type: behavioral
      rule: |
        Charge type must be correctly assigned:
        - "Recurring" for subscription fees billed periodically
        - "OneTime" for setup fees, activation fees
        - "Usage" for consumption-based charges

  - id: DS-004
    name: billing-period-consistency
    description: Billing period must be consistent with contract terms
    severity: high
    patterns: [billing period, monthly, quarterly, annual]
    check:
      type: behavioral
      rule: |
        The billingPeriod on each charge must match what was
        extracted during contract analysis. All charges in a
        subscription typically share the same billing period
        unless explicitly specified otherwise.

  - id: DS-005
    name: pob-mapping-completeness
    description: Every charge must have a POB mapping
    severity: high
    patterns: [POB, performance obligation, revenue recognition]
    check:
      type: behavioral
      rule: |
        The output includes both subscription_spec (with rate_plans/charges)
        and pob_mapping (with charge_pob_map array).
        Every charge in subscription_spec.rate_plans[*].charges must have a
        corresponding entry in pob_mapping.charge_pob_map.
        No charges should be left unmapped.

  - id: DS-006
    name: recognition-window-alignment
    description: Recognition windows must align with service periods
    severity: high
    patterns: [recognition window, service period, revenue period]
    check:
      type: behavioral
      rule: |
        In pob_mapping.charge_pob_map, each entry's recognition_window
        (start_date, end_date) must match the actual service delivery
        period for that charge. For ratable revenue, this is typically
        the charge's effective period from subscription_spec. An exception
        exists for discount charges that have their start and end dates aligned to the
        charge the discount is for (ex: 12 month ratable subscription with first 3 months free.
        Depending on settings in tenant, the discount and the charge itself could both have the same
        12 month recognition window). Also, PIT lines can still have a recognition_window that aligns
        with the service period.

  - id: DS-007
    name: ratable-method-accuracy
    description: Ratable method must match the revenue pattern
    severity: medium
    patterns: [ratable, straight-line, daily, prorated]
    check:
      type: behavioral
      rule: |
        In pob_mapping.charge_pob_map, ratable_method should be set:
        - "Ratable" for services recognized over time (ratable OT POBs)
        - Match the POB template ratable method
        Common values include "Ratable", "Daily Prorated"

  - id: DS-010
    name: pob-identifier-validity
    description: POB identifiers must come from the provided template list
    severity: critical
    patterns: [POB, identifier, template, BK-, BL-, EVT-]
    check:
      type: behavioral
      rule: |
        In pob_mapping.charge_pob_map, each pob_identifier MUST be
        from the "Available ZR POB templates" list. Never invent identifiers.

        VALID POB IDENTIFIERS (exhaustive list):
        Booking release (BK-):
        - BK-OT-CONSUMP-RATABLE
        - BK-OT-CONSUMP-RATABLE-VC
        - BK-OT-RATABLE
        - BK-OT-RATABLE-PM
        - BK-PIT-CURRENT_PERIOD
        - BK-PIT-STARTDATE

        Billing release (BL-):
        - BL-OT-INVRAT-PM
        - BL-OT-INVRATABLE
        - BL-PIT-CONSUMP-PAYGO
        - BL-PIT-CURRENT_PERIOD
        - BL-PIT-STARTDATE

        Event release (EVT-):
        - EVT-OT-RATABLE
        - EVT-OT-RATABLE-GOLIVE
        - EVT-PIT-ACCEPTAN
        - EVT-PIT-AMOUNT
        - EVT-PIT-COMPLETION
        - EVT-PIT-CONSUMP-DELIVERY
        - EVT-PIT-CONSUMP-PAYGO
        - EVT-PIT-CONSUMP-USAGE
        - EVT-PIT-CUMPERCENT
        - EVT-PIT-HOURS
        - EVT-PIT-POC
        - EVT-PIT-QTY
        - EVT-PIT-USAGE

        Only flag as invalid if the identifier is NOT in this list.

  - id: DS-008
    name: sell-price-accuracy
    description: Sell prices must match contract amounts
    severity: critical
    patterns: [price, amount, sell price, unit price]
    check:
      type: numeric
      rule: |
        sellPrice on each charge must match the contracted
        amount for that specific period. Do not average prices
        across multiple periods into a single charge.
      threshold: 0.01

  - id: DS-009
    name: usage-amounts-correct
    description: Every STANDALONE usage charge must have a quantity that matches the generate usage records
    severity: high
    patterns: [Usage, quantity, revenue recognition]
    check:
      type: numeric
      rule: |
        Every STANDALONE usage charge must have a quantity that matches 
        the sum of the generated usage records.
      threshold: 0.01
