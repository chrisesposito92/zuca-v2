{
  "version": "1.0",
  "created_at": "2025-12-31T03:42:34.409Z",
  "updated_at": "2025-12-31T21:18:00.977Z",
  "stats": {
    "total_examples": 89,
    "by_step": {
      "contracts_orders": 18,
      "billings": 37,
      "revrec_waterfall": 29,
      "design_subscription": 5
    },
    "by_source": {
      "evaluation_pass": 89
    }
  },
  "examples": [
    {
      "id": "e29c6468-2f3a-4806-9cf9-949597297f2a",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Sequential (1, 2, 3...)\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n1. Only include VC to the extent a significant reversal is NOT probable\n2. Use constrained estimate for allocation\n3. When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n- Create separate lines for each component\n- Each component has its own POB template\n- SSP comes from bundle config\n- Allocate across components\n- Total allocated = Original bundle price\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment date\n- Retrospective: Reallocate all lines\n- Prospective: Only new lines allocated, existing unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price)\n2. Revenue Start Date ≤ Revenue End Date for all lines\n3. Every charge from subscription spec has a corresponding line\n4. POB identifiers match the POB mapping exactly\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mint Mobile\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Mint Mobile wireless plan:\\n- 3 months at $15/month introductory rate\\n- 9 months at $20/month standard rate\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Wireless Plan - Intro Rate\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Mint Mobile - Wireless Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Wireless Plan - Intro Rate\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-03-31\",\n      \"Unit List Price\": 45,\n      \"Unit Sell Price\": 45,\n      \"Ext List Price\": 45,\n      \"Ext Sell Price\": 45,\n      \"SSP Price\": 45,\n      \"Ext SSP Price\": 45,\n      \"SSP Percent\": 20,\n      \"Ext Allocated Price\": 45,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 45,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Mint Mobile\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Wireless\",\n      \"Product Family\": \"Wireless Service\"\n    },\n    {\n      \"POB Name\": \"Wireless Plan - Standard Rate\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Mint Mobile - Wireless Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Wireless Plan - Standard Rate\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-04-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 180,\n      \"Unit Sell Price\": 180,\n      \"Ext List Price\": 180,\n      \"Ext Sell Price\": 180,\n      \"SSP Price\": 180,\n      \"Ext SSP Price\": 180,\n      \"SSP Percent\": 80,\n      \"Ext Allocated Price\": 180,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 180,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Mint Mobile\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Wireless\",\n      \"Product Family\": \"Wireless Service\"\n    }\n  ],\n  \"assumptions\": [\n    \"Intro Rate calculated as $15 * 3 months = $45 total contract value for that segment.\",\n    \"Standard Rate calculated as $20 * 9 months = $180 total contract value for that segment.\",\n    \"Allocation Eligible Flag is set to false as per user instructions, resulting in Allocated Price equaling Sell Price.\",\n    \"SSP is assumed to equal List Price for calculation of SSP Percentages.\",\n    \"Lead Line is assigned to the first chronological charge segment.\"\n  ],\n  \"open_questions\": [\n    \"Should the ramp segments be treated as a single POB with an averaged rate (Ramp Deal logic) despite the 'No Allocations' instruction?\",\n    \"Is there a specific Product Category/Family hierarchy preferred by Mint Mobile for these wireless plans?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mint-mobile-intro-pricing",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:35:07.101Z"
      }
    },
    {
      "id": "0676efba-ecff-496e-90d4-d03b1ddc2e36",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mint Mobile\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Mint Mobile wireless plan:\\n- 3 months at $15/month introductory rate\\n- 9 months at $20/month standard rate\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Intro Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Intro Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Intro Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Wireless Plan - Standard Rate\",\n      \"Rate Plan\": \"12-Month Ramp Plan\",\n      \"Product\": \"Wireless Service\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Introductory rate applies for the first 3 months of the 12-month term\",\n    \"Standard rate applies for the remaining 9 months of the 12-month term\",\n    \"Billing is set to monthly in advance on the 1st of the month\",\n    \"Service start and end dates align with calendar month boundaries\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 225,\n    \"schedule_total\": 225,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mint-mobile-intro-pricing",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:35:13.079Z"
      }
    },
    {
      "id": "709e3e51-8c56-4feb-91db-403e7bba23e8",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Sequential (1, 2, 3...)\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n1. Only include VC to the extent a significant reversal is NOT probable\n2. Use constrained estimate for allocation\n3. When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n- Create separate lines for each component\n- Each component has its own POB template\n- SSP comes from bundle config\n- Allocate across components\n- Total allocated = Original bundle price\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment date\n- Retrospective: Reallocate all lines\n- Prospective: Only new lines allocated, existing unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price)\n2. Revenue Start Date ≤ Revenue End Date for all lines\n3. Every charge from subscription spec has a corresponding line\n4. POB identifiers match the POB mapping exactly\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Acme Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Standard SaaS subscription:\\n- $100/month for enterprise software\\n- Monthly billing in advance\\n- 12-month commitment\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Software Subscription Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Enterprise Software Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2025\",\n      \"RPC Segment\": \"Software Subscription Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1200,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1200,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1200,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 1200,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"SaaS\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation is disabled per user request (is_allocations = false), so Ext Allocated Price equals Ext Sell Price.\",\n    \"The $100/month recurring fee is annualized to $1200 for the 12-month term.\",\n    \"SSP is set equal to the List Price ($1200) as no specific SSP data was provided.\",\n    \"The Sales Order Date is set to the Booking Date/Service Start Date of 01/01/2025.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "simple-recurring-12mo",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:36:23.325Z"
      }
    },
    {
      "id": "efc61cf5-9b5b-4661-85c9-2d71ba3643f5",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Acme Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Standard SaaS subscription:\\n- $100/month for enterprise software\\n- Monthly billing in advance\\n- 12-month commitment\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Software Subscription Fee\",\n      \"Rate Plan\": \"Enterprise Monthly Plan\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing periods are aligned with the first day of the calendar month.\",\n    \"Target TCV is calculated as 12 months of recurring fees at $100/month.\",\n    \"Payment Term is assumed to be Net 30 per Learned Correction BL-005.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "simple-recurring-12mo",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:36:32.430Z"
      }
    },
    {
      "id": "a11eb6b0-5f4a-4ff2-80db-c4417819d52e",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Sequential (1, 2, 3...)\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n1. Only include VC to the extent a significant reversal is NOT probable\n2. Use constrained estimate for allocation\n3. When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n- Create separate lines for each component\n- Each component has its own POB template\n- SSP comes from bundle config\n- Allocate across components\n- Total allocated = Original bundle price\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment date\n- Retrospective: Reallocate all lines\n- Prospective: Only new lines allocated, existing unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price)\n2. Revenue Start Date ≤ Revenue End Date for all lines\n3. Every charge from subscription spec has a corresponding line\n4. POB identifiers match the POB mapping exactly\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"TechGiant Inc\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Enterprise platform subscription with annual ramp:\\n- Year 1: $1000/month\\n- Year 2: $1200/month (20% increase)\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform Subscription - Year 1\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 24,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"TechGiant Inc - Enterprise Platform\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2025\",\n      \"RPC Segment\": \"Platform Subscription - Year 1\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Unit List Price\": 12000,\n      \"Unit Sell Price\": 12000,\n      \"Ext List Price\": 12000,\n      \"Ext Sell Price\": 12000,\n      \"SSP Price\": 12000,\n      \"Ext SSP Price\": 12000,\n      \"SSP Percent\": 45.45,\n      \"Ext Allocated Price\": 12000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 12000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"TechGiant Inc\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    },\n    {\n      \"POB Name\": \"Platform Subscription - Year 2\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 24,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"TechGiant Inc - Enterprise Platform\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2025\",\n      \"RPC Segment\": \"Platform Subscription - Year 2\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 14400,\n      \"Unit Sell Price\": 14400,\n      \"Ext List Price\": 14400,\n      \"Ext Sell Price\": 14400,\n      \"SSP Price\": 14400,\n      \"Ext SSP Price\": 14400,\n      \"SSP Percent\": 54.55,\n      \"Ext Allocated Price\": 14400,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 14400,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"TechGiant Inc\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocations were disabled per request, so Ext Allocated Price equals Ext Sell Price for each line.\",\n    \"Unit List and Sell prices represent the annual total for each ramp segment (12 months x monthly rate).\",\n    \"SSP is assumed to equal List Price as no specific SSP data was provided.\",\n    \"SSP Percent is calculated based on the relative weight of each line's SSP to the total contract SSP ($26,400).\"\n  ],\n  \"open_questions\": [\n    \"Confirm if the ramp should be treated as a single POB with a weighted average price for smoothed revenue recognition, as 'Allocations: No' currently results in revenue stepping up in Year 2.\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "annual-ramp-2year",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:38:23.989Z"
      }
    },
    {
      "id": "195fc950-aedf-46c3-8cb2-21cb99eb48a0",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"TechGiant Inc\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Enterprise platform subscription with annual ramp:\\n- Year 1: $1000/month\\n- Year 2: $1200/month (20% increase)\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Annual Ramp\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Service Start Date is 01/01/2025 and Service End Date is 12/31/2026.\",\n    \"Year 1 charge is active from 01/01/2025 to 12/31/2025.\",\n    \"Year 2 charge is active from 01/01/2026 to 12/31/2026.\",\n    \"Billing timing is 'In Advance', so the Invoice Date and Billing Date match the Period Start Date.\",\n    \"Billing period is 'Month', and the contract aligns with calendar months, so no proration is required.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 26400,\n    \"schedule_total\": 26400,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "annual-ramp-2year",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:38:29.430Z"
      }
    },
    {
      "id": "52d37234-767d-4933-977c-a51cc9f6452e",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Quarterly Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Quarterly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Professional services subscription:\\n- $3000/quarter ($1000/month equivalent)\\n- Quarterly billing in advance\\n- 12-month term\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription\",\n      \"Rate Plan\": \"Quarterly Retainer Plan\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription\",\n      \"Rate Plan\": \"Quarterly Retainer Plan\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription\",\n      \"Rate Plan\": \"Quarterly Retainer Plan\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription\",\n      \"Rate Plan\": \"Quarterly Retainer Plan\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing periods are aligned with the calendar quarter starting from the service start date.\",\n    \"Billing timing is set to In Advance, meaning the Invoice Date matches the Billing Period Start date.\",\n    \"The target TCV is calculated as the fixed recurring fee over the 12-month term ($3,000 * 4 quarters).\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 12000,\n    \"schedule_total\": 12000,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "quarterly-billing-annual",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:39:52.752Z"
      }
    },
    {
      "id": "41bc6c94-3272-4dee-addd-c9434299dc6f",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Bundle Customer\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Software bundle with multiple elements:\\n- Core Platform: $500/month (list price $600)\\n- Premium Support: $100/month (list price $150)\\n- Implementation Services: $2000 one-time (list price $2500)\\nTotal bundle: $8200/year\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Jan-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Feb-25\",\n      \"Amount\": 441.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Mar-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Apr-25\",\n      \"Amount\": 473.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"May-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Jun-25\",\n      \"Amount\": 473.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Jul-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Aug-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Sep-25\",\n      \"Amount\": 473.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Oct-25\",\n      \"Amount\": 489.21\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Nov-25\",\n      \"Amount\": 473.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Core Platform\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 5760,\n      \"Period\": \"Dec-25\",\n      \"Amount\": 489.2\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Jan-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Feb-25\",\n      \"Amount\": 110.47\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Mar-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Apr-25\",\n      \"Amount\": 118.36\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"May-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Jun-25\",\n      \"Amount\": 118.36\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Jul-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Aug-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Sep-25\",\n      \"Amount\": 118.36\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Oct-25\",\n      \"Amount\": 122.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Nov-25\",\n      \"Amount\": 118.36\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Premium Support\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-12-31\",\n      \"Ext Allocated Price\": 1440,\n      \"Period\": \"Dec-25\",\n      \"Amount\": 122.29\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Implementation Services\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2025-01-01\",\n      \"Revenue End Date\": \"2025-01-01\",\n      \"Ext Allocated Price\": 2000,\n      \"Period\": \"Jan-25\",\n      \"Amount\": 2000\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable POBs (BK-OT-RATABLE)\",\n    \"Reconciliation adjustment applied to Dec-25 to ensure sum of periods equals Ext Allocated Price\",\n    \"Implementation Services recognized 100% in Jan-25 as per BK-PIT-STARTDATE instructions\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "multi-element-allocation",
        "model": "gemini-3-flash-preview",
        "run_id": "a56ca45d-6bd5-43b5-a765-248eb581ed3c",
        "created_at": "2025-12-31T03:42:34.407Z"
      }
    },
    {
      "id": "0176fa40-3207-47a1-9663-75f28a457bef",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Adyen\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The Platform Access Fee represents a right to access the platform and is recognized linearly over the contract term.); Usage: POB=consumption release=as_used (Transaction fees are recognized as sub-merchants process payments through the platform.)\",\n  \"use_case_description\": \"A large SaaS marketplace platform signs a 24-month enterprise agreement for the Adyen for Platforms product. The contract includes a recurring Platform Access Fee of $5,000 per month and a discounted usage-based Processing Fee of $0.10 per transaction. The Platform Access Fee is billed monthly in advance, while usage is billed monthly in arrears. Revenue for the Platform Access Fee is recognized ratably over the 24-month term as an 'over-time' performance obligation. Processing revenue is recognized as consumption occurs. This case demonstrates a multi-year SaaS-style commitment combined with high-scale transaction volume.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 4602.74\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"May-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jan-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Feb-27\",\n      \"Amount\": 4602.74\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Mar-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Apr-27\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"May-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jun-27\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Jul-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Aug-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Sep-27\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Oct-27\",\n      \"Amount\": 5095.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Nov-27\",\n      \"Amount\": 4931.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 120000,\n      \"Period\": \"Dec-27\",\n      \"Amount\": 5095.87\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"May-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jan-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Feb-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Mar-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Apr-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"May-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jun-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jul-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Aug-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Sep-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Oct-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Nov-27\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Processing Fee\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Dec-27\",\n      \"Amount\": 0\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for Platform Access Fee (Line 1).\",\n    \"Processing Fee (Line 2) is event-driven; revenue is $0 until usage events are provided.\",\n    \"Total contract duration is 730 days (2026-01-01 to 2027-12-31).\"\n  ],\n  \"open_questions\": [\n    \"Can you provide the usage/consumption schedule for the Processing Fee (Line 2) so revenue can be recognized based on events?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-adyen-3",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T08:10:44.267Z"
      }
    },
    {
      "id": "2600592d-48c4-48bc-9299-9010097411b0",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mailchimp\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Essentials tier subscription recognized monthly.); Usage: POB=over_time release=ratable_over_term (SMS bundles are recurring and expire monthly, so they are recognized over the month.)\",\n  \"use_case_description\": \"A tech startup signs up for the Essentials Plan at $75 per month to manage 5,000 contacts. They require higher SMS volume and purchase 2,000 monthly credits for $40 per month. This is a pure self-service scenario with no professional services or onboarding sessions included. The customer is billed monthly on a recurring basis. Revenue for both the platform subscription and the SMS credit bundles is recognized ratably over each monthly service period. This scenario represents the high-velocity, low-complexity segment of the Mailchimp business model, focusing on automated recurring billing and simple revenue recognition.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Mailchimp - Essentials Startup Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Essentials Tier Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 75,\n      \"Unit Sell Price\": 75,\n      \"Ext List Price\": 900,\n      \"Ext Sell Price\": 900,\n      \"SSP Price\": 75,\n      \"Ext SSP Price\": 900,\n      \"SSP Percent\": 65.22,\n      \"Ext Allocated Price\": 900,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 900,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Mailchimp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Marketing Software\",\n      \"Product Family\": \"Essentials Plan\"\n    },\n    {\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Mailchimp - Essentials Startup Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"SMS Bundle - 2000 Credits\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 40,\n      \"Unit Sell Price\": 40,\n      \"Ext List Price\": 480,\n      \"Ext Sell Price\": 480,\n      \"SSP Price\": 40,\n      \"Ext SSP Price\": 480,\n      \"SSP Percent\": 34.78,\n      \"Ext Allocated Price\": 480,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 480,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Mailchimp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Communication Services\",\n      \"Product Family\": \"SMS Marketing\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation is disabled per input requirements; Ext Allocated Price matches Ext Sell Price.\",\n    \"Ordered Quantity is set to 12 to reflect the 12-month term at the monthly price point.\",\n    \"SSP Percent is calculated based on relative Ext Sell Price since is_allocations is false.\",\n    \"Revenue is recognized ratably over the 12-month term for both POBs.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-mailchimp-6",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T08:30:43.116Z"
      }
    },
    {
      "id": "fc320411-c557-4b8e-a629-df868ae27d63",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mailchimp\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Essentials tier subscription recognized monthly.); Usage: POB=over_time release=ratable_over_term (SMS bundles are recurring and expire monthly, so they are recognized over the month.)\",\n  \"use_case_description\": \"A tech startup signs up for the Essentials Plan at $75 per month to manage 5,000 contacts. They require higher SMS volume and purchase 2,000 monthly credits for $40 per month. This is a pure self-service scenario with no professional services or onboarding sessions included. The customer is billed monthly on a recurring basis. Revenue for both the platform subscription and the SMS credit bundles is recognized ratably over each monthly service period. This scenario represents the high-velocity, low-complexity segment of the Mailchimp business model, focusing on automated recurring billing and simple revenue recognition.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Essentials Tier Fee\",\n      \"Rate Plan\": \"Essentials Plan\",\n      \"Product\": \"Marketing Platform\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 75,\n      \"Amount\": 75,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"SMS Bundle - 2000 Credits\",\n      \"Rate Plan\": \"SMS Monthly Credits Bundle\",\n      \"Product\": \"SMS Marketing\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 40,\n      \"Amount\": 40,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is confirmed as InAdvance per the provided Contract Intel.\",\n    \"The SMS Monthly Credits Bundle is treated as a flat recurring charge as per the subscription spec, not a usage-based charge.\",\n    \"All service periods align with calendar month boundaries starting on the 1st of each month.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if any overage charges apply if SMS volume exceeds the 2,000 credit bundle.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 1380,\n    \"schedule_total\": 1380,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-mailchimp-6",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T08:31:06.550Z"
      }
    },
    {
      "id": "cb0d644d-2829-4720-934f-c7db0f618fbc",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mailchimp\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Essentials tier subscription recognized monthly.); Usage: POB=over_time release=ratable_over_term (SMS bundles are recurring and expire monthly, so they are recognized over the month.)\",\n  \"use_case_description\": \"A tech startup signs up for the Essentials Plan at $75 per month to manage 5,000 contacts. They require higher SMS volume and purchase 2,000 monthly credits for $40 per month. This is a pure self-service scenario with no professional services or onboarding sessions included. The customer is billed monthly on a recurring basis. Revenue for both the platform subscription and the SMS credit bundles is recognized ratably over each monthly service period. This scenario represents the high-velocity, low-complexity segment of the Mailchimp business model, focusing on automated recurring billing and simple revenue recognition.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 69.04\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 36.82\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 73.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 39.45\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"May-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"May-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 73.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 39.45\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 73.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 39.45\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 40.77\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 73.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 39.45\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Essentials Tier Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 900,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 76.44\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"SMS Bundle - 2000 Credits\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 40.76\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue for both POBs is recognized ratably over the 12-month contract term (2026-01-01 to 2026-12-31).\",\n    \"Daily rate calculation: Ext Allocated Price / 365 days.\",\n    \"Monthly amounts are calculated by multiplying the daily rate by the number of days in each month.\",\n    \"Rounding adjustments are applied to the final period (Dec-26) to ensure the total recognized amount equals the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-mailchimp-6",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T08:31:40.673Z"
      }
    },
    {
      "id": "3eac251d-5dc7-4b2d-8c0f-8fcac41a4675",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"PayPal\",\n  \"contract_start_date\": \"02/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Monthly platform fees for Payments Pro and Recurring Billing provide continuous access to the service.); Usage: POB=consumption release=as_used (Transaction fees are earned and recognized at the point each payment is successfully processed.)\",\n  \"use_case_description\": \"A scaling software merchant signs up for the SaaS Growth Subscription Plan to manage their customer billing and branded checkout. The plan includes the PayPal Payments Pro product and the Recurring Billing Service add-on for a combined recurring fee of $40 per month. Additionally, the merchant is charged a usage-based fee of 2.9% plus $0.30 for every digital payment transaction processed. The contract is set for a 12-month term with monthly billing. Revenue for the fixed monthly subscription fees is recognized ratably over the service period, while the transaction-based usage fees are recognized as consumption occurs each month.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Monthly Platform Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"PayPal - SaaS Growth Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"02/01/2026\",\n      \"RPC Segment\": \"Monthly Platform Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2027-01-31\",\n      \"Unit List Price\": 40,\n      \"Unit Sell Price\": 40,\n      \"Ext List Price\": 480,\n      \"Ext Sell Price\": 480,\n      \"SSP Price\": 40,\n      \"Ext SSP Price\": 480,\n      \"SSP Percent\": 99.937539,\n      \"Ext Allocated Price\": 480,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 480,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"PayPal\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Fintech Software\",\n      \"Product Family\": \"SaaS Growth Plan\"\n    },\n    {\n      \"POB Name\": \"Digital Payment Transaction Fee\",\n      \"POB Template\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Consumption\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"PayPal - SaaS Growth Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"02/01/2026\",\n      \"RPC Segment\": \"Digital Payment Transaction Fee\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2027-01-31\",\n      \"Unit List Price\": 0.3,\n      \"Unit Sell Price\": 0.3,\n      \"Ext List Price\": 0.3,\n      \"Ext Sell Price\": 0.3,\n      \"SSP Price\": 0.3,\n      \"Ext SSP Price\": 0.3,\n      \"SSP Percent\": 0.062461,\n      \"Ext Allocated Price\": 0.3,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.3,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"PayPal\",\n      \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"Product Category\": \"Payment Processing\",\n      \"Product Family\": \"Payments Pro\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Eligible Flag is set to false per user request, resulting in Ext Allocated Price equaling Ext Sell Price.\",\n    \"The 2.9% variable component of the transaction fee is treated as Variable Consideration or recognized upon usage upload; the $0.30 fixed per-transaction fee is used as the base unit price for the usage line.\",\n    \"The Monthly Platform Fee is an bundled price for Payments Pro and Recurring Billing, treated as a single POB per the subscription spec.\",\n    \"Ordered Quantity for the recurring fee represents the 12-month contract term.\"\n  ],\n  \"open_questions\": [\n    \"Should the 2.9% volume-based fee be estimated and included as a Variable Consideration (VC) line, or will it be processed solely via actual usage charges?\",\n    \"Is there a minimum monthly commitment for the transaction fees that should be reflected in the Ext Sell Price?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paypal-7",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T08:39:04.172Z"
      }
    },
    {
      "id": "2e38ba06-bb4a-42ad-a919-89af27221d53",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"PayPal\",\n  \"contract_start_date\": \"02/01/2026\",\n  \"terms_months\": 36,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Quarterly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The annual platform access fee is treated as a single POB recognized over the contract year.); Usage: POB=consumption release=as_used (Variable transaction fees are recognized in the period the processing services are rendered.)\",\n  \"use_case_description\": \"A global enterprise merchant enters into a 3-year strategic agreement for the Braintree Enterprise Platform. The contract includes a fixed annual platform access fee of $12,000, billed quarterly at $3,000, which covers core vaulting and advanced fraud protection tools. Usage is priced using a custom Interchange Plus (IC++) model, estimated at 2.89% plus $0.29 per transaction for demo purposes. The agreement covers multiple regions and currencies, though the primary billing is in USD. The platform fee is recognized ratably over the 36-month term, and the transaction usage is recognized as billed based on monthly volume.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Annual Platform Access Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Quarter\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 36,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"PayPal - Braintree Enterprise Platform\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"02/01/2026\",\n      \"RPC Segment\": \"Annual Platform Access Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2029-01-31\",\n      \"Unit List Price\": 3000,\n      \"Unit Sell Price\": 3000,\n      \"Ext List Price\": 36000,\n      \"Ext Sell Price\": 36000,\n      \"SSP Price\": 3000,\n      \"Ext SSP Price\": 36000,\n      \"SSP Percent\": 99.9991,\n      \"Ext Allocated Price\": 36000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 36000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"PayPal\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Payment Processing\",\n      \"Product Family\": \"Braintree Enterprise\"\n    },\n    {\n      \"POB Name\": \"Transaction Fee - Fixed\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 36,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"PayPal - Braintree Enterprise Platform\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"02/01/2026\",\n      \"RPC Segment\": \"Transaction Fee - Fixed\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2029-01-31\",\n      \"Unit List Price\": 0.29,\n      \"Unit Sell Price\": 0.29,\n      \"Ext List Price\": 0.29,\n      \"Ext Sell Price\": 0.29,\n      \"SSP Price\": 0.29,\n      \"Ext SSP Price\": 0.29,\n      \"SSP Percent\": 0.0008,\n      \"Ext Allocated Price\": 0.29,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.29,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"PayPal\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Payment Processing\",\n      \"Product Family\": \"Braintree Enterprise\"\n    },\n    {\n      \"POB Name\": \"Transaction Fee - Variable (IC++)\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 36,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"PayPal - Braintree Enterprise Platform\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"02/01/2026\",\n      \"RPC Segment\": \"Transaction Fee - Variable (IC++)\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2029-01-31\",\n      \"Unit List Price\": 0.0289,\n      \"Unit Sell Price\": 0.0289,\n      \"Ext List Price\": 0.0289,\n      \"Ext Sell Price\": 0.0289,\n      \"SSP Price\": 0.0289,\n      \"Ext SSP Price\": 0.0289,\n      \"SSP Percent\": 0.0001,\n      \"Ext Allocated Price\": 0.0289,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.0289,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"PayPal\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Payment Processing\",\n      \"Product Family\": \"Braintree Enterprise\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Eligible Flag is set to false as per user request, resulting in Ext Allocated Price equaling Ext Sell Price for all lines.\",\n    \"The Annual Platform Access Fee ($12,000/year) is modeled with a Unit Sell Price of $3,000 to align with the quarterly billing frequency over the 36-month term (12 quarters).\",\n    \"Usage fees are modeled with a placeholder quantity of 1 for initial order entry; revenue will be released upon actual billing events (PayGo).\",\n    \"The Variable IC++ fee of 2.89% is represented as a unit price of 0.0289 for calculation purposes.\"\n  ],\n  \"open_questions\": [\n    \"Are there any guaranteed minimum transaction volumes that should be used for the initial transaction price estimate instead of PayGo (placeholder) values?\",\n    \"Should the IC++ variable fee be constrained under ASC 606 Variable Consideration rules if transaction volumes are highly volatile?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paypal-9",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:02:32.328Z"
      }
    },
    {
      "id": "c7a8cd58-a24d-455f-b48a-c3d9625ce17d",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"PayPal\",\n  \"contract_start_date\": \"02/01/2026\",\n  \"terms_months\": 36,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Quarterly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The annual platform access fee is treated as a single POB recognized over the contract year.); Usage: POB=consumption release=as_used (Variable transaction fees are recognized in the period the processing services are rendered.)\",\n  \"use_case_description\": \"A global enterprise merchant enters into a 3-year strategic agreement for the Braintree Enterprise Platform. The contract includes a fixed annual platform access fee of $12,000, billed quarterly at $3,000, which covers core vaulting and advanced fraud protection tools. Usage is priced using a custom Interchange Plus (IC++) model, estimated at 2.89% plus $0.29 per transaction for demo purposes. The agreement covers multiple regions and currencies, though the primary billing is in USD. The platform fee is recognized ratably over the 36-month term, and the transaction usage is recognized as billed based on monthly volume.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"01/31/2027\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2027\",\n      \"Billing Date\": \"02/01/2027\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2027\",\n      \"Billing Period End\": \"04/30/2027\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2027\",\n      \"Billing Date\": \"05/01/2027\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2027\",\n      \"Billing Period End\": \"07/31/2027\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2027\",\n      \"Billing Date\": \"08/01/2027\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2027\",\n      \"Billing Period End\": \"10/31/2027\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2027\",\n      \"Billing Date\": \"11/01/2027\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2027\",\n      \"Billing Period End\": \"01/31/2028\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2028\",\n      \"Billing Date\": \"02/01/2028\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2028\",\n      \"Billing Period End\": \"04/30/2028\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2028\",\n      \"Billing Date\": \"05/01/2028\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2028\",\n      \"Billing Period End\": \"07/31/2028\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2028\",\n      \"Billing Date\": \"08/01/2028\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2028\",\n      \"Billing Period End\": \"10/31/2028\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2028\",\n      \"Billing Date\": \"11/01/2028\",\n      \"Charge Name\": \"Annual Platform Access Fee\",\n      \"Rate Plan\": \"Platform Access & Processing\",\n      \"Product\": \"Braintree Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2028\",\n      \"Billing Period End\": \"01/31/2029\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Annual Platform Access Fee ($12,000/year) is billed quarterly in advance at $3,000 per period.\",\n    \"Total Contract Value (TCV) target reflects only the fixed platform fees ($36,000 over 3 years).\",\n    \"Usage charges (Fixed $0.29/txn and Variable 2.89%) are billed monthly in arrears.\",\n    \"Usage billing is excluded from the schedule amounts and TCV total as no volume estimates were provided.\"\n  ],\n  \"open_questions\": [\n    \"Please provide estimated monthly transaction volume and transaction count to calculate the Usage TCV.\",\n    \"Confirm if any regional currency conversions apply to the USD billing for the multi-region agreement.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 36000,\n    \"schedule_total\": 36000,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paypal-9",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:03:00.998Z"
      }
    },
    {
      "id": "7c922459-9bbb-44af-9e03-e4061a074483",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Intuit QuickBooks Online\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard SaaS subscription for QBO Plus and Payroll Core base fees recognized monthly.); Usage: POB=consumption release=as_used (Per-employee payroll fees recognized based on the actual headcount processed each month.)\",\n  \"use_case_description\": \"A small business customer signs up for the 'Small Business Growth Bundle' consisting of QuickBooks Online Plus and QuickBooks Online Payroll Core. The QBO Plus subscription is $90/month, and Payroll Core is $50/month plus a recurring usage charge of $6.50 per employee per month. To incentivize the signup, a 50% discount is applied to the base subscription fees for the first 3 months of the 12-month term. The base subscriptions are recognized ratably over time, while the per-employee usage fees are recognized as incurred each month. This scenario tests Zuora's ability to handle bundled recurring charges with time-limited discounts and monthly usage-based components.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"QBO Plus - Promo\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 3,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Small Business Growth Bundle\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QBO Plus - Promo\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-03-31\",\n      \"Unit List Price\": 90,\n      \"Unit Sell Price\": 45,\n      \"Ext List Price\": 270,\n      \"Ext Sell Price\": 135,\n      \"SSP Price\": 90,\n      \"Ext SSP Price\": 270,\n      \"SSP Percent\": 16.01,\n      \"Ext Allocated Price\": 236.38,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 236.38,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"QuickBooks Online\"\n    },\n    {\n      \"POB Name\": \"QBO Plus - Standard\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 9,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Small Business Growth Bundle\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QBO Plus - Standard\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-04-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 90,\n      \"Unit Sell Price\": 90,\n      \"Ext List Price\": 810,\n      \"Ext Sell Price\": 810,\n      \"SSP Price\": 90,\n      \"Ext SSP Price\": 810,\n      \"SSP Percent\": 48.03,\n      \"Ext Allocated Price\": 709.15,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 709.15,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"QuickBooks Online\"\n    },\n    {\n      \"POB Name\": \"Payroll Core - Promo\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 3,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Small Business Growth Bundle\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Payroll Core - Promo\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-03-31\",\n      \"Unit List Price\": 50,\n      \"Unit Sell Price\": 25,\n      \"Ext List Price\": 150,\n      \"Ext Sell Price\": 75,\n      \"SSP Price\": 50,\n      \"Ext SSP Price\": 150,\n      \"SSP Percent\": 8.89,\n      \"Ext Allocated Price\": 131.32,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 131.32,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"QuickBooks Payroll\"\n    },\n    {\n      \"POB Name\": \"Payroll Core - Standard\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 9,\n      \"Line Item Num\": 4,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Small Business Growth Bundle\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Payroll Core - Standard\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-04-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 50,\n      \"Unit Sell Price\": 50,\n      \"Ext List Price\": 450,\n      \"Ext Sell Price\": 450,\n      \"SSP Price\": 50,\n      \"Ext SSP Price\": 450,\n      \"SSP Percent\": 26.68,\n      \"Ext Allocated Price\": 393.97,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 393.97,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"QuickBooks Payroll\"\n    },\n    {\n      \"POB Name\": \"Payroll Core - Per Employee Usage\",\n      \"POB Template\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Consumption\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 5,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Small Business Growth Bundle\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Payroll Core - Per Employee Usage\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 6.5,\n      \"Unit Sell Price\": 6.5,\n      \"Ext List Price\": 6.5,\n      \"Ext Sell Price\": 6.5,\n      \"SSP Price\": 6.5,\n      \"Ext SSP Price\": 6.5,\n      \"SSP Percent\": 0.39,\n      \"Ext Allocated Price\": 5.68,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 5.68,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"Product Category\": \"Usage\",\n      \"Product Family\": \"QuickBooks Payroll\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation eligible for all lines as per 'Allocations: Yes' instruction.\",\n    \"SSP equals List Price for all lines.\",\n    \"Total Transaction Price (Ext Sell Price) is $1,476.50.\",\n    \"Usage line quantity is set to 1 for contract initialization; actual revenue will be adjusted upon consumption.\",\n    \"Promo segments (Months 1-3) and Standard segments (Months 4-12) are split into separate line items to handle step-down pricing.\",\n    \"Relative SSP allocation applied across all 5 contract lines.\"\n  ],\n  \"open_questions\": [\n    \"Should the usage line be excluded from the initial allocation until consumption is known?\",\n    \"Is the usage list price of $6.50 intended to be used for the SSP calculation of the entire bundle?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-intuit-quickbooks-online-10",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:12:22.133Z"
      }
    },
    {
      "id": "3222dae9-5d23-426f-83a8-73cc6097d8ac",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Intuit QuickBooks Online\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use Sell Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Advanced, Elite Payroll, and Live Bookkeeping monthly fees recognized over the term.); Services: POB=point_in_time release=at_go_live (Cleanup fee recognized when the initial bookkeeping cleanup is finalized.); Usage: POB=consumption release=as_used (Elite Payroll per-employee fees recognized as consumed.)\",\n  \"use_case_description\": \"A mid-market company opts for the 'Hands-Off Enterprise Plan' which includes QuickBooks Online Advanced ($200/month), QuickBooks Online Payroll Elite ($125/month + $12/employee), and QuickBooks Live Bookkeeping ($300/month). Because their existing books are disorganized, they are charged a one-time 'Cleanup' fee of $800. The cleanup fee is a distinct performance obligation recognized upon completion of the historical data cleanup. The recurring subscriptions are billed monthly and recognized ratably. This use case highlights the mix of high-tier SaaS, usage-based payroll, and a one-time professional service fee within a single contract.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"QuickBooks Online Advanced\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Hands-Off Enterprise Plan\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QuickBooks Online Advanced\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 200,\n      \"Unit Sell Price\": 200,\n      \"Ext List Price\": 2400,\n      \"Ext Sell Price\": 2400,\n      \"SSP Price\": 200,\n      \"Ext SSP Price\": 2400,\n      \"SSP Percent\": 28.42,\n      \"Ext Allocated Price\": 2400,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 2400,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"SaaS\",\n      \"Product Family\": \"QuickBooks Online\"\n    },\n    {\n      \"POB Name\": \"QuickBooks Online Payroll Elite - Base\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Hands-Off Enterprise Plan\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QuickBooks Online Payroll Elite - Base\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 125,\n      \"Unit Sell Price\": 125,\n      \"Ext List Price\": 1500,\n      \"Ext Sell Price\": 1500,\n      \"SSP Price\": 125,\n      \"Ext SSP Price\": 1500,\n      \"SSP Percent\": 17.76,\n      \"Ext Allocated Price\": 1500,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1500,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"SaaS\",\n      \"Product Family\": \"QuickBooks Payroll\"\n    },\n    {\n      \"POB Name\": \"QuickBooks Online Payroll Elite - Per Employee\",\n      \"POB Template\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Consumption\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Hands-Off Enterprise Plan\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QuickBooks Online Payroll Elite - Per Employee\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 12,\n      \"Unit Sell Price\": 12,\n      \"Ext List Price\": 144,\n      \"Ext Sell Price\": 144,\n      \"SSP Price\": 12,\n      \"Ext SSP Price\": 144,\n      \"SSP Percent\": 1.71,\n      \"Ext Allocated Price\": 144,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 144,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"Product Category\": \"SaaS\",\n      \"Product Family\": \"QuickBooks Payroll\"\n    },\n    {\n      \"POB Name\": \"QuickBooks Live Bookkeeping\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 4,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Hands-Off Enterprise Plan\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"QuickBooks Live Bookkeeping\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 300,\n      \"Unit Sell Price\": 300,\n      \"Ext List Price\": 3600,\n      \"Ext Sell Price\": 3600,\n      \"SSP Price\": 300,\n      \"Ext SSP Price\": 3600,\n      \"SSP Percent\": 42.63,\n      \"Ext Allocated Price\": 3600,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 3600,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Service\",\n      \"Product Family\": \"QuickBooks Services\"\n    },\n    {\n      \"POB Name\": \"Cleanup Fee\",\n      \"POB Template\": \"EVT-PIT-COMPLETION\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Completion\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 5,\n      \"Subscription Name\": \"Intuit QuickBooks Online - Hands-Off Enterprise Plan\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Cleanup Fee\",\n      \"RPC Type\": \"OneTime\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-01\",\n      \"Unit List Price\": 800,\n      \"Unit Sell Price\": 800,\n      \"Ext List Price\": 800,\n      \"Ext Sell Price\": 800,\n      \"SSP Price\": 800,\n      \"Ext SSP Price\": 800,\n      \"SSP Percent\": 9.48,\n      \"Ext Allocated Price\": 800,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 800,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Intuit QuickBooks Online\",\n      \"POB IDENTIFIER\": \"EVT-PIT-COMPLETION\",\n      \"Product Category\": \"Service\",\n      \"Product Family\": \"Professional Services\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Method 'Use Sell Price' results in Ext Allocated Price equaling Ext Sell Price for all lines because SSP is set to match Sell Price.\",\n    \"Ordered Quantity for recurring lines (Advanced, Payroll Base, Live Bookkeeping) is set to 12 to represent the full contract term of 12 months.\",\n    \"The usage-based charge (Payroll Elite - Per Employee) is included in the initial allocation using a placeholder quantity of 1 employee per month (total 12 units) to establish a baseline transaction price.\",\n    \"The Cleanup Fee is treated as a Point In Time (PIT) performance obligation with revenue recognition occurring on the start date as a placeholder for the completion event.\"\n  ],\n  \"open_questions\": [\n    \"Should the usage-based line (Per Employee) be excluded from initial allocation and only recognized as incurred, or is the estimate provided for allocation purposes?\",\n    \"Confirm if the Cleanup Fee completion date is expected to be the same as the contract start date or if a separate event will trigger recognition later.\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-intuit-quickbooks-online-11",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:22:46.699Z"
      }
    },
    {
      "id": "ced08643-85ac-4757-9ab9-8b294de4a148",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Intuit QuickBooks Online\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Simple Start subscription recognized monthly.); Usage: POB=consumption release=as_used (Payment processing fees recognized at the time of transaction.)\",\n  \"use_case_description\": \"A sole proprietor signs up for the 'Freelancer Bundle' featuring QuickBooks Online Simple Start at $38/month. This bundle automatically enables QuickBooks Payments with no monthly base fee, but with a usage-based charge model of 2.99% per credit card transaction and 1% for ACH. Revenue for the subscription is recognized monthly. Revenue for the payments component is recognized as transactions occur, typically as a deduction from the payout. This scenario demonstrates Zuora's ability to manage a subscription alongside high-volume, low-value transactional usage charges where the 'price' is a percentage of the transaction volume.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"QuickBooks Online Simple Start Subscription\",\n      \"Rate Plan\": \"QuickBooks Online/Simple Start - Freelancer Bundle\",\n      \"Product\": \"QuickBooks Online\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 38,\n      \"Amount\": 38,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The subscription starts on the 1st of the month; therefore, billing is aligned to the first of each calendar month.\",\n    \"Fixed recurring charges are billed InAdvance.\",\n    \"Target TCV is calculated based on fixed recurring fees only ($38 * 12 months).\",\n    \"Usage-based charges for Credit Card (2.99%) and ACH (1%) processing are billed InArrears but are omitted from the schedule as no transaction volume records were provided.\"\n  ],\n  \"open_questions\": [\n    \"Please provide estimated or actual transaction volumes for Credit Card and ACH payments to calculate the variable portion of the billing schedule.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 456,\n    \"schedule_total\": 456,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-intuit-quickbooks-online-12",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:27:31.117Z"
      }
    },
    {
      "id": "7774aa4d-4526-49a6-be88-c875e611ee28",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Square\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Square Plus software provides continuous access to retail features.); Hardware: POB=point_in_time release=at_delivery (Square Terminal ownership transfers at delivery.); Usage: POB=consumption release=as_billed (Processing fees are earned at the moment of transaction.)\",\n  \"use_case_description\": \"A growing retail customer with three physical locations subscribes to the Square Plus plan at $49 per location per month. To support these locations, they purchase three Square Terminals as a one-time hardware cost of $299 each ($897 total). The software subscription revenue is recognized ratably over the 12-month term, while the hardware revenue is recognized as a point-in-time event upon delivery. Payment processing is enabled at the standard Plus rate of 2.5% plus $0.15 per transaction, with revenue recognized as usage occurs. This scenario demonstrates the management of recurring SaaS fees alongside one-time physical goods and high-volume usage processing.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Square Terminal - Hardware Fee\",\n      \"Rate Plan\": \"Square Terminal Purchase\",\n      \"Product\": \"Square Hardware\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/01/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 299,\n      \"Amount\": 897,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Square Plus - Software Subscription\",\n      \"Rate Plan\": \"Square Plus Retail\",\n      \"Product\": \"Square Plus\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 3,\n      \"Unit Price\": 49,\n      \"Amount\": 147,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Hardware is billed as a one-time fee on the contract effective date\",\n    \"Software subscription is billed monthly in advance\",\n    \"Usage-based processing fees are billed monthly in arrears but are excluded from totals as no volume was provided\",\n    \"The 12-month term is calculated as 12 full calendar months\"\n  ],\n  \"open_questions\": [\n    \"Please provide estimated monthly transaction volume and average transaction value to calculate the usage-based Processing Fees\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 2661,\n    \"schedule_total\": 2661,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-square-block-inc-13",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:41:32.828Z"
      }
    },
    {
      "id": "7538b093-cc35-498f-a0e6-73435d64494c",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Square\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Includes Premium POS and Payroll base fees.); Usage: POB=consumption release=as_used (Payroll employee fees recognized as active employees are processed.); Usage: POB=consumption release=as_billed (Negotiated payment processing fees recognized on transaction.)\",\n  \"use_case_description\": \"A large restaurant group signs a contract for 5 locations on the Square Premium plan at $149 per location per month. They also implement Square Payroll, which carries a $35 monthly base fee and a variable $6 per-employee fee for an estimated 40 employees. Due to their high volume, they have negotiated a custom payment processing rate of 2.3% plus $0.10 per transaction. Revenue for the POS software and the Payroll base fee is recognized ratably over the 12-month term. The variable payroll employee fees and the payment processing revenue are recognized monthly based on actual consumption. This case tests Zuora's ability to handle complex mixed-model billing with both flat recurring and volume-based usage fees.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Square Premium POS Subscription\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 5,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Square - Restaurant Group Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Square Premium POS Subscription\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 149,\n      \"Unit Sell Price\": 149,\n      \"Ext List Price\": 745,\n      \"Ext Sell Price\": 745,\n      \"SSP Price\": 149,\n      \"Ext SSP Price\": 745,\n      \"SSP Percent\": 73.0305,\n      \"Ext Allocated Price\": 745,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 745,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Square\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Point of Sale\"\n    },\n    {\n      \"POB Name\": \"Payroll Base Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Square - Restaurant Group Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Payroll Base Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 35,\n      \"Unit Sell Price\": 35,\n      \"Ext List Price\": 35,\n      \"Ext Sell Price\": 35,\n      \"SSP Price\": 35,\n      \"Ext SSP Price\": 35,\n      \"SSP Percent\": 3.431,\n      \"Ext Allocated Price\": 35,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 35,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Square\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Payroll\"\n    },\n    {\n      \"POB Name\": \"Payroll Employee Fee\",\n      \"POB Template\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Consumption\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 40,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"Square - Restaurant Group Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Payroll Employee Fee\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 6,\n      \"Unit Sell Price\": 6,\n      \"Ext List Price\": 240,\n      \"Ext Sell Price\": 240,\n      \"SSP Price\": 6,\n      \"Ext SSP Price\": 240,\n      \"SSP Percent\": 23.5265,\n      \"Ext Allocated Price\": 240,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 240,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Square\",\n      \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-USAGE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Payroll\"\n    },\n    {\n      \"POB Name\": \"Processing Fee - Fixed\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 4,\n      \"Subscription Name\": \"Square - Restaurant Group Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Processing Fee - Fixed\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.1,\n      \"Unit Sell Price\": 0.1,\n      \"Ext List Price\": 0.1,\n      \"Ext Sell Price\": 0.1,\n      \"SSP Price\": 0.1,\n      \"Ext SSP Price\": 0.1,\n      \"SSP Percent\": 0.0098,\n      \"Ext Allocated Price\": 0.1,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.1,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Square\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction\",\n      \"Product Family\": \"Payments\"\n    },\n    {\n      \"POB Name\": \"Processing Fee - Variable\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 5,\n      \"Subscription Name\": \"Square - Restaurant Group Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Processing Fee - Variable\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.023,\n      \"Unit Sell Price\": 0.023,\n      \"Ext List Price\": 0.023,\n      \"Ext Sell Price\": 0.023,\n      \"SSP Price\": 0.023,\n      \"Ext SSP Price\": 0.023,\n      \"SSP Percent\": 0.0022,\n      \"Ext Allocated Price\": 0.023,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.023,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Square\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction\",\n      \"Product Family\": \"Payments\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Eligible Flag is set to false as per user request 'Allocations: No', resulting in Ext Allocated Price matching Ext Sell Price.\",\n    \"Extended prices for all lines follow rule CO-003: Unit Sell Price * Ordered Qty (not multiplied by term months).\",\n    \"Payroll Employee Fee is estimated at 40 employees as provided in the case notes.\",\n    \"Processing Fee - Variable is modeled as a unit rate of 0.023 (representing 2.3%) with a quantity of 1 to represent the contract price structure.\",\n    \"Usage revenue end dates are set to the contract term end date (2026-12-31) for initial contract representation.\",\n    \"SSP values are set equal to Unit Sell Prices as no separate SSP data was provided and allocations are disabled.\"\n  ],\n  \"open_questions\": [\n    \"Are there specific estimated monthly transaction counts for the processing fees to provide a more accurate Total Transaction Price (TTP)?\",\n    \"Should the Processing Fee - Variable be linked to an estimated transaction volume field in the subscription spec for more precise revenue forecasting?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-square-block-inc-14",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:51:33.899Z"
      }
    },
    {
      "id": "f387f4ed-1c46-4874-914b-541b26b51faf",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Square\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Includes Premium POS and Payroll base fees.); Usage: POB=consumption release=as_used (Payroll employee fees recognized as active employees are processed.); Usage: POB=consumption release=as_billed (Negotiated payment processing fees recognized on transaction.)\",\n  \"use_case_description\": \"A large restaurant group signs a contract for 5 locations on the Square Premium plan at $149 per location per month. They also implement Square Payroll, which carries a $35 monthly base fee and a variable $6 per-employee fee for an estimated 40 employees. Due to their high volume, they have negotiated a custom payment processing rate of 2.3% plus $0.10 per transaction. Revenue for the POS software and the Payroll base fee is recognized ratably over the 12-month term. The variable payroll employee fees and the payment processing revenue are recognized monthly based on actual consumption. This case tests Zuora's ability to handle complex mixed-model billing with both flat recurring and volume-based usage fees.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Square Premium POS Subscription\",\n      \"Rate Plan\": \"Square Premium\",\n      \"Product\": \"Square POS\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 5,\n      \"Unit Price\": 149,\n      \"Amount\": 745,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Payroll Base Fee\",\n      \"Rate Plan\": \"Square Payroll Standard\",\n      \"Product\": \"Square Payroll\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 35,\n      \"Amount\": 35,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Recurring charges (POS and Payroll Base) are billed monthly in advance starting on the first of the month.\",\n    \"Usage charges (Payroll Employee Fee and Processing Fees) are billed monthly in arrears.\",\n    \"Per Learned Correction BL-009, usage-based lines are excluded from the billing schedule as actual consumption data is not provided.\",\n    \"The target TCV represents the fixed committed portion of the contract only.\"\n  ],\n  \"open_questions\": [\n    \"Please provide the monthly employee count to calculate the Payroll Employee Fee ($6/employee).\",\n    \"Please provide the transaction volume (count and total USD amount) to calculate the Custom Processing Fees (2.3% + $0.10).\",\n    \"Confirm if the estimated 40 employees should be used for a minimum commitment billing or if billing is strictly on actuals.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 9360,\n    \"schedule_total\": 9360,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-square-block-inc-14",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:52:01.192Z"
      }
    },
    {
      "id": "a4dfeeaf-d8b2-41dc-a481-facbe662baa8",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Square\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Hardware: POB=point_in_time release=at_delivery (Allocated hardware value recognized at delivery.); Subscription: POB=over_time release=ratable_over_term (Allocated software value recognized over 24 months.)\",\n  \"use_case_description\": \"An enterprise merchant signs a 24-month agreement for 10 Square Registers bundled with 10 Square Premium software licenses. The Square Registers have a list price of $799 each, and the software is $149 per location per month. As part of a promotion, Square provides a 15% discount across the total contract value. Because this bundle involves a significant hardware component (point-in-time) and a recurring software component (over-time) with a shared discount, revenue allocation is required. This ensures the hardware revenue is correctly valued at its standalone selling price (SSP) and recognized upon delivery, while the software portion is allocated and recognized over the 24-month term. This scenario exercises Zuora Revenue's allocation engine.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Square Register - Hardware\",\n      \"Rate Plan\": \"Square Register Bundle\",\n      \"Product\": \"Square Hardware\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/01/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 679.15,\n      \"Amount\": 6791.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2027\",\n      \"Billing Date\": \"01/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"01/01/2027\",\n      \"Billing Period End\": \"01/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2027\",\n      \"Billing Date\": \"02/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"02/01/2027\",\n      \"Billing Period End\": \"02/28/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2027\",\n      \"Billing Date\": \"03/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"03/01/2027\",\n      \"Billing Period End\": \"03/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2027\",\n      \"Billing Date\": \"04/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"04/01/2027\",\n      \"Billing Period End\": \"04/30/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2027\",\n      \"Billing Date\": \"05/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"05/01/2027\",\n      \"Billing Period End\": \"05/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2027\",\n      \"Billing Date\": \"06/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"06/01/2027\",\n      \"Billing Period End\": \"06/30/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2027\",\n      \"Billing Date\": \"07/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"07/01/2027\",\n      \"Billing Period End\": \"07/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2027\",\n      \"Billing Date\": \"08/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"08/01/2027\",\n      \"Billing Period End\": \"08/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2027\",\n      \"Billing Date\": \"09/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"09/01/2027\",\n      \"Billing Period End\": \"09/30/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2027\",\n      \"Billing Date\": \"10/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"10/01/2027\",\n      \"Billing Period End\": \"10/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2027\",\n      \"Billing Date\": \"11/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"11/01/2027\",\n      \"Billing Period End\": \"11/30/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2027\",\n      \"Billing Date\": \"12/01/2027\",\n      \"Charge Name\": \"Square Premium - Software Subscription\",\n      \"Rate Plan\": \"Square Premium License\",\n      \"Product\": \"Square Software\",\n      \"Billing Period Start\": \"12/01/2027\",\n      \"Billing Period End\": \"12/31/2027\",\n      \"Quantity\": 10,\n      \"Unit Price\": 126.65,\n      \"Amount\": 1266.5,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Discount of 15% is applied directly to the unit price of each charge to determine Net TCV.\",\n    \"Hardware is delivered and billed on the contract effective date (01/01/2026).\",\n    \"Software is billed monthly in advance starting on the contract effective date.\",\n    \"Revenue allocation logic (SSP vs Transaction Price) is handled in Zuora Revenue; this schedule reflects the billing transaction prices.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 37187.5,\n    \"schedule_total\": 37187.5,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-square-block-inc-15",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:58:16.881Z"
      }
    },
    {
      "id": "3b69bfab-89cb-46f2-92d3-c90aafe48543",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Square\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Hardware: POB=point_in_time release=at_delivery (Allocated hardware value recognized at delivery.); Subscription: POB=over_time release=ratable_over_term (Allocated software value recognized over 24 months.)\",\n  \"use_case_description\": \"An enterprise merchant signs a 24-month agreement for 10 Square Registers bundled with 10 Square Premium software licenses. The Square Registers have a list price of $799 each, and the software is $149 per location per month. As part of a promotion, Square provides a 15% discount across the total contract value. Because this bundle involves a significant hardware component (point-in-time) and a recurring software component (over-time) with a shared discount, revenue allocation is required. This ensures the hardware revenue is correctly valued at its standalone selling price (SSP) and recognized upon delivery, while the software portion is allocated and recognized over the 24-month term. This scenario exercises Zuora Revenue's allocation engine.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Square Register - Hardware\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-01\",\n      \"Ext Allocated Price\": 6791.5,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6791.5\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 48.58\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"May-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jan-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Feb-27\",\n      \"Amount\": 48.58\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Mar-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Apr-27\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"May-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jun-27\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Jul-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Aug-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Sep-27\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Oct-27\",\n      \"Amount\": 53.78\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Nov-27\",\n      \"Amount\": 52.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Square Premium - Software Subscription\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2027-12-31\",\n      \"Ext Allocated Price\": 1266.5,\n      \"Period\": \"Dec-27\",\n      \"Amount\": 53.8\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable software subscription\",\n    \"Point-in-time recognition for hardware based on start date\",\n    \"Rounding catch-up of $0.02 applied to Dec-27 to align with Ext Allocated Price\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-square-block-inc-15",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T09:59:13.971Z"
      }
    },
    {
      "id": "5f56baa0-5fa9-4ed3-b146-182b58e4efd2",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Stripe\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Hardware: POB=point_in_time release=at_delivery (Terminal readers are distinct physical goods with revenue recognized upon transfer of control (shipment).); Usage: POB=point_in_time release=as_billed (Payment processing fees for both Online and Terminal are recognized as the individual transactions are completed.)\",\n  \"use_case_description\": \"Urban Goods is expanding their online presence into physical retail and requires Stripe Terminal hardware and processing. They are purchasing 15 Stripe Terminal M2 readers at a one-time cost of $249 each. In addition to the hardware, they will pay a usage-based fee of 2.7% + $0.05 per in-person transaction. Their existing online business will continue to use Stripe Payments at 2.9% + $0.30 per transaction. Revenue for the hardware readers is recognized at the point of delivery (shipment), while all transaction processing fees are recognized at the point in time the transaction occurs.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Terminal M2 Reader - Purchase\",\n      \"POB Template\": \"EVT-PIT-CONSUMP-DELIVERY\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Consumption\",\n      \"Billing Period\": \"One-Time\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 15,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Stripe - Urban Goods Terminal & Payments\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Terminal M2 Reader - Purchase\",\n      \"RPC Type\": \"OneTime\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-01\",\n      \"Unit List Price\": 249,\n      \"Unit Sell Price\": 249,\n      \"Ext List Price\": 3735,\n      \"Ext Sell Price\": 3735,\n      \"SSP Price\": 249,\n      \"Ext SSP Price\": 3735,\n      \"SSP Percent\": 99.989131,\n      \"Ext Allocated Price\": 3735,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 3735,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Urban Goods\",\n      \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-DELIVERY\",\n      \"Product Category\": \"Hardware\",\n      \"Product Family\": \"Stripe Terminal\"\n    },\n    {\n      \"POB Name\": \"Terminal Transaction Fee (Fixed)\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Stripe - Urban Goods Terminal & Payments\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Terminal Transaction Fee (Fixed)\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.05,\n      \"Unit Sell Price\": 0.05,\n      \"Ext List Price\": 0.05,\n      \"Ext Sell Price\": 0.05,\n      \"SSP Price\": 0.05,\n      \"Ext SSP Price\": 0.05,\n      \"SSP Percent\": 0.001339,\n      \"Ext Allocated Price\": 0.05,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.05,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Urban Goods\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction Fee\",\n      \"Product Family\": \"Stripe Terminal\"\n    },\n    {\n      \"POB Name\": \"Terminal Processing Fee (Variable)\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"Stripe - Urban Goods Terminal & Payments\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Terminal Processing Fee (Variable)\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.027,\n      \"Unit Sell Price\": 0.027,\n      \"Ext List Price\": 0.027,\n      \"Ext Sell Price\": 0.027,\n      \"SSP Price\": 0.027,\n      \"Ext SSP Price\": 0.027,\n      \"SSP Percent\": 0.000723,\n      \"Ext Allocated Price\": 0.027,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.027,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Urban Goods\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction Fee\",\n      \"Product Family\": \"Stripe Terminal\"\n    },\n    {\n      \"POB Name\": \"Online Transaction Fee (Fixed)\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 4,\n      \"Subscription Name\": \"Stripe - Urban Goods Terminal & Payments\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Online Transaction Fee (Fixed)\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.3,\n      \"Unit Sell Price\": 0.3,\n      \"Ext List Price\": 0.3,\n      \"Ext Sell Price\": 0.3,\n      \"SSP Price\": 0.3,\n      \"Ext SSP Price\": 0.3,\n      \"SSP Percent\": 0.008031,\n      \"Ext Allocated Price\": 0.3,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.3,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Urban Goods\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction Fee\",\n      \"Product Family\": \"Stripe Payments\"\n    },\n    {\n      \"POB Name\": \"Online Processing Fee (Variable)\",\n      \"POB Template\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"POB Satisfied\": \"Point In Time\",\n      \"Release Event\": \"Upon Billing (Billed Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InArrears\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 5,\n      \"Subscription Name\": \"Stripe - Urban Goods Terminal & Payments\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Online Processing Fee (Variable)\",\n      \"RPC Type\": \"Usage\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 0.029,\n      \"Unit Sell Price\": 0.029,\n      \"Ext List Price\": 0.029,\n      \"Ext Sell Price\": 0.029,\n      \"SSP Price\": 0.029,\n      \"Ext SSP Price\": 0.029,\n      \"SSP Percent\": 0.000776,\n      \"Ext Allocated Price\": 0.029,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 0.029,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Urban Goods\",\n      \"POB IDENTIFIER\": \"BL-PIT-CONSUMP-PAYGO\",\n      \"Product Category\": \"Transaction Fee\",\n      \"Product Family\": \"Stripe Payments\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocations set to false per user request; Ext Allocated Price equals Ext Sell Price for all lines.\",\n    \"Usage quantities are initialized at 1 for the contract order line until consumption is uploaded.\",\n    \"Variable fees (2.7% and 2.9%) are represented as decimal unit prices (0.027 and 0.029).\",\n    \"SSP Percent is calculated relative to total Ext Sell Price to ensure 100% total distribution despite no allocation.\",\n    \"One-time hardware purchase revenue end date matches start date for point-in-time recognition.\"\n  ],\n  \"open_questions\": [\n    \"Are there estimated transaction volumes for the usage charges to facilitate initial revenue forecasting?\",\n    \"Should the variable processing fees be grouped into a single POB with the fixed transaction fees, or maintained as separate lines?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-stripe-17",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T10:12:17.838Z"
      }
    },
    {
      "id": "e7746f10-3d40-426f-bcf3-ca6237e3501c",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Xero\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The discounted monthly fee is part of a single POB for the accounting software access.)\",\n  \"use_case_description\": \"A sole trader starts with the Xero Early Plan, priced at $15.00 per month. To support new business growth, Xero provides a 'New Starter' promotion consisting of a 90% discount for the first 6 months of the 12-month term. This plan has strict limits (e.g., 20 invoices per month), and any invoices exceeding this limit would trigger a plan upgrade or overage fee (though for this scenario, we focus on the base fee and discount). Billing is monthly. Revenue is recognized ratably over the 12-month contract, with the total contract value (including the deep discount) spread across the performance obligation period to reflect the 12-month commitment.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Early Plan - Promo Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.5,\n      \"Amount\": 1.5,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Early Plan - Standard Period\",\n      \"Rate Plan\": \"Xero Early Plan - Monthly\",\n      \"Product\": \"Xero Early Plan\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The 90% discount for the first 6 months is applied directly to the unit price of the 'Promo Period' charge ($15.00 * 0.1 = $1.50).\",\n    \"Service starts on 01/01/2026 and ends on 12/31/2026.\",\n    \"Billing timing is monthly in advance.\"\n  ],\n  \"open_questions\": [\n    \"Usage/overage fees for exceeding the 20-invoice limit are not modeled as no usage data was provided.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 99,\n    \"schedule_total\": 99,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-xero-21",
        "model": "gemini-3-flash-preview",
        "run_id": "6ca76e36-3349-4787-9c21-9161397ad04c",
        "created_at": "2025-12-31T10:48:27.033Z"
      }
    },
    {
      "id": "113bcfdc-e332-414e-b844-1b5a2542b88e",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Amazon Prime Video\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The $139 annual fee covers a stand-ready obligation to provide streaming and shipping benefits over 12 months.); Other: POB=over_time release=ratable_over_term (The Ad-Free upgrade is a recurring monthly service recognized over the monthly billing period.)\",\n  \"use_case_description\": \"A consumer signs up for the 'Amazon Prime Membership' plan, which is billed annually at $139.00. To enhance their viewing experience, they also subscribe to the 'Ad-Free Upgrade' add-on, which is billed monthly at $2.99. This scenario demonstrates Zuora's ability to manage mixed billing frequencies (Annual and Monthly) within a single subscription or account. Revenue for the annual membership is recognized ratably over the 12-month term, while the ad-free supplement is recognized ratably each month. The contract is set for an initial 12-month term with auto-renewal enabled.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 10.66\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 11.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"May-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 11.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 11.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 11.81\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 11.42\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 11.8\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 2.75\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 2.95\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 2.95\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 2.95\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 3.05\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 2.95\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Ad-Free Supplement\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 35.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 3.03\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized using the Daily Proration Method over the 365-day term of 2026.\",\n    \"Rounding adjustments applied in the final period (Dec-26) to ensure the sum of monthly amounts equals the total Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-amazon-prime-video-1",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:11:14.310Z"
      }
    },
    {
      "id": "a38b19d7-839b-4f14-9e31-18a2216bf5c2",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Amazon Prime Video\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standalone and Channel subscriptions provide continuous access over the month.); Other: POB=point_in_time release=at_delivery (The $3.99 rental is a one-time charge recognized when the digital access is granted.)\",\n  \"use_case_description\": \"A user subscribes to the 'Prime Video Standalone' plan at $8.99 per month. In the same month, they add a 'Premium Channel Add-on' (e.g., Max) for $15.99 per month through the Prime Video marketplace. Additionally, the user performs a one-time transaction in the 'Prime Video Store' to rent a movie for $3.99. This use case highlights the hybrid nature of the platform, combining recurring SaaS subscriptions with transactional video-on-demand (TVOD). Revenue for subscriptions is recognized ratably, whereas the rental fee is recognized at the point of purchase/delivery.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 8.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 8.87\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 8.87\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 8.87\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 8.87\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Base Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 107.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 9.16\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 14.72\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 15.77\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 15.77\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 15.77\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 16.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 15.77\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Channel Access Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 191.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 16.28\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Rental Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-01\",\n      \"Ext Allocated Price\": 3.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 3.99\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration (Daily Rate = Allocated Price / Total Days in Window) applied to ratable lines.\",\n    \"Rental Fee is recognized as a Point-in-Time (PIT) charge in the month of the Revenue Start Date.\",\n    \"Rounding adjustments applied to the final period of ratable schedules to ensure sum matches Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-amazon-prime-video-2",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:22:07.363Z"
      }
    },
    {
      "id": "81e8eb22-f712-453e-9422-885be101f3c0",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Amazon Prime Video\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (All components are recurring subscriptions providing access to content libraries.)\",\n  \"use_case_description\": \"A customer initiates a monthly 'Amazon Prime Membership' at $14.99. After the first month, they expand their service by adding multiple 'Prime Video Channels': Paramount+ at $11.99/month and MGM+ at $5.99/month. This scenario tests Zuora's ability to handle mid-term subscription amendments and the stacking of multiple recurring charges. The billing system must consolidate these into a single monthly invoice. All charges are recurring and recognized ratably over their respective monthly service periods.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 13.8\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 14.78\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 14.78\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 14.78\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 14.78\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Prime Membership Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 179.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 15.28\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 11.06\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 12.24\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 11.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"May-26\",\n      \"Amount\": 12.24\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 11.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 12.24\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 12.24\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 11.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 12.24\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 11.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Paramount+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 131.89,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 12.23\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 5.52\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.12\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 5.92\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.12\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 5.92\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.12\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.12\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 5.92\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.12\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 5.92\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"MGM+ Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 65.89,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.09\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used (Allocated Price / Total Days in Window * Days in Month)\",\n    \"Immaterial rounding adjustments applied to the final period of each line item to ensure the sum of monthly revenue equals the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-amazon-prime-video-3",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:27:04.115Z"
      }
    },
    {
      "id": "2966a0e7-0959-4c6e-8655-0c292a3d6b5d",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Apple TV+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue for all bundled services is recognized ratably over the monthly service period.)\",\n  \"use_case_description\": \"A family signs up for the Apple One Premier bundle to consolidate their digital ecosystem. The bundle includes Apple TV+, Apple Music, Apple Arcade, iCloud+ (2TB), Apple News+, and Apple Fitness+ for a flat monthly fee of $37.95. This is a recurring monthly subscription with no fixed term, though we will model it as a 12-month evergreen-style contract for revenue purposes. Because the bundle price ($37.95) is significantly lower than the sum of the individual list prices (~$67), revenue must be allocated across each service POB based on their standalone selling prices. All services are recognized ratably over the monthly billing period as they represent a stand-ready obligation to provide content and storage.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 5.73\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.32\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 6.3\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 6.75\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 6.75\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 6.75\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.98\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 6.75\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Apple Music - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 82.13,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.95\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 4.01\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 4.29\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"May-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 4.29\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 4.29\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 4.44\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 4.29\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Apple Arcade - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 52.24,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 4.43\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 5.73\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 4,\n      \"POB Name\": \"iCloud+ (2TB) - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.32\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 7.45\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 7.98\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"May-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 7.98\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 7.98\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 8.25\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 7.98\n    },\n    {\n      \"Line Item Num\": 5,\n      \"POB Name\": \"Apple News+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 97.08,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 8.21\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 5.73\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.34\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 6.14\n    },\n    {\n      \"Line Item Num\": 6,\n      \"POB Name\": \"Apple Fitness+ - Recurring\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 74.65,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.32\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable recognition.\",\n    \"Final month (Dec-26) includes a penny adjustment to ensure the sum matches the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-apple-tv-4",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:40:06.260Z"
      }
    },
    {
      "id": "e7455a0a-1df9-4550-8844-ac074f060b95",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Apple TV+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Annual TV+ plan recognized over 12 months.); Usage: POB=over_time release=ratable_over_term (MLS Pass recognized over the specific months of the active sports season.)\",\n  \"use_case_description\": \"A sports enthusiast subscribes to the Apple TV+ Annual Plan for $99.00/year to secure a discount over the monthly rate. Simultaneously, they add the MLS Season Pass as a recurring add-on. Since they are an Apple TV+ subscriber, they qualify for the discounted MLS rate of $79.00 for the season (compared to the $99.00 standalone price). The Apple TV+ fee is billed upfront annually, while the MLS Season Pass is billed as a single seasonal charge. Revenue for the Apple TV+ subscription is recognized ratably over the 12-month term. Revenue for the MLS Season Pass is recognized ratably over the 9-month active major league soccer season, rather than the full year, to align with the delivery of live match content.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Apple TV+ Annual Fee\",\n      \"Rate Plan\": \"Apple TV+ Annual Plan\",\n      \"Product\": \"Apple TV+\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99,\n      \"Amount\": 99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"MLS Seasonal Fee\",\n      \"Rate Plan\": \"MLS Season Pass Add-on (Subscriber Discount)\",\n      \"Product\": \"MLS Season Pass\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 79,\n      \"Amount\": 79,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing for both charges is InAdvance as the contract specifies fees are billed upfront.\",\n    \"The MLS Seasonal Fee is modeled as an annual recurring charge for billing purposes to facilitate the single seasonal payment, though revenue recognition occurs over 9 months.\",\n    \"The MLS Season Pass is billed at the discounted rate of $79.00 because the user is an active Apple TV+ subscriber at the time of purchase.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if the MLS Season Pass should be set to auto-renew on 01/01/2027 or if it requires a manual re-subscription for the next season.\",\n    \"Confirm the exact revenue recognition start and end dates for the 9-month MLS season (e.g., Feb to Oct) to ensure the Revenue Schedule is configured correctly in Zuora Revenue.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 178,\n    \"schedule_total\": 178,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-apple-tv-5",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:43:58.645Z"
      }
    },
    {
      "id": "7aa2d0e0-c3f6-4f33-a859-e58d626ac36b",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Apple TV+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Annual TV+ plan recognized over 12 months.); Usage: POB=over_time release=ratable_over_term (MLS Pass recognized over the specific months of the active sports season.)\",\n  \"use_case_description\": \"A sports enthusiast subscribes to the Apple TV+ Annual Plan for $99.00/year to secure a discount over the monthly rate. Simultaneously, they add the MLS Season Pass as a recurring add-on. Since they are an Apple TV+ subscriber, they qualify for the discounted MLS rate of $79.00 for the season (compared to the $99.00 standalone price). The Apple TV+ fee is billed upfront annually, while the MLS Season Pass is billed as a single seasonal charge. Revenue for the Apple TV+ subscription is recognized ratably over the 12-month term. Revenue for the MLS Season Pass is recognized ratably over the 9-month active major league soccer season, rather than the full year, to align with the delivery of live match content.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 7.59\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 8.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"May-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 8.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 8.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 8.41\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 8.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Apple TV+ Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 8.39\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 8.1\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 8.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 8.68\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"May-26\",\n      \"Amount\": 8.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 8.68\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 8.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 8.97\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 8.68\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"MLS Seasonal Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-02-01\",\n      \"Revenue End Date\": \"2026-10-31\",\n      \"Ext Allocated Price\": 79,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 8.98\n    }\n  ],\n  \"assumptions\": [\n    \"Used daily proration (Allocated Price / Total Days in Window) as per BK-OT-RATABLE instructions.\",\n    \"Rounding adjustments applied to the final month of each revenue window to ensure the sum of amounts equals the Ext Allocated Price.\",\n    \"Total days for Apple TV+ Annual Fee (2026): 365 days.\",\n    \"Total days for MLS Seasonal Fee (Feb 1 - Oct 31, 2026): 273 days.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-apple-tv-5",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:44:38.390Z"
      }
    },
    {
      "id": "3d9336c4-3cf4-4f05-9cf4-0e756c69e6ec",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Disney+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Annual Disney+ Premium fee recognized daily over the 365-day contract period.); Subscription: POB=over_time release=ratable_over_term (Extra Member monthly add-on recognized over the monthly service window.)\",\n  \"use_case_description\": \"A customer signs up for the Disney+ Premium annual plan at $189.99 per year, providing a discount over the monthly rate. During the same transaction, they add an 'Extra Member Add-on' for $6.99 per month to accommodate a family member living at a different address. The primary subscription is billed annually in advance, while the add-on is billed monthly. Revenue for the annual plan is recognized ratably over the 12-month term, and the add-on revenue is recognized ratably over each monthly service period. This scenario tests Zuora's ability to manage mixed billing frequencies (annual and monthly) within a single subscription.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Disney+ Premium Annual Fee\",\n      \"Rate Plan\": \"Annual Plan\",\n      \"Product\": \"Disney+ Premium\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 189.99,\n      \"Amount\": 189.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Extra Member Monthly Fee\",\n      \"Rate Plan\": \"Monthly Add-on\",\n      \"Product\": \"Extra Member Add-on\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.99,\n      \"Amount\": 6.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing Cycle Day is set to the 1st of the month.\",\n    \"The Extra Member Add-on remains active for the full 12-month term.\",\n    \"InAdvance billing timing applies to both the annual fee and the monthly add-on as per the subscription spec.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 273.87,\n    \"schedule_total\": 273.87,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-disney-7",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T08:58:13.433Z"
      }
    },
    {
      "id": "d4cb2e66-7537-4a9e-b133-9b87264d54a5",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Disney+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Annual Disney+ Premium fee recognized daily over the 365-day contract period.); Subscription: POB=over_time release=ratable_over_term (Extra Member monthly add-on recognized over the monthly service window.)\",\n  \"use_case_description\": \"A customer signs up for the Disney+ Premium annual plan at $189.99 per year, providing a discount over the monthly rate. During the same transaction, they add an 'Extra Member Add-on' for $6.99 per month to accommodate a family member living at a different address. The primary subscription is billed annually in advance, while the add-on is billed monthly. Revenue for the annual plan is recognized ratably over the 12-month term, and the add-on revenue is recognized ratably over each monthly service period. This scenario tests Zuora's ability to manage mixed billing frequencies (annual and monthly) within a single subscription.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 14.57\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 15.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"May-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 15.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 15.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 16.14\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 15.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Disney+ Premium Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 189.99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 16.1\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 6.43\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 6.89\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 6.89\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 6.89\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 7.12\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 6.89\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Extra Member Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 83.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 7.17\n    }\n  ],\n  \"assumptions\": [\n    \"Used daily proration method based on total days in the revenue window (365 days for 2026).\",\n    \"Final month (Dec-26) includes a rounding adjustment to ensure total recognized revenue matches the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-disney-7",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:01:27.605Z"
      }
    },
    {
      "id": "a5f0d34b-a94b-4f5e-8517-7aa47837c36e",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Disney+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Live TV POB: Allocated portion of the $82.99 recognized ratably over the month.); Subscription: POB=over_time release=ratable_over_term (Disney+ POB: Allocated portion recognized ratably over the month.); Subscription: POB=over_time release=ratable_over_term (ESPN+ POB: Allocated portion recognized ratably over the month.)\",\n  \"use_case_description\": \"A cord-cutter subscribes to the Hulu + Live TV Bundle for $82.99 per month. This high-value package includes Live TV, Disney+ (With Ads), and ESPN+. For financial reporting, Disney+ needs to allocate the total transaction price across three distinct Performance Obligations (POBs): Live TV, Disney Content, and Sports Content. This ensures revenue is accurately attributed to the respective content libraries and business segments. The allocation is based on the standalone selling prices (SSP) of the individual components, which exceed the bundle price. All components are recognized ratably over the monthly service period.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV Bundle - Recurring\",\n      \"Rate Plan\": \"Hulu + Live TV Bundle\",\n      \"Product\": \"Hulu + Live TV\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 82.99,\n      \"Amount\": 82.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance as per contract intel, with invoices generated on the first day of each service period.\",\n    \"The billing schedule reflects the customer-facing billable item (Hulu + Live TV Bundle) at the consolidated price of $82.99.\",\n    \"Performance Obligation (POB) allocations for Live TV, Disney Content, and Sports Content are assumed to be handled within the Revenue Recognition subledger (e.g., Zuora Revenue) rather than as separate line items on the Billing invoice, as they are part of a single bundled transaction price.\"\n  ],\n  \"open_questions\": [\n    \"Should the three Performance Obligations (Live TV, Disney Content, Sports Content) be displayed as separate line items on the invoice (using calculated SSP ratios), or are they only for internal financial reporting?\",\n    \"Confirm if any taxes are applicable to the bundle price, as they are not included in this schedule.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 995.88,\n    \"schedule_total\": 995.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-disney-9",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:13:48.368Z"
      }
    },
    {
      "id": "0614f5c0-309b-4934-8284-1fd3016462b5",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Subscription revenue for the bundle is recognized daily over the monthly billing cycle.)\",\n  \"use_case_description\": \"This scenario covers a high-value consumer signing up for the 'Disney Bundle Trio Premium'. The bundle includes Hulu (No Ads), Disney+ (No Ads), and ESPN+ (With Ads) for a consolidated price of $29.99 per month. This use case demonstrates Zuora's ability to handle multi-product bundles with a single monthly charge. Revenue is recognized ratably over the monthly service period for each component. We will treat the three services as distinct performance obligations (POBs) to show revenue allocation logic. The contract is modeled as a 12-month term to reflect expected customer lifetime value.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Disney Bundle Trio Premium - Recurring\",\n      \"Rate Plan\": \"Disney Bundle Trio Premium\",\n      \"Product\": \"Disney Bundle\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 29.99,\n      \"Amount\": 29.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance per subscription spec, resulting in invoice generation at the start of each service period.\",\n    \"The 12-month contract is billed as 12 equal monthly installments of $29.99.\",\n    \"Revenue allocation for the three POBs (Hulu, Disney+, ESPN+) is handled by Zuora Revenue and does not impact the single-line invoice presentation.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if the customer requires a single consolidated invoice line for the bundle or separate line items for each service component for tax or reporting purposes.\",\n    \"Confirm billing timing: InAdvance (period start) vs InArrears (period end) to ensure alignment with financial reporting requirements.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 359.88,\n    \"schedule_total\": 359.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-10",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:19:37.943Z"
      }
    },
    {
      "id": "112d1a88-96ab-4b1a-84d9-4dd2bd7fd9a5",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Subscription revenue for the bundle is recognized daily over the monthly billing cycle.)\",\n  \"use_case_description\": \"This scenario covers a high-value consumer signing up for the 'Disney Bundle Trio Premium'. The bundle includes Hulu (No Ads), Disney+ (No Ads), and ESPN+ (With Ads) for a consolidated price of $29.99 per month. This use case demonstrates Zuora's ability to handle multi-product bundles with a single monthly charge. Revenue is recognized ratably over the monthly service period for each component. We will treat the three services as distinct performance obligations (POBs) to show revenue allocation logic. The contract is modeled as a 12-month term to reflect expected customer lifetime value.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 11.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 11.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"May-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 11.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 11.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 12.36\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 11.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 145.5,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 12.34\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 9.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 10.07\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"May-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 10.07\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 10.07\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 10.4\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 10.07\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Disney+ (No Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 122.51,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 10.43\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 7.05\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 7.55\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"May-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 7.55\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 7.55\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 7.8\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 7.55\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"ESPN+ (With Ads) - Component\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 91.87,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 7.82\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue is recognized using standard straightline daily proration based on the 2026 calendar year (365 days).\",\n    \"Final month (Dec-26) includes a rounding adjustment to ensure the total recognized revenue matches the Ext Allocated Price for each line item.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-10",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:20:23.547Z"
      }
    },
    {
      "id": "59d3f7ec-f9ea-4980-ac63-0593ebccd6bf",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Core Live TV and Screens add-on revenue is recognized ratably over the service month.); Other: POB=over_time release=ratable_over_term (Partner add-on (Max) revenue is recognized ratably, though net-reporting may apply if Hulu is an agent.)\",\n  \"use_case_description\": \"A premium 'cord-cutter' subscriber opts for the Hulu + Live TV (No Ads) Bundle at $99.99/month. To enhance their experience, they add the Unlimited Screens Add-on for $9.99/month and the Max (Partner Add-on) for $16.99/month. This scenario showcases Zuora's flexibility in managing core streaming products alongside feature-based add-ons and third-party partner services. Total monthly recurring revenue is $126.97. Revenue for the Hulu bundle and the screens add-on is recognized ratably. The Max add-on is also recognized ratably over the monthly term, assuming Hulu acts as the primary billing relationship holder.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Hulu - Premium Cord-Cutter Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 99.99,\n      \"Unit Sell Price\": 99.99,\n      \"Ext List Price\": 1199.88,\n      \"Ext Sell Price\": 1199.88,\n      \"SSP Price\": 99.99,\n      \"Ext SSP Price\": 1199.88,\n      \"SSP Percent\": 78.7508,\n      \"Ext Allocated Price\": 1199.88,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 1199.88,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Hulu\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Streaming Bundle\",\n      \"Product Family\": \"Core Subscription\"\n    },\n    {\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 2,\n      \"Subscription Name\": \"Hulu - Premium Cord-Cutter Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Unlimited Screens Monthly Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 9.99,\n      \"Unit Sell Price\": 9.99,\n      \"Ext List Price\": 119.88,\n      \"Ext Sell Price\": 119.88,\n      \"SSP Price\": 9.99,\n      \"Ext SSP Price\": 119.88,\n      \"SSP Percent\": 7.868,\n      \"Ext Allocated Price\": 119.88,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 119.88,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Hulu\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Streaming Add-on\",\n      \"Product Family\": \"Features\"\n    },\n    {\n      \"POB Name\": \"Max Monthly Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": false,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 3,\n      \"Subscription Name\": \"Hulu - Premium Cord-Cutter Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Max Monthly Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 16.99,\n      \"Unit Sell Price\": 16.99,\n      \"Ext List Price\": 203.88,\n      \"Ext Sell Price\": 203.88,\n      \"SSP Price\": 16.99,\n      \"Ext SSP Price\": 203.88,\n      \"SSP Percent\": 13.3812,\n      \"Ext Allocated Price\": 203.88,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 203.88,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Hulu\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Partner Add-on\",\n      \"Product Family\": \"Third Party Services\"\n    }\n  ],\n  \"assumptions\": [\n    \"Ordered Qty is set to 12 to represent the full 12-month contract term per CO-003.\",\n    \"Ext Allocated Price equals Ext Sell Price because is_allocations is set to false.\",\n    \"SSP Percent is calculated based on relative Sell Price weights for reporting purposes.\",\n    \"Hulu acts as the principal for the Max Add-on, allowing for full gross revenue recognition ratably over the term.\"\n  ],\n  \"open_questions\": [\n    \"Is there a revenue share agreement with Max that would require net revenue recognition instead of gross?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-11",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:28:40.497Z"
      }
    },
    {
      "id": "3acc4c48-f20c-4922-828a-2945ffa6cd8e",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Core Live TV and Screens add-on revenue is recognized ratably over the service month.); Other: POB=over_time release=ratable_over_term (Partner add-on (Max) revenue is recognized ratably, though net-reporting may apply if Hulu is an agent.)\",\n  \"use_case_description\": \"A premium 'cord-cutter' subscriber opts for the Hulu + Live TV (No Ads) Bundle at $99.99/month. To enhance their experience, they add the Unlimited Screens Add-on for $9.99/month and the Max (Partner Add-on) for $16.99/month. This scenario showcases Zuora's flexibility in managing core streaming products alongside feature-based add-ons and third-party partner services. Total monthly recurring revenue is $126.97. Revenue for the Hulu bundle and the screens add-on is recognized ratably. The Max add-on is also recognized ratably over the monthly term, assuming Hulu acts as the primary billing relationship holder.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Rate Plan\": \"Hulu + Live TV (No Ads)\",\n      \"Product\": \"Hulu + Live TV Bundle\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 99.99,\n      \"Amount\": 99.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Unlimited Screens Monthly Fee\",\n      \"Rate Plan\": \"Unlimited Screens Add-on\",\n      \"Product\": \"Unlimited Screens\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Max Monthly Fee\",\n      \"Rate Plan\": \"Max (Partner Add-on)\",\n      \"Product\": \"Max Add-on\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing is performed on the 1st of each month (calendar month alignment).\",\n    \"Billing Timing is InAdvance, meaning the invoice date matches the period start date.\",\n    \"No taxes are included in the calculation.\",\n    \"Hulu acts as the primary billing relationship holder for the Max partner add-on.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if any promotional discounts or free trial periods apply to the first month.\",\n    \"Confirm the specific Bill Cycle Day (BCD) if different from the 1st of the month.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 1523.64,\n    \"schedule_total\": 1523.64,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-11",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:29:01.604Z"
      }
    },
    {
      "id": "6834ff90-12ae-42cf-9707-6eaa2d0cf51f",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Core Live TV and Screens add-on revenue is recognized ratably over the service month.); Other: POB=over_time release=ratable_over_term (Partner add-on (Max) revenue is recognized ratably, though net-reporting may apply if Hulu is an agent.)\",\n  \"use_case_description\": \"A premium 'cord-cutter' subscriber opts for the Hulu + Live TV (No Ads) Bundle at $99.99/month. To enhance their experience, they add the Unlimited Screens Add-on for $9.99/month and the Max (Partner Add-on) for $16.99/month. This scenario showcases Zuora's flexibility in managing core streaming products alongside feature-based add-ons and third-party partner services. Total monthly recurring revenue is $126.97. Revenue for the Hulu bundle and the screens add-on is recognized ratably. The Max add-on is also recognized ratably over the monthly term, assuming Hulu acts as the primary billing relationship holder.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 92.05\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 98.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 98.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 98.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 101.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 98.62\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu + Live TV (No Ads) Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 1199.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 101.89\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 9.2\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 9.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 9.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 9.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 10.18\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 9.85\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Unlimited Screens Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 10.2\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 15.64\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Max Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 17.28\n    }\n  ],\n  \"assumptions\": [\n    \"Standard straight-line daily revenue recognition used as per WATERFALL INSTRUCTIONS.\",\n    \"Daily Rate = Ext Allocated Price / 365 days (Total days in 2026).\",\n    \"Monthly recognition = Daily Rate x Days in Month.\",\n    \"Final month (Dec-26) includes a minor rounding adjustment to ensure the total recognized equals the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-11",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:29:38.919Z"
      }
    },
    {
      "id": "c158ca77-287d-474a-8cc6-b484e4a63a10",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The $119.99 annual fee is recognized as 1/12th each month over the 1-year term.)\",\n  \"use_case_description\": \"A budget-conscious subscriber chooses the Hulu (With Ads) Annual plan for $119.99/year. This scenario highlights Zuora's capability to manage annual billing cycles and the associated deferred revenue. The customer pays the full amount upfront, providing immediate cash flow but requiring revenue to be spread over the 12-month term. This plan offers a discount compared to the monthly $11.99 rate, incentivizing long-term retention. Zuora will automate the monthly revenue recognition of approximately $10 per month. This demonstrates effective management of the 'Contract Liability' or 'Deferred Revenue' balance.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Rate Plan\": \"Annual Plan\",\n      \"Product\": \"Hulu (With Ads)\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 119.99,\n      \"Amount\": 119.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance as the customer pays the full amount upfront per the contract notes.\",\n    \"The service period aligns with the calendar year (01/01/2026 - 12/31/2026).\",\n    \"Revenue recognition is handled separately by Zuora Revenue, distributing the $119.99 over the 12-month term (approx. $10/month).\",\n    \"Invoice Date is set to the Billing Period Start date for upfront payment.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if any applicable taxes should be estimated or if the $119.99 is the gross total.\",\n    \"Confirm if there are any specific local e-invoicing requirements for the Hulu entity.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 119.99,\n    \"schedule_total\": 119.99,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-12",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:36:40.735Z"
      }
    },
    {
      "id": "eec5195c-2fcd-458b-93e0-76b64d08ae00",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Hulu\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The $119.99 annual fee is recognized as 1/12th each month over the 1-year term.)\",\n  \"use_case_description\": \"A budget-conscious subscriber chooses the Hulu (With Ads) Annual plan for $119.99/year. This scenario highlights Zuora's capability to manage annual billing cycles and the associated deferred revenue. The customer pays the full amount upfront, providing immediate cash flow but requiring revenue to be spread over the 12-month term. This plan offers a discount compared to the monthly $11.99 rate, incentivizing long-term retention. Zuora will automate the monthly revenue recognition of approximately $10 per month. This demonstrates effective management of the 'Contract Liability' or 'Deferred Revenue' balance.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 9.2\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"May-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Hulu (With Ads) Annual Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 10.21\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized ratably over the 12-month contract term using the daily proration method.\",\n    \"Total days in the revenue window (2026-01-01 to 2026-12-31) is 365 days.\",\n    \"Daily rate calculated as $119.99 / 365 days = $0.328739726 per day.\",\n    \"Monthly amounts calculated as (Daily Rate * Days in Month), with a rounding adjustment in the final month to reconcile to the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-hulu-12",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:37:04.334Z"
      }
    },
    {
      "id": "e21774fb-1d13-4105-8fe9-7c08529909af",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Max (HBO Max)\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Base subscription revenue recognized daily over the monthly billing period.); Usage: POB=over_time release=ratable_over_term (Sports add-on is a recurring monthly fee recognized ratably over the service month.)\",\n  \"use_case_description\": \"The customer subscribes to the Max Ad-Free (Standard) rate plan at $16.99 per month to enjoy offline downloads and no ads. They also add the B/R Sports Add-On for a recurring fee of $10.00 per month to access live NBA and MLB games. Both charges are recurring and billed monthly in advance. The contract is modeled as a 12-month term with monthly billing. Revenue for both the base subscription and the sports add-on is recognized ratably over the monthly service period as the customer has continuous access to the content library.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Standard Monthly Plan\",\n      \"Product\": \"Max Ad-Free (Standard)\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 16.99,\n      \"Amount\": 16.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Sports Add-on Fee\",\n      \"Rate Plan\": \"Sports Add-On Monthly\",\n      \"Product\": \"B/R Sports Add-On\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 10,\n      \"Amount\": 10,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance, meaning the Invoice Date and Billing Date align with the start of each service period.\",\n    \"No proration is required as the service start date (01/01/2026) aligns with the start of the calendar month.\",\n    \"Total Contract Value (TCV) is calculated as (Monthly Subscription Fee + Sports Add-on Fee) * 12 months.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 323.88,\n    \"schedule_total\": 323.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-max-formerly-hbo-max-13",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:40:32.327Z"
      }
    },
    {
      "id": "334a42c7-357a-4918-8883-55270fd0850f",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Max (HBO Max)\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Base subscription revenue recognized daily over the monthly billing period.); Usage: POB=over_time release=ratable_over_term (Sports add-on is a recurring monthly fee recognized ratably over the service month.)\",\n  \"use_case_description\": \"The customer subscribes to the Max Ad-Free (Standard) rate plan at $16.99 per month to enjoy offline downloads and no ads. They also add the B/R Sports Add-On for a recurring fee of $10.00 per month to access live NBA and MLB games. Both charges are recurring and billed monthly in advance. The contract is modeled as a 12-month term with monthly billing. Revenue for both the base subscription and the sports add-on is recognized ratably over the monthly service period as the customer has continuous access to the content library.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 15.64\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 17.32\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 16.76\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 203.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 17.28\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 9.21\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"May-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Sports Add-on Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 120,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 10.21\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized using daily proration method over 365 days in 2026.\",\n    \"Rounding adjustments applied to the final period (Dec-26) to ensure the total recognized revenue matches the Ext Allocated Price exactly.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-max-formerly-hbo-max-13",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T09:41:06.451Z"
      }
    },
    {
      "id": "4a426754-d0e1-472f-b993-adf331d04144",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Max (HBO Max)\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Allocated revenue for Max component recognized ratably over the month.); Subscription: POB=over_time release=ratable_over_term (Allocated revenue for Disney+ and Hulu components recognized ratably over the month.)\",\n  \"use_case_description\": \"The customer subscribes to the 'Disney+, Hulu, Max Bundle' for a combined monthly price of $16.99. This bundle includes the ad-supported tiers of all three services. In Zuora, this is modeled with three separate rate plan charges to track the performance obligations: Max With Ads (List $9.99), Disney+ (List $7.99), and Hulu (List $7.99). Because the total sell price of $16.99 is less than the total list price of $25.97, revenue must be allocated across the three components based on their standalone selling prices (List Price). Revenue for all three components is recognized ratably over the monthly billing period.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Max With Ads\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 6.53,\n      \"Amount\": 6.53,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Disney+\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Hulu\",\n      \"Rate Plan\": \"Bundle - Ad Supported\",\n      \"Product\": \"Disney+, Hulu, Max Bundle\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.23,\n      \"Amount\": 5.23,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The monthly bundle price of $16.99 is allocated across the three components based on their standalone list prices (Max $9.99, Disney+ $7.99, Hulu $7.99).\",\n    \"Allocated monthly pricing: Max With Ads = $6.53, Disney+ = $5.23, Hulu = $5.23. The total monthly sell price ($16.99) is maintained.\",\n    \"Target TCV is calculated as the monthly bundle price ($16.99) multiplied by the 12-month term ($203.88).\",\n    \"Billing is performed monthly in advance, triggered by the Contract Effective date of 01/01/2026.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 203.88,\n    \"schedule_total\": 203.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-max-formerly-hbo-max-15",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:00:49.337Z"
      }
    },
    {
      "id": "58e49735-6cb1-46ac-8443-9cfee1f91fa4",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Netflix\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The Premium Plan fee is recognized daily over the monthly billing cycle.); Other: POB=over_time release=ratable_over_term (Extra Member Slots are recurring add-ons recognized ratably over the same period as the primary subscription.)\",\n  \"use_case_description\": \"A residential customer signs up for the Netflix Premium Plan at $24.99 per month to access 4K streaming and spatial audio. To accommodate family members living in different households, the customer adds two 'Extra Member Slots' at $8.99 each per month. The subscription is billed monthly in advance on a month-to-month basis. This scenario demonstrates Zuora's ability to manage a primary subscription plan alongside multiple recurring add-on charges. Revenue for both the base plan and the add-on slots is recognized ratably over the monthly service period. The total monthly recurring revenue (MRR) for this account is $42.97.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Premium Plan Fee\",\n      \"Rate Plan\": \"Premium Plan - Monthly\",\n      \"Product\": \"Netflix Premium Plan\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 24.99,\n      \"Amount\": 24.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Extra Member Slot Fee\",\n      \"Rate Plan\": \"Extra Member Add-on\",\n      \"Product\": \"Extra Member Slots\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 2,\n      \"Unit Price\": 8.99,\n      \"Amount\": 17.98,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Schedule generated for a 12-month term as per Contract Intel, despite the month-to-month description.\",\n    \"Billing Timing is In Advance, so Invoice Date and Billing Date align with the Period Start.\",\n    \"Billing Period is Monthly, and the term starts on the 1st of the month, resulting in no proration.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 515.64,\n    \"schedule_total\": 515.64,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-netflix-16",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:07:59.204Z"
      }
    },
    {
      "id": "97f69af9-0910-4d17-80e0-8553d4ee730e",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Netflix\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (The total contract value (net of discount) is recognized ratably over the 365-day term.)\",\n  \"use_case_description\": \"A boutique hotel chain enters a B2B agreement to provide Netflix 'Standard' access in 50 guest rooms. The list price of $17.99 per unit is discounted by 20% to $14.39 per unit per month due to the volume commitment. The contract is set for a 12-month term with annual upfront billing totaling $8,634.00. This scenario requires Zuora to handle a high-volume subscription with a percentage-based discount. Because the discount applies to a single performance obligation (the subscription service) across multiple units, revenue is recognized ratably over the 12-month term. This demonstrates Zuora's capability in the B2B/Partner space beyond simple consumer billing.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 662.33\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 709.64\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"May-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 709.64\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 709.64\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 733.3\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 709.64\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Subscription Service POB\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 8634,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 733.31\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used (Allocated / 365 days)\",\n    \"Rounding adjustment of $0.01 applied to Dec-26 to reconcile total to Ext Allocated Price\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-netflix-18",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:28:08.410Z"
      }
    },
    {
      "id": "3ade865c-6eca-4cf1-8555-94f401824c46",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard SaaS streaming revenue recognized daily over the 12-month service period.)\",\n  \"use_case_description\": \"A consumer signs up for the Paramount+ Premium (with SHOWTIME) Annual plan. This plan provides ad-free streaming, the full SHOWTIME library, and local CBS station access. The customer is billed $119.99 upfront for a 12-month term. In Zuora, this is modeled as a recurring annual charge on a single rate plan. Revenue recognition is handled ratably over the 12-month subscription period. This scenario demonstrates the annual upfront billing model which offers a significant discount compared to the cumulative monthly billing rate. The contract is set to auto-renew at the end of the term.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Year\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Paramount+ Premium (with SHOWTIME) Annual Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Annual Subscription Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 119.99,\n      \"Unit Sell Price\": 119.99,\n      \"Ext List Price\": 119.99,\n      \"Ext Sell Price\": 119.99,\n      \"SSP Price\": 119.99,\n      \"Ext SSP Price\": 119.99,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 119.99,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 119.99,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Paramount+\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Streaming Service\",\n      \"Product Family\": \"Paramount+ Premium\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Eligible Flag set to false as per input instructions; Ext Allocated Price equals Ext Sell Price.\",\n    \"SSP Price is set to the Unit List Price ($119.99).\",\n    \"Revenue recognition is ratable over the 12-month term (Jan 2026 - Dec 2026).\",\n    \"Subscription Version 1 represents the initial booking of the annual plan.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-19",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:30:40.460Z"
      }
    },
    {
      "id": "7b10479d-f588-4022-9ea4-b01ba04278f4",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard SaaS streaming revenue recognized daily over the 12-month service period.)\",\n  \"use_case_description\": \"A consumer signs up for the Paramount+ Premium (with SHOWTIME) Annual plan. This plan provides ad-free streaming, the full SHOWTIME library, and local CBS station access. The customer is billed $119.99 upfront for a 12-month term. In Zuora, this is modeled as a recurring annual charge on a single rate plan. Revenue recognition is handled ratably over the 12-month subscription period. This scenario demonstrates the annual upfront billing model which offers a significant discount compared to the cumulative monthly billing rate. The contract is set to auto-renew at the end of the term.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Annual Subscription Fee\",\n      \"Rate Plan\": \"Annual Plan\",\n      \"Product\": \"Paramount+ Premium (with SHOWTIME)\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 119.99,\n      \"Amount\": 119.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance as per the upfront payment model described.\",\n    \"The trigger event ContractEffective is aligned with the Service Start Date of 01/01/2026.\",\n    \"The subscription is a flat fee model for the entire year.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 119.99,\n    \"schedule_total\": 119.99,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-19",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:30:59.127Z"
      }
    },
    {
      "id": "cb84364c-3b14-4d96-8ce7-3ad035a90d3f",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard SaaS streaming revenue recognized daily over the 12-month service period.)\",\n  \"use_case_description\": \"A consumer signs up for the Paramount+ Premium (with SHOWTIME) Annual plan. This plan provides ad-free streaming, the full SHOWTIME library, and local CBS station access. The customer is billed $119.99 upfront for a 12-month term. In Zuora, this is modeled as a recurring annual charge on a single rate plan. Revenue recognition is handled ratably over the 12-month subscription period. This scenario demonstrates the annual upfront billing model which offers a significant discount compared to the cumulative monthly billing rate. The contract is set to auto-renew at the end of the term.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 9.2\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"May-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 10.19\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 9.86\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 119.99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 10.21\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method: Daily Rate = $119.99 / 365 days ≈ $0.3287397/day.\",\n    \"Monthly amounts calculated by multiplying the daily rate by the number of days in each month.\",\n    \"A rounding adjustment of $0.02 was applied to the final period (Dec-26) to ensure the total recognized revenue equals the Ext Allocated Price of $119.99.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-19",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:31:31.362Z"
      }
    },
    {
      "id": "bd108f3d-c7ff-4368-94cb-f78d6c1c10ac",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue is recognized ratably over the monthly billing cycle.)\",\n  \"use_case_description\": \"A verified student subscribes to the Paramount+ Essential tier. The standard list price for this ad-supported plan is $7.99 per month. However, the student receives a 25% recurring discount, resulting in a net monthly charge of $5.99. The subscription is evergreen, but for this demo, we are modeling a 12-month initial term. Billing occurs monthly on the anniversary of the sign-up date. Revenue is recognized ratably over each monthly service period. This case highlights Zuora's ability to manage recurring discounts for specific customer segments and handle high-volume monthly billing.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Paramount+ Essential\",\n      \"Rate Plan\": \"Essential (Student Discount)\",\n      \"Product\": \"Paramount+\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 5.99,\n      \"Amount\": 5.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The 25% discount is applied directly to the $7.99 list price, resulting in the $5.99 net monthly charge stated in the use case.\",\n    \"Billing is set to InAdvance, so the Invoice Date and Billing Date align with the Billing Period Start.\",\n    \"The subscription is evergreen but modeled here for a 12-month initial term per the demo requirements.\",\n    \"Billing Day is the 1st of the month based on the Service Start Date of 01/01/2026.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 71.88,\n    \"schedule_total\": 71.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-20",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:34:33.883Z"
      }
    },
    {
      "id": "58db0463-75a6-49c9-bf89-4fb87fd22310",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue is recognized ratably over the monthly billing cycle.)\",\n  \"use_case_description\": \"A verified student subscribes to the Paramount+ Essential tier. The standard list price for this ad-supported plan is $7.99 per month. However, the student receives a 25% recurring discount, resulting in a net monthly charge of $5.99. The subscription is evergreen, but for this demo, we are modeling a 12-month initial term. Billing occurs monthly on the anniversary of the sign-up date. Revenue is recognized ratably over each monthly service period. This case highlights Zuora's ability to manage recurring discounts for specific customer segments and handle high-volume monthly billing.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 5.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 5.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 5.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 5.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 6.1\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 5.91\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Paramount+ Essential\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 71.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 6.13\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable recognition\",\n    \"Total days in contract term (2026-01-01 to 2026-12-31) is 365 days\",\n    \"Rounding adjustment of $0.03 applied to the final month (Dec-26) to ensure the total recognized revenue matches the Ext Allocated Price of $71.88\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-20",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:35:12.425Z"
      }
    },
    {
      "id": "4b0bf598-d53e-42d1-9c15-d058f68304c3",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Paramount+\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Wholesale revenue for a fixed seat count is recognized ratably over the month.)\",\n  \"use_case_description\": \"This scenario represents a B2B2C wholesale distribution agreement with a retail partner like Walmart. The partner pays a negotiated wholesale rate of $4.00 per month for each active member assigned a Paramount+ Essential account. For this specific contract, the partner commits to a fixed block of 10,000 seats. Billing is consolidated into a single monthly invoice sent to the partner's corporate headquarters. Revenue is recognized monthly as the service is delivered to the partner's user base. This demonstrates the wholesale/bulk distribution model common in streaming media partnerships, distinct from the direct-to-consumer model.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 36821.92\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 39452.05\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"May-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 39452.05\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 39452.05\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 40767.12\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 39452.05\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Wholesale Seat Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 480000,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 40767.16\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable recognition over 365 days in 2026.\",\n    \"Final period amount (Dec-26) includes a rounding adjustment of +$0.02 to ensure the total recognized sum equals the Ext Allocated Price of $480,000.00.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-paramount-21",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T10:48:54.491Z"
      }
    },
    {
      "id": "a90a4c5d-cb44-4f45-9e1d-1a5e8efee7e3",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 1,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard monthly SaaS subscription recognized daily over the billing cycle.)\",\n  \"use_case_description\": \"A standard consumer signs up for the Peacock Premium monthly plan. The product is the 'Peacock Premium' subscription, which includes an ad-supported content library and live sports. The billing is set to $7.99 per month on a recurring basis. This is a month-to-month arrangement with no long-term commitment. Revenue for the monthly fee is recognized ratably over the 1-month service period. The scenario reflects the mid-2024 price increase for new subscribers.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-31\",\n      \"Ext Allocated Price\": 7.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 7.99\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized ratably using daily proration method (Total Days: 31).\",\n    \"Since the revenue window (2026-01-01 to 2026-01-31) falls entirely within a single accounting period, 100% of the allocated price is recognized in Jan-26.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-22",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:02:09.531Z"
      }
    },
    {
      "id": "ca733831-3b12-4f1c-8c11-2242ca1d81ec",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Prepaid annual subscription recognized over the 12-month contract duration.)\",\n  \"use_case_description\": \"A power user opts for the 'Peacock Premium Plus' annual plan to receive ad-free viewing and local NBC access. The annual list price is $139.99, billed upfront. This plan provides 12 months of service for the price of 10, effectively a built-in discount for the annual commitment. The subscription includes offline download capabilities and 24/7 local channel access. Revenue is recognized ratably over the 12-month term. This scenario tests the ability to handle large upfront payments with deferred revenue schedules.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Annual\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Peacock - Peacock Premium Plus Annual\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 139.99,\n      \"Unit Sell Price\": 139.99,\n      \"Ext List Price\": 139.99,\n      \"Ext Sell Price\": 139.99,\n      \"SSP Price\": 139.99,\n      \"Ext SSP Price\": 139.99,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 139.99,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 139.99,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Peacock\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Streaming Service\",\n      \"Product Family\": \"Peacock Premium Plus\"\n    }\n  ],\n  \"assumptions\": [\n    \"Allocation Eligible Flag set to false per input instructions ('Allocations: No')\",\n    \"SSP Price is set equal to Unit Sell Price in the absence of a standalone selling price list\",\n    \"POB Name and RPC Segment exactly match the charge name from the subscription specification to ensure downstream consistency\",\n    \"Revenue is recognized ratably over the 12-month term as specified in the use case\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-23",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:04:23.310Z"
      }
    },
    {
      "id": "3bba92a9-991c-4e10-a4e7-713268e5624f",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Prepaid annual subscription recognized over the 12-month contract duration.)\",\n  \"use_case_description\": \"A power user opts for the 'Peacock Premium Plus' annual plan to receive ad-free viewing and local NBC access. The annual list price is $139.99, billed upfront. This plan provides 12 months of service for the price of 10, effectively a built-in discount for the annual commitment. The subscription includes offline download capabilities and 24/7 local channel access. Revenue is recognized ratably over the 12-month term. This scenario tests the ability to handle large upfront payments with deferred revenue schedules.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Subscription Fee\",\n      \"Rate Plan\": \"Annual Plan\",\n      \"Product\": \"Peacock Premium Plus\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 139.99,\n      \"Amount\": 139.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The annual list price of $139.99 is the final contracted price for the 12-month term as specified in the input.\",\n    \"The marketing note '12 months for the price of 10' is considered built into the $139.99 price point and no additional discounts are applied.\",\n    \"Billing is triggered on the Contract Effective date of 01/01/2026.\",\n    \"The billing timing is set to In Advance, resulting in a single invoice at the start of the service term.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 139.99,\n    \"schedule_total\": 139.99,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-23",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:04:40.543Z"
      }
    },
    {
      "id": "c5761a77-6bbd-4972-8caf-a2d771051664",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Prepaid annual subscription recognized over the 12-month contract duration.)\",\n  \"use_case_description\": \"A power user opts for the 'Peacock Premium Plus' annual plan to receive ad-free viewing and local NBC access. The annual list price is $139.99, billed upfront. This plan provides 12 months of service for the price of 10, effectively a built-in discount for the annual commitment. The subscription includes offline download capabilities and 24/7 local channel access. Revenue is recognized ratably over the 12-month term. This scenario tests the ability to handle large upfront payments with deferred revenue schedules.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 10.74\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"May-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium Plus/Annual Plan/Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 11.87\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized ratably over the 12-month contract term (365 days).\",\n    \"Daily rate calculated as $139.99 / 365 days = $0.38353 per day.\",\n    \"Monthly amounts determined by multiplying the daily rate by the number of days in each month.\",\n    \"A rounding adjustment of -$0.02 was applied to the final period (Dec-26) to ensure the total recognized revenue equals the Ext Allocated Price of $139.99.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-23",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:05:06.050Z"
      }
    },
    {
      "id": "32484e64-339d-4711-9f7f-8b8b9f4da693",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue recognized monthly based on the $1.99 net price per month.)\",\n  \"use_case_description\": \"A student signs up for a discounted Peacock Premium plan after SheerID verification. The plan is priced at $1.99 per month for a 12-month period, representing a significant discount from the standard $7.99 rate. This scenario uses a recurring monthly charge with a specific discount applied for the duration of the student status. After 12 months, the price is expected to revert to the standard rate unless re-verified. Revenue is recognized monthly based on the discounted transaction price. This tests promotional pricing and term-limited discounts.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Peacock Premium (Student Discounted)\",\n      \"Rate Plan\": \"Student Plan\",\n      \"Product\": \"Peacock Premium\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1.99,\n      \"Amount\": 1.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing is performed monthly in advance on the first of each month.\",\n    \"The student discount of $6.00 is applied directly to the unit price, resulting in a net price of $1.99 per month.\",\n    \"The subscription term is exactly 12 months, after which the price is expected to revert (not included in this schedule).\",\n    \"Currency is USD as specified in the subscription spec.\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 23.88,\n    \"schedule_total\": 23.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-24",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:12:07.119Z"
      }
    },
    {
      "id": "7757e474-d238-4a07-a61c-9c56f8d40bfb",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Peacock\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue recognized monthly based on the $1.99 net price per month.)\",\n  \"use_case_description\": \"A student signs up for a discounted Peacock Premium plan after SheerID verification. The plan is priced at $1.99 per month for a 12-month period, representing a significant discount from the standard $7.99 rate. This scenario uses a recurring monthly charge with a specific discount applied for the duration of the student status. After 12 months, the price is expected to revert to the standard rate unless re-verified. Revenue is recognized monthly based on the discounted transaction price. This tests promotional pricing and term-limited discounts.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 1.83\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 1.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 1.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 1.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 2.03\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 1.96\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Peacock Premium (Student Discounted)\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 23.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 2.03\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for straight-line recognition.\",\n    \"Sum of monthly amounts equals Ext Allocated Price ($23.88).\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-peacock-24",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:12:34.831Z"
      }
    },
    {
      "id": "6d7a6b7d-06c4-4c0e-ac7e-81834db3f422",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Spotify\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 1,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Standard monthly subscription for music streaming services.); Usage: POB=consumption release=as_used (Top-up hours are recognized as the customer consumes the additional 10-hour block.)\",\n  \"use_case_description\": \"A consumer subscribes to the Spotify Premium Individual plan at a recurring rate of $11.99 per month. In the middle of the first billing cycle, the user exhausts their 15-hour audiobook allotment and purchases an 'Audiobook Top-up' for a one-time fee of $12.99, which provides an additional 10 hours of listening time. The subscription revenue is recognized ratably over the monthly term. The top-up fee is treated as consumption-based revenue, recognized as the additional hours are used or at the end of the billing cycle if unused. This scenario tests the handling of recurring subscriptions alongside ad-hoc one-time usage purchases.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-01-31\",\n      \"Ext Allocated Price\": 11.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 11.99\n    },\n    {\n      \"Line Item Num\": 2,\n      \"POB Name\": \"Audiobook Top-up Prepayment\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-15\",\n      \"Revenue End Date\": \"2026-01-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 0\n    },\n    {\n      \"Line Item Num\": 3,\n      \"POB Name\": \"Audiobook Top-up Drawdown\",\n      \"Event Name\": \"Upon Consumption\",\n      \"Revenue Start Date\": \"2026-01-15\",\n      \"Revenue End Date\": \"2026-01-31\",\n      \"Ext Allocated Price\": 0,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 0\n    }\n  ],\n  \"assumptions\": [\n    \"Line 1 recognized ratably over the service period (31 days in Jan-26) using the BK-OT-RATABLE template.\",\n    \"Lines 2 and 3 follow the EVT-PIT-CONSUMP-USAGE template which is event-driven; revenue is only recognized when consumption occurs.\",\n    \"Per learned correction RR-005, Ext Allocated Price for event-driven lines is set to 0 in the waterfall as no usage data was provided to measure variable consideration/revenue.\"\n  ],\n  \"open_questions\": [\n    \"Please provide the consumption/usage schedule or units consumed for the Audiobook Top-up (Lines 2 and 3) to calculate the recognized revenue amount.\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-spotify-25",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:17:07.530Z"
      }
    },
    {
      "id": "3075f3d9-6ef8-4101-9004-42300b13f1df",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Spotify\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Revenue allocated to the Spotify music service component.); Subscription: POB=over_time release=ratable_over_term (Revenue allocated to the Hulu video service component.)\",\n  \"use_case_description\": \"A verified university student signs up for the Spotify Premium Student bundle at $5.99 per month. This bundle includes two distinct services: Spotify Premium (standalone list price $11.99) and Hulu Ad-supported (standalone list price $7.99). Because the $5.99 transaction price is significantly lower than the $19.98 total standalone selling price (SSP), Zuora Revenue must allocate the $5.99 across two performance obligations (POBs). Both the Spotify and Hulu components are recognized ratably over the monthly service period. The contract is set for a 12-month term, coinciding with the student's annual verification requirement.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Spotify Premium Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3.59,\n      \"Amount\": 3.59,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Hulu Ad-Supported Component\",\n      \"Rate Plan\": \"Student Bundle (Spotify & Hulu)\",\n      \"Product\": \"Spotify Premium Student\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 2.4,\n      \"Amount\": 2.4,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"The $5.99 monthly bundle price is allocated between Spotify ($3.59) and Hulu ($2.40) based on their relative Standalone Selling Prices ($11.99 and $7.99 respectively) to facilitate revenue recognition alignment in Zuora Billing.\",\n    \"Billing is set to Monthly InAdvance, resulting in 12 monthly invoices generated on the first of each month.\",\n    \"The 12-month term is fixed and aligns with the annual student verification requirement.\"\n  ],\n  \"open_questions\": [\n    \"Should the bundle be billed as a single line item of $5.99 on the invoice for the customer, with allocation happening only in Zuora Revenue, or should the invoice reflect the split components as shown here?\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 71.88,\n    \"schedule_total\": 71.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-spotify-26",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:21:08.165Z"
      }
    },
    {
      "id": "ce70cbf9-c5db-41d4-8b2a-7bc4cd2fe5ed",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Monthly subscription fee for digital content access is recognized ratably over the billing period.)\",\n  \"use_case_description\": \"A standard consumer signs up for the YouTube Premium Individual plan via the website. The subscription is billed monthly at $13.99 and provides ad-free video, background play, and YouTube Music Premium access. This is a high-volume, low-touch transaction typical of YouTube's direct-to-consumer model. The contract is evergreen but modeled here as a 12-month term for demo purposes. Revenue is recognized ratably over each monthly service period as the service is delivered to the user.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 12,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"YouTube Premium Individual - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Monthly Subscription Fee\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 13.99,\n      \"Unit Sell Price\": 13.99,\n      \"Ext List Price\": 167.88,\n      \"Ext Sell Price\": 167.88,\n      \"SSP Price\": 13.99,\n      \"Ext SSP Price\": 167.88,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 167.88,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": false,\n      \"Unreleased Revenue\": 167.88,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"YouTube Premium\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Digital Media\",\n      \"Product Family\": \"Streaming\"\n    }\n  ],\n  \"assumptions\": [\n    \"Ordered Qty is 12 to reflect the 12 monthly periods in the demo term.\",\n    \"is_allocations is false, so Ext Allocated Price equals Ext Sell Price without redistribution.\",\n    \"SSP Price is set equal to the Unit List Price of $13.99.\",\n    \"Revenue recognition is ratable over the 12-month term starting 2026-01-01.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if the high-volume consumer transactions are grouped by individual user or aggregated by batch for Revenue Contract creation.\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-28",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:48:14.603Z"
      }
    },
    {
      "id": "99851ea8-7c6e-4b6b-9289-4e9377cf225c",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Monthly subscription fee for digital content access is recognized ratably over the billing period.)\",\n  \"use_case_description\": \"A standard consumer signs up for the YouTube Premium Individual plan via the website. The subscription is billed monthly at $13.99 and provides ad-free video, background play, and YouTube Music Premium access. This is a high-volume, low-touch transaction typical of YouTube's direct-to-consumer model. The contract is evergreen but modeled here as a 12-month term for demo purposes. Revenue is recognized ratably over each monthly service period as the service is delivered to the user.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"Individual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 13.99,\n      \"Amount\": 13.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to In Advance as per Contract Intel, resulting in invoices generated on the first day of each service period.\",\n    \"The subscription is modeled as a 12-month termed contract for demo purposes, despite being evergreen in practice.\",\n    \"No free trial period was specified in the input; billing starts immediately on 01/01/2026.\"\n  ],\n  \"open_questions\": [\n    \"Does this customer qualify for a standard YouTube Premium 1-month or 3-month free trial? If so, the first invoice(s) would have a $0.00 amount.\",\n    \"Are there any family plan members or student verifications that would alter the monthly unit price?\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 167.88,\n    \"schedule_total\": 167.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-28",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:48:37.531Z"
      }
    },
    {
      "id": "22270cf5-e2f3-4eb6-a1f6-819f03052547",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Monthly subscription fee for digital content access is recognized ratably over the billing period.)\",\n  \"use_case_description\": \"A standard consumer signs up for the YouTube Premium Individual plan via the website. The subscription is billed monthly at $13.99 and provides ad-free video, background play, and YouTube Music Premium access. This is a high-volume, low-touch transaction typical of YouTube's direct-to-consumer model. The contract is evergreen but modeled here as a 12-month term for demo purposes. Revenue is recognized ratably over each monthly service period as the service is delivered to the user.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 12.88\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 13.8\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 13.8\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 13.8\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 14.26\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 13.8\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 167.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 14.24\n    }\n  ],\n  \"assumptions\": [\n    \"Daily rate calculated as $167.88 / 365 days = $0.459945 per day.\",\n    \"Monthly amounts calculated by multiplying daily rate by days in month.\",\n    \"Rounding adjustment of -$0.02 applied to Dec-26 to ensure the total recognized sum equals the Ext Allocated Price of $167.88.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-28",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T11:56:24.763Z"
      }
    },
    {
      "id": "0d872229-2f8b-4789-bca5-d1008835f884",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Upfront annual payment is recognized ratably over the 12-month contract term.)\",\n  \"use_case_description\": \"A user opts for the YouTube Premium Individual Annual plan to take advantage of the 15% discount compared to monthly billing. The customer pays a single upfront amount of $139.99 for a fixed 12-month term. This plan provides the same benefits as the monthly individual plan but is billed once at the start of the year. Although payment is collected upfront, the revenue must be deferred and recognized ratably over the 12-month service period. This scenario demonstrates Zuora's ability to manage annual billing with monthly revenue amortization.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Individual Annual Subscription Fee\",\n      \"Rate Plan\": \"Individual Annual Plan\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 139.99,\n      \"Amount\": 139.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing timing is set to InAdvance, meaning the invoice is generated on the service start date.\",\n    \"The 15% discount mentioned in the use case is already reflected in the $139.99 flat fee price.\",\n    \"The subscription is for a fixed 12-month term with a single annual billing event.\",\n    \"Revenue recognition/amortization is handled via Zuora Revenue and does not impact the Billing Schedule amounts.\"\n  ],\n  \"open_questions\": [\n    \"Confirm if any taxes are applicable to the $139.99 amount, as the current schedule reflects the pre-tax net amount.\",\n    \"Confirm if there are any additional one-time setup fees or trial periods not specified in the subscription spec.\"\n  ],\n  \"totals\": {\n    \"target_tcv\": 139.99,\n    \"schedule_total\": 139.99,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-29",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T12:08:26.873Z"
      }
    },
    {
      "id": "665242a5-a1b0-48f5-a279-dc096b4281a3",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Upfront annual payment is recognized ratably over the 12-month contract term.)\",\n  \"use_case_description\": \"A user opts for the YouTube Premium Individual Annual plan to take advantage of the 15% discount compared to monthly billing. The customer pays a single upfront amount of $139.99 for a fixed 12-month term. This plan provides the same benefits as the monthly individual plan but is billed once at the start of the year. Although payment is collected upfront, the revenue must be deferred and recognized ratably over the 12-month service period. This scenario demonstrates Zuora's ability to manage annual billing with monthly revenue amortization.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 10.74\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"May-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 11.89\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 11.51\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Individual Annual Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 139.99,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 11.87\n    }\n  ],\n  \"assumptions\": [\n    \"Daily proration method used for ratable recognition.\",\n    \"The final month (Dec-26) includes a $0.02 rounding adjustment to reconcile the sum of periods to the total Ext Allocated Price of $139.99.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-29",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T12:08:50.364Z"
      }
    },
    {
      "id": "2faa2248-65de-4c7a-b236-1704520865c7",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Flat monthly fee for family access is recognized ratably over the month.)\",\n  \"use_case_description\": \"A household head subscribes to the YouTube Premium Family plan to provide ad-free access for up to 6 family members. The plan is priced at a flat recurring fee of $22.99 per month. The billing is consolidated to a single payment method managed by the primary account holder. All members receive the full suite of Premium features including YouTube Music. Revenue recognition follows a standard ratable pattern over the monthly billing cycle, as the performance obligation is the provision of access to the family group.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Monthly Subscription Fee\",\n      \"Rate Plan\": \"YouTube Premium Family\",\n      \"Product\": \"YouTube Premium\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 22.99,\n      \"Amount\": 22.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"assumptions\": [\n    \"Billing is performed InAdvance on the 1st of each month\",\n    \"No proration is required as the service start date aligns with the first of the month\",\n    \"Target TCV is calculated as 12 months of the flat recurring fee ($22.99 * 12)\"\n  ],\n  \"open_questions\": [],\n  \"totals\": {\n    \"target_tcv\": 275.88,\n    \"schedule_total\": 275.88,\n    \"delta\": 0\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-30",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T12:16:33.120Z"
      }
    },
    {
      "id": "fd5db47f-a401-4286-956c-3054d924dc09",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"YouTube Premium\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"rev_rec_notes\": \"Subscription: POB=over_time release=ratable_over_term (Flat monthly fee for family access is recognized ratably over the month.)\",\n  \"use_case_description\": \"A household head subscribes to the YouTube Premium Family plan to provide ad-free access for up to 6 family members. The plan is priced at a flat recurring fee of $22.99 per month. The billing is consolidated to a single payment method managed by the primary account holder. All members receive the full suite of Premium features including YouTube Music. Revenue recognition follows a standard ratable pattern over the monthly billing cycle, as the performance obligation is the provision of access to the family group.\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 21.16\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Mar-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Apr-26\",\n      \"Amount\": 22.68\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"May-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Jun-26\",\n      \"Amount\": 22.68\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Jul-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Aug-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Sep-26\",\n      \"Amount\": 22.68\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Oct-26\",\n      \"Amount\": 23.43\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Nov-26\",\n      \"Amount\": 22.68\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Monthly Subscription Fee\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 275.88,\n      \"Period\": \"Dec-26\",\n      \"Amount\": 23.42\n    }\n  ],\n  \"assumptions\": [\n    \"Revenue recognized ratably over the 365-day contract term (non-leap year) using daily proration.\",\n    \"Daily rate calculated as $275.88 / 365 days = $0.7558356164.\",\n    \"The final period (Dec-26) includes a rounding adjustment of -$0.01 to ensure the total recognized amount equals the Ext Allocated Price.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "gen-youtube-premium-30",
        "model": "gemini-3-flash-preview",
        "run_id": "67f65a0a-0fe8-4793-baa1-27d4b5501ac7",
        "created_at": "2025-12-31T12:17:03.038Z"
      }
    },
    {
      "id": "799bcbd0-b63b-482b-a405-025a46548d34",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Acme Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Standard SaaS subscription:\\n- $100/month for enterprise software\\n- Monthly billing in advance\\n- 12-month commitment\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Enterprise Software Subscription\",\n      \"Rate Plan\": \"Enterprise Software - Monthly\",\n      \"Product\": \"Enterprise Software\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is fixed-fees-only (no usage charges) and equals $100/month × 12 months = $1,200.\",\n    \"Monthly billing periods align to calendar months from 01/01/2025 through 12/31/2025 (no proration needed).\",\n    \"Billing Timing is InAdvance, so each month’s invoice is dated on the period start date and covers service through the period end date.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "simple-recurring-12mo",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:31:15.587Z"
      }
    },
    {
      "id": "29abffe9-3479-4cc8-840f-a07ef052bd8d",
      "step_name": "design_subscription",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Solution Architect designing a complete billing and revenue solution. You will create:\n1. **Zuora Billing Subscription** — rate plans, charges, dates, terms\n2. **Zuora Revenue POB Mappings** — template assignments for each charge\n\nBy designing both together, you ensure billing structures align with rev rec requirements and catch mismatches early.\n\n**CRITICAL CONSTRAINT**: You can ONLY use POB identifiers from the \"Available ZR POB templates\" list provided. NEVER invent identifiers.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contract dates** — serviceStart, serviceEnd, termMonths (authoritative)\n- **Billing config** — period, timing, trigger event\n- **Allocations flag** — is_allocations (true/false)\n- **Golden use cases** — matched reference patterns\n- **Reference data** — example subscriptions and charges\n- **POB templates** — the ONLY valid identifiers to use\n\n---\n\n## STEP 1: Design Charges\n\n### Charge Type Decision Tree\n\n```\nIs it a one-time fee?\n  ├─ YES → type: \"OneTime\", model: \"FlatFee\"\n  │        billingPeriod: null\n  │        → Skip to STEP 2 for POB\n  │\n  └─ NO → Is it based on usage/consumption?\n          ├─ YES → type: \"Usage\", model varies\n          │        └─ Per unit? → model: \"PerUnit\"\n          │        └─ Tiered? → model: \"Tiered\"\n          │        └─ Overage? → model: \"Overage\"\n          │        → Skip to STEP 2 for POB\n          │\n          └─ NO → type: \"Recurring\"\n                  └─ Flat amount? → model: \"FlatFee\"\n                  └─ Per seat/unit? → model: \"PerUnit\"\n                  └─ Volume-based? → model: \"Volume\"\n                  → Skip to STEP 2 for POB\n```\n\n### Charge Fields Required\n\n| Field | Recurring | OneTime | Usage |\n|-------|-----------|---------|-------|\n| name | ✓ | ✓ | ✓ |\n| type | \"Recurring\" | \"OneTime\" | \"Usage\" |\n| model | FlatFee/PerUnit/Volume/Tiered | FlatFee | PerUnit/Tiered/Overage |\n| billingPeriod | Month/Quarter/Annual/Semi-Annual | null | Month (rating period) |\n| billingTiming | InAdvance/InArrears | null | InArrears |\n| triggerEvent | ContractEffective | ContractEffective | ContractEffective |\n| quantity | number or null | number or null | null (from usage) |\n| listPrice | $ | $ | $ per unit |\n| sellPrice | $ | $ | $ per unit |\n| effectiveStartDate | MM/DD/YYYY | MM/DD/YYYY | MM/DD/YYYY |\n| effectiveEndDate | MM/DD/YYYY or null | null | MM/DD/YYYY or null |\n\n### Usage Records Generation\n\n**If any Usage charges are present, you MUST generate sample usage records within the subscription term.**\n\nUsage records should:\n- Fall within the charge's effective date range\n- Use the charge's UOM\n- Include realistic quantities based on the use case context\n- Cover multiple periods if the subscription spans multiple billing cycles\n\nExample usage record:\n```json\n{\n  \"chargeName\": \"API Calls\",\n  \"startDate\": \"2026-01-01\",\n  \"endDate\": \"2026-01-31\",\n  \"quantity\": 50000,\n  \"uom\": \"API Call\"\n}\n```\n\n### CRITICAL: Charge Segmentation for Price Changes\n\n**When prices change during the term, create SEPARATE charges for each period.**\n\nPatterns requiring segmentation:\n- Year-over-year ramps (\"Year 1: $100, Year 2: $120\")\n- Introductory pricing (\"First 3 months $15, then $20\")\n- Promotional periods (\"50% off for 6 months\")\n\n**Example:** 12-month contract, $15/mo for months 1-3, $20/mo for months 4-12\n```\nCharge 1: \"Service - Promo\", start: 01/01/2026, end: 03/31/2026, sellPrice: 15\nCharge 2: \"Service - Standard\", start: 04/01/2026, end: 12/31/2026, sellPrice: 20\n```\n\n**DO NOT average prices into a single charge. Each distinct price = separate charge.**\n\n---\n\n## STEP 2: Assign POB Templates\n\nFor EACH charge you created, assign a POB template from the provided list.\n\n### POB Selection Matrix\n\n| Charge Type | Billing Timing | Recognition | → POB Identifier |\n|-------------|---------------|-------------|------------------|\n| Recurring | InAdvance | Over time (standard SaaS) | `BK-OT-RATABLE` |\n| Recurring | InAdvance | Over time with VC | `BK-OT-CONSUMP-RATABLE-VC` |\n| Recurring | InArrears | Over time (invoice ratable) | `BL-OT-INVRATABLE` |\n| OneTime | — | Immediate at booking (start date) | `BK-PIT-STARTDATE` |\n| OneTime | — | Immediate at booking (current period) | `BK-PIT-CURRENT_PERIOD` |\n| OneTime | — | Immediate at billing (start date) | `BL-PIT-STARTDATE` |\n| OneTime | — | Immediate at billing (current period) | `BL-PIT-CURRENT_PERIOD` |\n| OneTime | — | Spread over term | `BK-OT-RATABLE` |\n| OneTime | — | Upon acceptance | `EVT-PIT-ACCEPTAN` |\n| OneTime | — | Upon go-live | `EVT-OT-RATABLE-GOLIVE` |\n| Usage | — | Upon consumption event | `EVT-PIT-CONSUMP-USAGE` |\n| Usage | — | Upon billing | `BL-PIT-CONSUMP-PAYGO` |\n\n### POB Identifier Naming Convention\n\n| Prefix | Meaning |\n|--------|---------|\n| `BK-` | Release upon Booking |\n| `BL-` | Release upon Billing |\n| `EVT-` | Release upon Event |\n| `-OT-` | Over Time (ratable) |\n| `-PIT-` | Point In Time (immediate) |\n\n---\n\n## Special Patterns\n\n### Prepay Drawdown (PPDD)\n\nWhen the use case involves prepaid credits:\n\n| Charge | Type | Model | POB |\n|--------|------|-------|-----|\n| Prepayment | OneTime or Recurring | FlatFee | See below |\n| Drawdown | Usage | PerUnit | `EVT-PIT-CONSUMP-USAGE` |\n| Overage (optional) | Usage | PerUnit | `BL-PIT-CONSUMP-PAYGO` |\n\n**PPDD POB Decision:**\n- \"Recognize ratably over time\" → Prepayment uses `BK-OT-CONSUMP-RATABLE`\n- \"Recognize as credits consumed\" → Prepayment stays deferred, Drawdown triggers recognition via `EVT-PIT-CONSUMP-USAGE`\n\n⚠️ **Critical distinction:** If the use case says revenue is recognized \"as credits are consumed\", \"upon consumption\", or \"as-used\":\n- Do NOT use a ratable template for the prepayment\n- Prepayment revenue stays deferred until consumption occurs\n- The Drawdown charge's consumption events trigger actual recognition\n- Revenue waterfall for prepayment shows $0 until usage posts\n\n**IMPORTANT:** When PPDD charges are present, you MUST generate usage records for the Drawdown charge showing credit consumption events during the subscription term.\n\n### Contract Amendments\n\n**Retrospective (same POB, price/qty change):**\n- Original charge: shorten end date to mod_date - 1\n- New charge: from mod_date to original end\n\n**Prospective (new POB added):**\n- Original charge: unchanged\n- New charge: separate for new deliverable\n\n### Bundle Explosion\n\nWhen one billing line has multiple POBs:\n- Create ONE charge in billing\n- Note in assumptions: \"Bundle explosion applies\"\n- List child components and their POBs in assumptions\n\n---\n\n## Output\n\nReturn JSON with complete structure. Every charge MUST have a corresponding POB mapping.\n\n```json\n{\n  \"subscription\": {\n    \"name\": \"Customer Name - Subscription\",\n    \"termType\": \"TERMED\",\n    \"status\": \"Active\",\n    \"currency\": \"USD\",\n    \"contractEffectiveDate\": \"MM/DD/YYYY\",\n    \"serviceActivationDate\": \"MM/DD/YYYY\",\n    \"customerAcceptanceDate\": \"MM/DD/YYYY\",\n    \"subscriptionStartDate\": \"MM/DD/YYYY\",\n    \"subscriptionEndDate\": \"MM/DD/YYYY or null\",\n    \"initialTerm\": 12,\n    \"initialTermPeriodType\": \"Month\",\n    \"renewalTerm\": 12,\n    \"renewalTermPeriodType\": \"Month\",\n    \"autoRenew\": true\n  },\n  \"rate_plans\": [\n    {\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"charges\": [\n        {\n          \"name\": \"Charge Name\",\n          \"type\": \"Recurring\",\n          \"model\": \"FlatFee\",\n          \"uom\": null,\n          \"billingPeriod\": \"Month\",\n          \"billingTiming\": \"InAdvance\",\n          \"billingDay\": null,\n          \"billingPeriodAlignment\": null,\n          \"listPriceBase\": null,\n          \"triggerEvent\": \"ContractEffective\",\n          \"specificTriggerDate\": null,\n          \"endDateCondition\": null,\n          \"specificEndDate\": null,\n          \"quantity\": 1,\n          \"listPrice\": 100,\n          \"sellPrice\": 100,\n          \"price\": 100,\n          \"effectiveStartDate\": \"MM/DD/YYYY\",\n          \"effectiveEndDate\": \"MM/DD/YYYY or null\",\n          \"chargeFunction\": null,\n          \"isAllocationEligible\": true,\n          \"drawdownType\": null,\n          \"commitmentType\": null,\n          \"prepaymentUOM\": null,\n          \"prepaymentUnits\": null,\n          \"validityPeriod\": null\n        }\n      ]\n    }\n  ],\n  \"usage\": [\n    {\n      \"chargeName\": \"API Calls\",\n      \"startDate\": \"2026-01-01\",\n      \"endDate\": \"2026-01-31\",\n      \"quantity\": 50000,\n      \"uom\": \"API Call\"\n    }\n  ],\n  \"charge_pob_map\": [\n    {\n      \"chargeName\": \"Charge Name\",\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"pob_identifier\": \"BK-OT-RATABLE\",\n      \"pob_name\": \"Template Name\",\n      \"ratable_method\": \"Ratable\",\n      \"release_event\": \"Upon Booking (Full Booking Release)\",\n      \"recognition_window\": {\n        \"start\": \"YYYY-MM-DD\",\n        \"end\": \"YYYY-MM-DD or null\"\n      },\n      \"rationale\": \"Standard SaaS recurring - release at booking, recognize ratably over term\",\n      \"confidence\": 0.95,\n      \"alternatives\": []\n    }\n  ],\n  \"assumptions\": [\"List key assumptions made\"],\n  \"open_questions\": [\"Questions needing customer clarification\"],\n  \"mapping_notes\": [\"POB-specific notes if any\"]\n}\n```\n\n---\n\n## Reference Documentation\n\n- Subscriptions: https://docs.zuora.com/en/zuora-billing/manage-orders/order-actions/create-subscriptions\n- Rate Plan Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/product-catalog-configurations/create-product-rate-plan-charges\n- Tiered Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-pricing\n- Volume Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/volume-pricing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion\n- POB Templates: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/create-pob-template\n- POB Ratable Methods: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/predefined-pob-ratable-methods"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mint Mobile\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Mint Mobile wireless plan:\\n- 3 months at $15/month introductory rate\\n- 9 months at $20/month standard rate\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"subscription_spec\": {\n    \"subscription\": {\n      \"name\": \"Mint Mobile - Wireless Plan (12M)\",\n      \"termType\": \"TERMED\",\n      \"status\": \"Active\",\n      \"currency\": \"USD\",\n      \"contractEffectiveDate\": \"01/01/2026\",\n      \"serviceActivationDate\": \"01/01/2026\",\n      \"customerAcceptanceDate\": \"01/01/2026\",\n      \"subscriptionStartDate\": \"01/01/2026\",\n      \"subscriptionEndDate\": \"12/31/2026\",\n      \"initialTerm\": 12,\n      \"initialTermPeriodType\": \"Month\",\n      \"renewalTerm\": 12,\n      \"renewalTermPeriodType\": \"Month\",\n      \"autoRenew\": false\n    },\n    \"rate_plans\": [\n      {\n        \"productName\": \"Mint Mobile Wireless Service\",\n        \"ratePlanName\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n        \"charges\": [\n          {\n            \"name\": \"Wireless Service - Intro Rate (Months 1-3)\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default from subscription start day\",\n            \"billingPeriodAlignment\": \"AlignToCharge\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2026\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"03/31/2026\",\n            \"quantity\": 1,\n            \"listPrice\": 15,\n            \"sellPrice\": 15,\n            \"price\": 15,\n            \"effectiveStartDate\": \"01/01/2026\",\n            \"effectiveEndDate\": \"03/31/2026\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          },\n          {\n            \"name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default from subscription start day\",\n            \"billingPeriodAlignment\": \"AlignToCharge\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"04/01/2026\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"12/31/2026\",\n            \"quantity\": 1,\n            \"listPrice\": 20,\n            \"sellPrice\": 20,\n            \"price\": 20,\n            \"effectiveStartDate\": \"04/01/2026\",\n            \"effectiveEndDate\": \"12/31/2026\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          }\n        ]\n      }\n    ],\n    \"usage\": [],\n    \"assumptions\": [\n      \"Ramp pricing is implemented via charge segmentation: separate recurring charges for 01/01/2026–03/31/2026 at $15 and 04/01/2026–12/31/2026 at $20 (no averaging).\",\n      \"No allocations are required (isAllocationEligible=false) as per input.\",\n      \"Billing is monthly in advance with billing dates aligned to subscription start day.\",\n      \"No usage, prepayment/drawdown, activation/acceptance milestones, or deliverable-based events are required for revenue recognition in this use case.\"\n    ],\n    \"open_questions\": [\n      \"Should the subscription auto-renew after 12/31/2026, and if so, should the renewal price be $20/month or a different rate plan?\",\n      \"Do you require mid-cycle proration rules (e.g., if a customer starts/changes service on a day other than the 1st)?\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Wireless Service - Intro Rate (Months 1-3)\",\n        \"productName\": \"Mint Mobile Wireless Service\",\n        \"ratePlanName\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2026-01-01\",\n          \"end\": \"2026-03-31\"\n        },\n        \"rationale\": \"Monthly recurring service billed in advance; recognize revenue ratably over the period of service for the intro-rate segment.\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would release upon billing (billed release). This use case provides booking-driven rev release and standard ratable recognition for a billed-in-advance subscription.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Wireless Service - Standard Rate (Months 4-12)\",\n        \"productName\": \"Mint Mobile Wireless Service\",\n        \"ratePlanName\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2026-04-01\",\n          \"end\": \"2026-12-31\"\n        },\n        \"rationale\": \"Monthly recurring service billed in advance; recognize revenue ratably over the period of service for the standard-rate segment.\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would release upon billing. For a straightforward subscription with defined service periods, booking-based ratable is typically used to align booking to service delivery.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Both segments map to the same Zuora Revenue POB template (BK-OT-RATABLE); the price ramp is handled by separate charge date ranges (segmentation).\",\n      \"Recognition windows are set to each segmented charge’s effective service period to support clean ramp reporting in revenue schedules.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mint-mobile-intro-pricing",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:34:11.303Z"
      }
    },
    {
      "id": "2ebc187a-9273-4bcd-a1a8-feaa06762cc8",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mint Mobile\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Mint Mobile wireless plan:\\n- 3 months at $15/month introductory rate\\n- 9 months at $20/month standard rate\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Wireless Service - Intro Rate (Months 1-3)\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 3,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Mint Mobile - Wireless Plan (12M)\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2026\",\n        \"RPC Segment\": \"Wireless Service - Intro Rate (Months 1-3)\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2026-01-01\",\n        \"Revenue End Date\": \"2026-03-31\",\n        \"Unit List Price\": 15,\n        \"Unit Sell Price\": 15,\n        \"Ext List Price\": 45,\n        \"Ext Sell Price\": 45,\n        \"SSP Price\": 15,\n        \"Ext SSP Price\": 45,\n        \"SSP Percent\": 20,\n        \"Ext Allocated Price\": 45,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 45,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Mint Mobile\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Telecom Services\",\n        \"Product Family\": \"Wireless Service\"\n      },\n      {\n        \"POB Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 9,\n        \"Line Item Num\": 2,\n        \"Subscription Name\": \"Mint Mobile - Wireless Plan (12M)\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2026\",\n        \"RPC Segment\": \"Wireless Service - Standard Rate (Months 4-12)\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2026-04-01\",\n        \"Revenue End Date\": \"2026-12-31\",\n        \"Unit List Price\": 20,\n        \"Unit Sell Price\": 20,\n        \"Ext List Price\": 180,\n        \"Ext Sell Price\": 180,\n        \"SSP Price\": 20,\n        \"Ext SSP Price\": 180,\n        \"SSP Percent\": 80,\n        \"Ext Allocated Price\": 180,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 180,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Mint Mobile\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Telecom Services\",\n        \"Product Family\": \"Wireless Service\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocations flag is FALSE, so Ext Allocated Price equals Ext Sell Price for each line (no SSP-based redistribution).\",\n      \"Unit List Price equals Unit Sell Price (no discounts provided).\",\n      \"For flat-fee ramp segments, Ordered Qty is represented as the number of monthly billing periods in the segment (3 and 9) to produce the correct segment total in Ext Sell Price.\"\n    ],\n    \"open_questions\": [\n      \"Confirm whether Ordered Qty should remain 1 (units) with Ext Sell Price provided as the total contract value per segment (45 and 180) instead of using 3 and 9 as period quantities—this depends on your RC_LINE upload conventions.\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Wireless Service - Intro Rate (Months 1-3)\",\n        \"productName\": \"Mint Mobile Wireless Service\",\n        \"ratePlanName\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2026-01-01\",\n          \"end\": \"2026-03-31\"\n        },\n        \"rationale\": \"Monthly recurring service billed in advance; recognize revenue ratably over the period of service for the intro-rate segment.\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would release upon billing (billed release). This use case provides booking-driven rev release and standard ratable recognition for a billed-in-advance subscription.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Wireless Service - Standard Rate (Months 4-12)\",\n        \"productName\": \"Mint Mobile Wireless Service\",\n        \"ratePlanName\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2026-04-01\",\n          \"end\": \"2026-12-31\"\n        },\n        \"rationale\": \"Monthly recurring service billed in advance; recognize revenue ratably over the period of service for the standard-rate segment.\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would release upon billing. For a straightforward subscription with defined service periods, booking-based ratable is typically used to align booking to service delivery.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Both segments map to the same Zuora Revenue POB template (BK-OT-RATABLE); the price ramp is handled by separate charge date ranges (segmentation).\",\n      \"Recognition windows are set to each segmented charge’s effective service period to support clean ramp reporting in revenue schedules.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mint-mobile-intro-pricing",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:34:41.165Z"
      }
    },
    {
      "id": "f37fd7bf-0236-43ef-b8ad-c1673170171f",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mint Mobile\",\n  \"contract_start_date\": \"01/01/2026\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Mint Mobile wireless plan:\\n- 3 months at $15/month introductory rate\\n- 9 months at $20/month standard rate\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Wireless Service - Intro Rate (Months 1-3)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Wireless Service - Intro Rate (Months 1-3)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Wireless Service - Intro Rate (Months 1-3)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 15,\n      \"Amount\": 15,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Wireless Service - Standard Rate (Months 4-12)\",\n      \"Rate Plan\": \"Mint Mobile Wireless Plan - Monthly (Intro + Standard Ramp)\",\n      \"Product\": \"Mint Mobile Wireless Service\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 20,\n      \"Amount\": 20,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 225,\n    \"schedule_total\": 225,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is fixed-fees-only (no usage components) for the 12-month termed subscription term 01/01/2026–12/31/2026.\",\n    \"Monthly periods align to calendar months (no proration needed because service starts on 01/01/2026 and ends on 12/31/2026).\",\n    \"The intro ($15) and standard ($20) prices are modeled as two separate recurring flat-fee charges with effective dates that cover months 1–3 and 4–12 respectively.\",\n    \"Billing timing is InAdvance, so Billing Date (and Invoice Date) equals the billing period start date for each monthly period.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mint-mobile-intro-pricing",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:35:10.823Z"
      }
    },
    {
      "id": "c06611fc-59f7-4d9d-ad0f-239043cbdff5",
      "step_name": "design_subscription",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Solution Architect designing a complete billing and revenue solution. You will create:\n1. **Zuora Billing Subscription** — rate plans, charges, dates, terms\n2. **Zuora Revenue POB Mappings** — template assignments for each charge\n\nBy designing both together, you ensure billing structures align with rev rec requirements and catch mismatches early.\n\n**CRITICAL CONSTRAINT**: You can ONLY use POB identifiers from the \"Available ZR POB templates\" list provided. NEVER invent identifiers.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contract dates** — serviceStart, serviceEnd, termMonths (authoritative)\n- **Billing config** — period, timing, trigger event\n- **Allocations flag** — is_allocations (true/false)\n- **Golden use cases** — matched reference patterns\n- **Reference data** — example subscriptions and charges\n- **POB templates** — the ONLY valid identifiers to use\n\n---\n\n## STEP 1: Design Charges\n\n### Charge Type Decision Tree\n\n```\nIs it a one-time fee?\n  ├─ YES → type: \"OneTime\", model: \"FlatFee\"\n  │        billingPeriod: null\n  │        → Skip to STEP 2 for POB\n  │\n  └─ NO → Is it based on usage/consumption?\n          ├─ YES → type: \"Usage\", model varies\n          │        └─ Per unit? → model: \"PerUnit\"\n          │        └─ Tiered? → model: \"Tiered\"\n          │        └─ Overage? → model: \"Overage\"\n          │        → Skip to STEP 2 for POB\n          │\n          └─ NO → type: \"Recurring\"\n                  └─ Flat amount? → model: \"FlatFee\"\n                  └─ Per seat/unit? → model: \"PerUnit\"\n                  └─ Volume-based? → model: \"Volume\"\n                  → Skip to STEP 2 for POB\n```\n\n### Charge Fields Required\n\n| Field | Recurring | OneTime | Usage |\n|-------|-----------|---------|-------|\n| name | ✓ | ✓ | ✓ |\n| type | \"Recurring\" | \"OneTime\" | \"Usage\" |\n| model | FlatFee/PerUnit/Volume/Tiered | FlatFee | PerUnit/Tiered/Overage |\n| billingPeriod | Month/Quarter/Annual/Semi-Annual | null | Month (rating period) |\n| billingTiming | InAdvance/InArrears | null | InArrears |\n| triggerEvent | ContractEffective | ContractEffective | ContractEffective |\n| quantity | number or null | number or null | null (from usage) |\n| listPrice | $ | $ | $ per unit |\n| sellPrice | $ | $ | $ per unit |\n| effectiveStartDate | MM/DD/YYYY | MM/DD/YYYY | MM/DD/YYYY |\n| effectiveEndDate | MM/DD/YYYY or null | null | MM/DD/YYYY or null |\n\n### Usage Records Generation\n\n**If any Usage charges are present, you MUST generate sample usage records within the subscription term.**\n\nUsage records should:\n- Fall within the charge's effective date range\n- Use the charge's UOM\n- Include realistic quantities based on the use case context\n- Cover multiple periods if the subscription spans multiple billing cycles\n\nExample usage record:\n```json\n{\n  \"chargeName\": \"API Calls\",\n  \"startDate\": \"2026-01-01\",\n  \"endDate\": \"2026-01-31\",\n  \"quantity\": 50000,\n  \"uom\": \"API Call\"\n}\n```\n\n### CRITICAL: Charge Segmentation for Price Changes\n\n**When prices change during the term, create SEPARATE charges for each period.**\n\nPatterns requiring segmentation:\n- Year-over-year ramps (\"Year 1: $100, Year 2: $120\")\n- Introductory pricing (\"First 3 months $15, then $20\")\n- Promotional periods (\"50% off for 6 months\")\n\n**Example:** 12-month contract, $15/mo for months 1-3, $20/mo for months 4-12\n```\nCharge 1: \"Service - Promo\", start: 01/01/2026, end: 03/31/2026, sellPrice: 15\nCharge 2: \"Service - Standard\", start: 04/01/2026, end: 12/31/2026, sellPrice: 20\n```\n\n**DO NOT average prices into a single charge. Each distinct price = separate charge.**\n\n---\n\n## STEP 2: Assign POB Templates\n\nFor EACH charge you created, assign a POB template from the provided list.\n\n### POB Selection Matrix\n\n| Charge Type | Billing Timing | Recognition | → POB Identifier |\n|-------------|---------------|-------------|------------------|\n| Recurring | InAdvance | Over time (standard SaaS) | `BK-OT-RATABLE` |\n| Recurring | InAdvance | Over time with VC | `BK-OT-CONSUMP-RATABLE-VC` |\n| Recurring | InArrears | Over time (invoice ratable) | `BL-OT-INVRATABLE` |\n| OneTime | — | Immediate at booking (start date) | `BK-PIT-STARTDATE` |\n| OneTime | — | Immediate at booking (current period) | `BK-PIT-CURRENT_PERIOD` |\n| OneTime | — | Immediate at billing (start date) | `BL-PIT-STARTDATE` |\n| OneTime | — | Immediate at billing (current period) | `BL-PIT-CURRENT_PERIOD` |\n| OneTime | — | Spread over term | `BK-OT-RATABLE` |\n| OneTime | — | Upon acceptance | `EVT-PIT-ACCEPTAN` |\n| OneTime | — | Upon go-live | `EVT-OT-RATABLE-GOLIVE` |\n| Usage | — | Upon consumption event | `EVT-PIT-CONSUMP-USAGE` |\n| Usage | — | Upon billing | `BL-PIT-CONSUMP-PAYGO` |\n\n### POB Identifier Naming Convention\n\n| Prefix | Meaning |\n|--------|---------|\n| `BK-` | Release upon Booking |\n| `BL-` | Release upon Billing |\n| `EVT-` | Release upon Event |\n| `-OT-` | Over Time (ratable) |\n| `-PIT-` | Point In Time (immediate) |\n\n---\n\n## Special Patterns\n\n### Prepay Drawdown (PPDD)\n\nWhen the use case involves prepaid credits:\n\n| Charge | Type | Model | POB |\n|--------|------|-------|-----|\n| Prepayment | OneTime or Recurring | FlatFee | See below |\n| Drawdown | Usage | PerUnit | `EVT-PIT-CONSUMP-USAGE` |\n| Overage (optional) | Usage | PerUnit | `BL-PIT-CONSUMP-PAYGO` |\n\n**PPDD POB Decision:**\n- \"Recognize ratably over time\" → Prepayment uses `BK-OT-CONSUMP-RATABLE`\n- \"Recognize as credits consumed\" → Prepayment stays deferred, Drawdown triggers recognition via `EVT-PIT-CONSUMP-USAGE`\n\n⚠️ **Critical distinction:** If the use case says revenue is recognized \"as credits are consumed\", \"upon consumption\", or \"as-used\":\n- Do NOT use a ratable template for the prepayment\n- Prepayment revenue stays deferred until consumption occurs\n- The Drawdown charge's consumption events trigger actual recognition\n- Revenue waterfall for prepayment shows $0 until usage posts\n\n**IMPORTANT:** When PPDD charges are present, you MUST generate usage records for the Drawdown charge showing credit consumption events during the subscription term.\n\n### Contract Amendments\n\n**Retrospective (same POB, price/qty change):**\n- Original charge: shorten end date to mod_date - 1\n- New charge: from mod_date to original end\n\n**Prospective (new POB added):**\n- Original charge: unchanged\n- New charge: separate for new deliverable\n\n### Bundle Explosion\n\nWhen one billing line has multiple POBs:\n- Create ONE charge in billing\n- Note in assumptions: \"Bundle explosion applies\"\n- List child components and their POBs in assumptions\n\n---\n\n## Output\n\nReturn JSON with complete structure. Every charge MUST have a corresponding POB mapping.\n\n```json\n{\n  \"subscription\": {\n    \"name\": \"Customer Name - Subscription\",\n    \"termType\": \"TERMED\",\n    \"status\": \"Active\",\n    \"currency\": \"USD\",\n    \"contractEffectiveDate\": \"MM/DD/YYYY\",\n    \"serviceActivationDate\": \"MM/DD/YYYY\",\n    \"customerAcceptanceDate\": \"MM/DD/YYYY\",\n    \"subscriptionStartDate\": \"MM/DD/YYYY\",\n    \"subscriptionEndDate\": \"MM/DD/YYYY or null\",\n    \"initialTerm\": 12,\n    \"initialTermPeriodType\": \"Month\",\n    \"renewalTerm\": 12,\n    \"renewalTermPeriodType\": \"Month\",\n    \"autoRenew\": true\n  },\n  \"rate_plans\": [\n    {\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"charges\": [\n        {\n          \"name\": \"Charge Name\",\n          \"type\": \"Recurring\",\n          \"model\": \"FlatFee\",\n          \"uom\": null,\n          \"billingPeriod\": \"Month\",\n          \"billingTiming\": \"InAdvance\",\n          \"billingDay\": null,\n          \"billingPeriodAlignment\": null,\n          \"listPriceBase\": null,\n          \"triggerEvent\": \"ContractEffective\",\n          \"specificTriggerDate\": null,\n          \"endDateCondition\": null,\n          \"specificEndDate\": null,\n          \"quantity\": 1,\n          \"listPrice\": 100,\n          \"sellPrice\": 100,\n          \"price\": 100,\n          \"effectiveStartDate\": \"MM/DD/YYYY\",\n          \"effectiveEndDate\": \"MM/DD/YYYY or null\",\n          \"chargeFunction\": null,\n          \"isAllocationEligible\": true,\n          \"drawdownType\": null,\n          \"commitmentType\": null,\n          \"prepaymentUOM\": null,\n          \"prepaymentUnits\": null,\n          \"validityPeriod\": null\n        }\n      ]\n    }\n  ],\n  \"usage\": [\n    {\n      \"chargeName\": \"API Calls\",\n      \"startDate\": \"2026-01-01\",\n      \"endDate\": \"2026-01-31\",\n      \"quantity\": 50000,\n      \"uom\": \"API Call\"\n    }\n  ],\n  \"charge_pob_map\": [\n    {\n      \"chargeName\": \"Charge Name\",\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"pob_identifier\": \"BK-OT-RATABLE\",\n      \"pob_name\": \"Template Name\",\n      \"ratable_method\": \"Ratable\",\n      \"release_event\": \"Upon Booking (Full Booking Release)\",\n      \"recognition_window\": {\n        \"start\": \"YYYY-MM-DD\",\n        \"end\": \"YYYY-MM-DD or null\"\n      },\n      \"rationale\": \"Standard SaaS recurring - release at booking, recognize ratably over term\",\n      \"confidence\": 0.95,\n      \"alternatives\": []\n    }\n  ],\n  \"assumptions\": [\"List key assumptions made\"],\n  \"open_questions\": [\"Questions needing customer clarification\"],\n  \"mapping_notes\": [\"POB-specific notes if any\"]\n}\n```\n\n---\n\n## Reference Documentation\n\n- Subscriptions: https://docs.zuora.com/en/zuora-billing/manage-orders/order-actions/create-subscriptions\n- Rate Plan Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/product-catalog-configurations/create-product-rate-plan-charges\n- Tiered Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-pricing\n- Volume Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/volume-pricing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion\n- POB Templates: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/create-pob-template\n- POB Ratable Methods: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/predefined-pob-ratable-methods"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"TechGiant Inc\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Enterprise platform subscription with annual ramp:\\n- Year 1: $1000/month\\n- Year 2: $1200/month (20% increase)\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"subscription_spec\": {\n    \"subscription\": {\n      \"name\": \"TechGiant Inc - Enterprise Platform Subscription\",\n      \"termType\": \"TERMED\",\n      \"status\": \"Active\",\n      \"currency\": \"USD\",\n      \"contractEffectiveDate\": \"01/01/2025\",\n      \"serviceActivationDate\": \"01/01/2025\",\n      \"customerAcceptanceDate\": \"01/01/2025\",\n      \"subscriptionStartDate\": \"01/01/2025\",\n      \"subscriptionEndDate\": \"12/31/2026\",\n      \"initialTerm\": 24,\n      \"initialTermPeriodType\": \"Month\",\n      \"renewalTerm\": 12,\n      \"renewalTermPeriodType\": \"Month\",\n      \"autoRenew\": false\n    },\n    \"rate_plans\": [\n      {\n        \"productName\": \"Enterprise Platform\",\n        \"ratePlanName\": \"Enterprise Platform Subscription (Annual Ramp)\",\n        \"charges\": [\n          {\n            \"name\": \"Platform Subscription - Year 1\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"License\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"Default\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"12/31/2025\",\n            \"quantity\": 1,\n            \"listPrice\": 1000,\n            \"sellPrice\": 1000,\n            \"price\": 1000,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"Default\",\n            \"commitmentType\": \"Default\",\n            \"prepaymentUOM\": \"Default\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"Default\"\n          },\n          {\n            \"name\": \"Platform Subscription - Year 2\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"License\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"Default\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"12/31/2026\",\n            \"quantity\": 1,\n            \"listPrice\": 1200,\n            \"sellPrice\": 1200,\n            \"price\": 1200,\n            \"effectiveStartDate\": \"01/01/2026\",\n            \"effectiveEndDate\": \"12/31/2026\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"Default\",\n            \"commitmentType\": \"Default\",\n            \"prepaymentUOM\": \"Default\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"Default\"\n          }\n        ]\n      }\n    ],\n    \"usage\": [],\n    \"assumptions\": [\n      \"Ramp is implemented via charge segmentation (separate charge intervals) to reflect Year 1 vs Year 2 pricing; this aligns to Zuora Revenue prospective modification behavior for price increases.\",\n      \"Single performance obligation (continuous access to the platform) across both years; no new/different deliverables introduced in Year 2.\",\n      \"Contract Effective Date equals Service Start Date (01/01/2025).\",\n      \"Auto-renew is set to false because an explicit serviceEnd (12/31/2026) was provided; change to true if you want renewal automation.\",\n      \"isAllocationEligible is set to false for all charges because DO ALLOCATIONS = false.\"\n    ],\n    \"open_questions\": [\n      \"Should the subscription be set to autoRenew = true (with a 12-month renewal term) after 12/31/2026, or should it remain non-renewing?\",\n      \"Do you require native Ramps (Ramps feature) for reporting/ramp metrics, or is charge segmentation sufficient for your operational reporting needs?\",\n      \"Are there any one-time implementation / onboarding / setup fees or variable consideration elements that should be included and mapped separately?\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Platform Subscription - Year 1\",\n        \"productName\": \"Enterprise Platform\",\n        \"ratePlanName\": \"Enterprise Platform Subscription (Annual Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Monthly recurring SaaS fee billed in advance; revenue should be released upon booking and recognized ratably over the service period. Year-1 ramp segment is a distinct price interval, so it is mapped and recognized over 2025-01-01 to 2025-12-31.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"This is intended for billed release / invoice-ratable patterns (commonly billing in arrears). Your billing is explicitly monthly in advance with ContractEffective trigger.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Platform Subscription - Year 2\",\n        \"productName\": \"Enterprise Platform\",\n        \"ratePlanName\": \"Enterprise Platform Subscription (Annual Ramp)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2026-01-01\",\n          \"end\": \"2026-12-31\"\n        },\n        \"rationale\": \"Second-year ramp segment with increased monthly fee; same deliverable and revenue policy as Year 1, but a new price interval, so it is segmented and recognized ratably over 2026-01-01 to 2026-12-31.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BK-OT-RATABLE-PM\",\n            \"pob_name\": \"BK-OT-RATABLE-PM\",\n            \"why_not\": \"Not selected because no Project/PM-specific rev policy requirement was provided; standard BK-OT-RATABLE is sufficient for a typical SaaS subscription ramp.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Both ramp segments use the same ZR POB template (BK-OT-RATABLE) because billing is in advance and revenue recognition is over time; only the recognition window and price differ by segment.\",\n      \"If you later process a mid-term price change within a year (e.g., effective 07/01/2026), split that year’s segment again so each distinct price interval is its own charge with its own recognition window.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "annual-ramp-2year",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:39:03.902Z"
      }
    },
    {
      "id": "17e9aec0-a9c8-4436-8be0-44504311ef17",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"TechGiant Inc\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 24,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Enterprise platform subscription with annual ramp:\\n- Year 1: $1000/month\\n- Year 2: $1200/month (20% increase)\\n- Monthly billing in advance\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Platform Subscription - Year 1\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1000,\n      \"Amount\": 1000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2026\",\n      \"Billing Date\": \"02/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"02/01/2026\",\n      \"Billing Period End\": \"02/28/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2026\",\n      \"Billing Date\": \"03/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"03/01/2026\",\n      \"Billing Period End\": \"03/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2026\",\n      \"Billing Date\": \"04/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"04/01/2026\",\n      \"Billing Period End\": \"04/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2026\",\n      \"Billing Date\": \"05/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"05/01/2026\",\n      \"Billing Period End\": \"05/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2026\",\n      \"Billing Date\": \"06/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"06/01/2026\",\n      \"Billing Period End\": \"06/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2026\",\n      \"Billing Date\": \"07/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"07/01/2026\",\n      \"Billing Period End\": \"07/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2026\",\n      \"Billing Date\": \"08/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"08/01/2026\",\n      \"Billing Period End\": \"08/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2026\",\n      \"Billing Date\": \"09/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"09/01/2026\",\n      \"Billing Period End\": \"09/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2026\",\n      \"Billing Date\": \"10/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"10/01/2026\",\n      \"Billing Period End\": \"10/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2026\",\n      \"Billing Date\": \"11/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"11/01/2026\",\n      \"Billing Period End\": \"11/30/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2026\",\n      \"Billing Date\": \"12/01/2026\",\n      \"Charge Name\": \"Platform Subscription - Year 2\",\n      \"Rate Plan\": \"Enterprise Platform Subscription (Annual Ramp)\",\n      \"Product\": \"Enterprise Platform\",\n      \"Billing Period Start\": \"12/01/2026\",\n      \"Billing Period End\": \"12/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 1200,\n      \"Amount\": 1200,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 26400,\n    \"schedule_total\": 26400,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"TCV target is fixed recurring fees only (no usage/overage components provided).\",\n    \"Ramp is modeled as two separate recurring flat-fee charges: Year 1 effective 01/01/2025–12/31/2025 at $1,000/month and Year 2 effective 01/01/2026–12/31/2026 at $1,200/month.\",\n    \"Monthly billing periods align to calendar months; billing timing is InAdvance so Billing Date (and invoice generation) is the period start date.\",\n    \"No proration is required because charge effective dates align with monthly period boundaries.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "annual-ramp-2year",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:40:15.171Z"
      }
    },
    {
      "id": "2fff1662-e460-4dda-9131-986f177fae2d",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Quarterly Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Quarterly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Professional services subscription:\\n- $3000/quarter ($1000/month equivalent)\\n- Quarterly billing in advance\\n- 12-month term\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription Fee\",\n      \"Rate Plan\": \"Professional Services - Quarterly (In Advance)\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription Fee\",\n      \"Rate Plan\": \"Professional Services - Quarterly (In Advance)\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription Fee\",\n      \"Rate Plan\": \"Professional Services - Quarterly (In Advance)\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Professional Services Subscription Fee\",\n      \"Rate Plan\": \"Professional Services - Quarterly (In Advance)\",\n      \"Product\": \"Professional Services\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 3000,\n      \"Amount\": 3000,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 12000,\n    \"schedule_total\": 12000,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is fixed-fees-only (no usage/overage) and equals $3,000 per quarter for 4 quarters = $12,000.\",\n    \"Invoice Date is the same as Billing Date (i.e., invoices are generated on the billing date).\",\n    \"Quarterly periods are aligned to calendar quarters starting from the subscription start date (01/01/2025), with billing in advance on each period start date.\",\n    \"No proration is required because the service start/end dates align exactly to quarter boundaries for a 12-month term.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "quarterly-billing-annual",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:44:29.227Z"
      }
    },
    {
      "id": "9e8b7fae-ff31-49f9-bcc8-0aba438389a7",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Bundle Customer\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Software bundle with multiple elements:\\n- Core Platform: $500/month (list price $600)\\n- Premium Support: $100/month (list price $150)\\n- Implementation Services: $2000 one-time (list price $2500)\\nTotal bundle: $8200/year\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"revrec_waterfall\": {\n    \"zr_revrec\": [\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 393.83\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 421.97\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"May-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 421.97\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 421.97\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 436.03\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 421.97\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Core Platform\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5133.91,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 436.02\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 98.46\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 105.49\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"May-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 105.49\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 105.49\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 109.01\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 105.49\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Premium Support\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 1283.48,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 109\n      },\n      {\n        \"Line Item Num\": 3,\n        \"POB Name\": \"Implementation Services\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-01-01\",\n        \"Ext Allocated Price\": 1782.61,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 1782.61\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"May-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 4,\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 0\n      }\n    ],\n    \"assumptions\": [\n      \"Ratable lines use straight-line daily proration over an inclusive revenue window from 2025-01-01 through 2025-12-31 (365 total days).\",\n      \"Monthly amounts are rounded to 2 decimals; any rounding difference is trued-up in the final period (Dec-25) to ensure the sum equals Ext Allocated Price per line.\"\n    ],\n    \"open_questions\": []\n  },\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Core Platform\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Bundle Customer - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Core Platform\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 600,\n        \"Unit Sell Price\": 500,\n        \"Ext List Price\": 7200,\n        \"Ext Sell Price\": 6000,\n        \"SSP Price\": 600,\n        \"Ext SSP Price\": 7200,\n        \"SSP Percent\": 62.61,\n        \"Ext Allocated Price\": 5133.91,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 5133.91,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Bundle Customer\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Software\",\n        \"Product Family\": \"Platform\"\n      },\n      {\n        \"POB Name\": \"Premium Support\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 2,\n        \"Subscription Name\": \"Bundle Customer - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Premium Support\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 150,\n        \"Unit Sell Price\": 100,\n        \"Ext List Price\": 1800,\n        \"Ext Sell Price\": 1200,\n        \"SSP Price\": 150,\n        \"Ext SSP Price\": 1800,\n        \"SSP Percent\": 15.65,\n        \"Ext Allocated Price\": 1283.48,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 1283.48,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Bundle Customer\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Services\",\n        \"Product Family\": \"Support\"\n      },\n      {\n        \"POB Name\": \"Implementation Services\",\n        \"POB Template\": \"BK-PIT-STARTDATE\",\n        \"POB Satisfied\": \"Point In Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"None\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 3,\n        \"Subscription Name\": \"Bundle Customer - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Implementation Services\",\n        \"RPC Type\": \"OneTime\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-01-01\",\n        \"Unit List Price\": 2500,\n        \"Unit Sell Price\": 2000,\n        \"Ext List Price\": 2500,\n        \"Ext Sell Price\": 2000,\n        \"SSP Price\": 2500,\n        \"Ext SSP Price\": 2500,\n        \"SSP Percent\": 21.74,\n        \"Ext Allocated Price\": 1782.61,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 1782.61,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Bundle Customer\",\n        \"POB IDENTIFIER\": \"BK-PIT-STARTDATE\",\n        \"Product Category\": \"Services\",\n        \"Product Family\": \"Implementation\"\n      },\n      {\n        \"POB Name\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"None\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 4,\n        \"Subscription Name\": \"Bundle Customer - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"RPC Type\": \"OneTime\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 0,\n        \"Unit Sell Price\": -1000,\n        \"Ext List Price\": 0,\n        \"Ext Sell Price\": -1000,\n        \"SSP Price\": 0,\n        \"Ext SSP Price\": 0,\n        \"SSP Percent\": 0,\n        \"Ext Allocated Price\": 0,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 0,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Bundle Customer\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Discount\",\n        \"Product Family\": \"Commercial Terms\"\n      }\n    ],\n    \"assumptions\": [\n      \"Ordered Qty for monthly recurring charges is set to 12 (number of monthly billing periods in the 12-month term) so Ext = Unit × Qty aligns to annual amounts.\",\n      \"Allocation is enabled and uses List Price as SSP: SSP Price = Unit List Price for each line.\",\n      \"Bundle Discount line has no list price provided, so Unit List Price/SSP are assumed to be 0; therefore it receives 0% SSP and $0 allocated consideration (discount is effectively redistributed to other lines via allocation).\",\n      \"Rounding to 2 decimals; allocation totals tie exactly: Sum(Ext Allocated Price)=8200.00 equals Sum(Ext Sell Price)=8200.00.\"\n    ],\n    \"open_questions\": [\n      \"Should the Bundle Discount line carry a non-zero (possibly negative) SSP/list price for reporting purposes, or should it be treated as a non-POB/contra line that is excluded from allocation and/or POB assignment?\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Core Platform\",\n        \"productName\": \"Software Bundle\",\n        \"ratePlanName\": \"Bundle Customer - 2025 Bundle\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Recurring SaaS element billed monthly in advance; recognize ratably over the service period. Allocation uses list price as SSP (list $600/mo) versus sell ($500/mo).\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BK-OT-CONSUMP-RATABLE-VC\",\n            \"pob_name\": \"Consumption Ratable with VC upon booking\",\n            \"why_not\": \"No variable consideration/usage-based constraint indicated for Core Platform.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Premium Support\",\n        \"productName\": \"Software Bundle\",\n        \"ratePlanName\": \"Bundle Customer - 2025 Bundle\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Recurring support service billed monthly in advance; recognize ratably over the service period. Allocation uses list price as SSP (list $150/mo) versus sell ($100/mo).\",\n        \"confidence\": 0.93,\n        \"alternatives\": []\n      },\n      {\n        \"chargeName\": \"Implementation Services\",\n        \"productName\": \"Software Bundle\",\n        \"ratePlanName\": \"Bundle Customer - 2025 Bundle\",\n        \"pob_identifier\": \"BK-PIT-STARTDATE\",\n        \"pob_name\": \"BK-PIT-STARTDATE\",\n        \"ratable_method\": \"Immediate Using Start Date\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-01-01\"\n        },\n        \"rationale\": \"One-time professional service fee recognized at service start date due to no acceptance/completion/go-live milestone being provided. SSP/list price is $2,500; sell price is $2,000; included in allocation scope.\",\n        \"confidence\": 0.72,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-PIT-COMPLETION\",\n            \"pob_name\": \"EVT-PIT-COMPLETION\",\n            \"why_not\": \"Requires a defined completion event/date and operational process to feed completion to Revenue.\"\n          },\n          {\n            \"pob_identifier\": \"EVT-PIT-ACCEPTAN\",\n            \"pob_name\": \"EVT-PIT-ACCEPTAN\",\n            \"why_not\": \"Requires a defined customer acceptance milestone/date and process to feed acceptance to Revenue.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Bundle Discount (to reach $8,200 total consideration)\",\n        \"productName\": \"Software Bundle\",\n        \"ratePlanName\": \"Bundle Customer - 2025 Bundle\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Implied discount of $1,000 is needed because stated component sell prices total $9,200/year but bundle total is $8,200/year. Discount is modeled as one-time billing and recognized ratably over the service term to reduce revenue consistently.\",\n        \"confidence\": 0.78,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BK-PIT-CURRENT_PERIOD\",\n            \"pob_name\": \"BK-PIT-CURRENT_PERIOD\",\n            \"why_not\": \"Would recognize the entire discount immediately, which typically does not match a SaaS discount intended to reduce revenue over the service period.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"If Zuora Revenue is configured to allocate discounts automatically across POBs, an alternative is to embed the discount into the sell prices of the deliverable charges (no separate discount charge).\",\n      \"If Implementation Services must be event-driven, switch the POB template to EVT-PIT-COMPLETION or EVT-PIT-ACCEPTAN and ensure the event feed/process exists to trigger release.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "multi-element-allocation",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T19:55:26.994Z"
      }
    },
    {
      "id": "9a13c86d-7c31-4a60-88a6-c88bd60d44ed",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Prepaid Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Annually\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Annual prepaid cloud credits:\\n- $12,000 prepaid annually\\n- Credits drawn down as used\\n- Revenue recognized ratably over 12 months ($1000/month)\\n- Billing upfront at contract start\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"revrec_waterfall\": {\n    \"zr_revrec\": [\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 920.55\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"May-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 1019.17\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"May-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 0\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"Event Name\": \"Upon Consumption\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 0,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 0\n      }\n    ],\n    \"assumptions\": [\n      \"Ratable line (BK-OT-CONSUMP-RATABLE) recognized straight-line using daily proration over an inclusive 365-day window (2025-01-01 through 2025-12-31).\",\n      \"Monthly amounts are rounded to 2 decimals; Dec-25 includes a -$0.01 rounding adjustment so Line 1 totals exactly $12,000.00.\",\n      \"Event-driven line (EVT-PIT-CONSUMP-USAGE) has no consumption events provided; therefore revenue is $0.00 in all periods.\"\n    ],\n    \"open_questions\": [\n      \"For Line 2 (Cloud Credits Drawdown, EVT-PIT-CONSUMP-USAGE), please provide the 2025 consumption event data (by date or by month) including units consumed and the applicable unit rate from the prepaid pool, so the event-driven revenue can be calculated (Amount = units × unit rate).\"\n    ]\n  },\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Annual Prepaid Cloud Credits\",\n        \"POB Template\": \"Consumption Ratable without VC upon booking\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Annual\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Prepaid Corp - Annual Cloud Credits\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Annual Prepaid Cloud Credits\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 12000,\n        \"Unit Sell Price\": 12000,\n        \"Ext List Price\": 12000,\n        \"Ext Sell Price\": 12000,\n        \"SSP Price\": 12000,\n        \"Ext SSP Price\": 12000,\n        \"SSP Percent\": 100,\n        \"Ext Allocated Price\": 12000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 12000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Prepaid Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-CONSUMP-RATABLE\",\n        \"Product Category\": \"Cloud Services\",\n        \"Product Family\": \"Cloud Credits\"\n      },\n      {\n        \"POB Name\": \"Cloud Credits Drawdown\",\n        \"POB Template\": \"Consumption By Usage Event\",\n        \"POB Satisfied\": \"Point In Time\",\n        \"Release Event\": \"Upon Consumption\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InArrears\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 2,\n        \"Subscription Name\": \"Prepaid Corp - Annual Cloud Credits\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Cloud Credits Drawdown\",\n        \"RPC Type\": \"Usage\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 0,\n        \"Unit Sell Price\": 0,\n        \"Ext List Price\": 0,\n        \"Ext Sell Price\": 0,\n        \"SSP Price\": 0,\n        \"Ext SSP Price\": 0,\n        \"SSP Percent\": 0,\n        \"Ext Allocated Price\": 0,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 0,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Prepaid Corp\",\n        \"POB IDENTIFIER\": \"EVT-PIT-CONSUMP-USAGE\",\n        \"Product Category\": \"Cloud Services\",\n        \"Product Family\": \"Consumption\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocations flag = No, so Ext Allocated Price = Ext Sell Price for each line (no SSP-based redistribution).\",\n      \"SSP Price equals Unit List Price for all lines.\",\n      \"Annual Prepaid Cloud Credits is billed as a single upfront annual fee ($12,000) for the 2025-01-01 to 2025-12-31 service period and recognized over time (ratable) per the assigned POB template.\",\n      \"Cloud Credits Drawdown is included as a $0 usage line to capture consumption events (release upon consumption) without creating additional transaction price; actual revenue impact is assumed to be driven by the prepaid/ratable line plus operational usage events rather than incremental billed consideration.\"\n    ],\n    \"open_questions\": [\n      \"Should the Cloud Credits Drawdown line carry a non-zero unit rate (e.g., $/credit) and quantity driven by expected/actual usage, with invoices/usage uploads providing the actual amounts, or is it intended to remain $0 as an event-only line?\",\n      \"Confirm the intended accounting method: ratable over 12 months regardless of usage (time-based) vs. recognize based on consumption (usage-based). Current setup reflects ratable for the prepaid fee and point-in-time event handling on the drawdown line with $0 consideration.\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Annual Prepaid Cloud Credits\",\n        \"productName\": \"Cloud Credits\",\n        \"ratePlanName\": \"Annual Prepaid Cloud Credits (PPDD)\",\n        \"pob_identifier\": \"BK-OT-CONSUMP-RATABLE\",\n        \"pob_name\": \"Consumption Ratable without VC upon booking\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Annual prepaid billed upfront at contract start; revenue requirement is straight-line recognition over the 12-month service/validity period (not tied to consumption timing).\",\n        \"confidence\": 0.93,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BK-OT-RATABLE\",\n            \"pob_name\": \"BK-OT-RATABLE\",\n            \"why_not\": \"Could work for straight-line SaaS, but BK-OT-CONSUMP-RATABLE better matches PPDD (prepaid credits with drawdown) while still recognizing ratably over time.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Cloud Credits Drawdown\",\n        \"productName\": \"Cloud Credits\",\n        \"ratePlanName\": \"Annual Prepaid Cloud Credits (PPDD)\",\n        \"pob_identifier\": \"EVT-PIT-CONSUMP-USAGE\",\n        \"pob_name\": \"Consumption By Usage Event\",\n        \"ratable_method\": \"Immediate Using Open Period\",\n        \"release_event\": \"Upon Consumption\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Drawdown usage charge exists to reduce the prepaid balance as credits are consumed; priced at $0 so it should not drive revenue amounts (revenue is recognized from the prepaid charge ratably).\",\n        \"confidence\": 0.86,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-PIT-CONSUMP-PAYGO\",\n            \"pob_name\": \"Consumption PayGo Billing\",\n            \"why_not\": \"This would recognize upon billing and aligns to pay-go invoicing; not applicable because drawdown is not billed (priced at $0) and revenue is not intended to be bill-driven for this component.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"DS-002/DS-006 alignment: prepaid charge effectiveStartDate=01/01/2025 and effectiveEndDate=12/31/2025 to support ratable recognition over the full service window.\",\n      \"Allocations disabled per instruction: isAllocationEligible=false on all charges (no SSP allocation behavior implied in Revenue).\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "prepaid-drawdown-ratable",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:01:12.988Z"
      }
    },
    {
      "id": "3ce1e0a8-57c7-495f-89a0-b08e060520c7",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Promo Customer\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"SaaS subscription with promotional offer:\\n- First 3 months FREE (100% discount)\\n- Months 4-12: $100/month\\n- Total contract value: $900 over 12 months\\n- Revenue recognized over full 12-month term\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Promo Free Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 0,\n      \"Amount\": 0,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Promo Free Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 0,\n      \"Amount\": 0,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Promo Free Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 0,\n      \"Amount\": 0,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"SaaS Subscription - Standard Period\",\n      \"Rate Plan\": \"SaaS Subscription - Promo Offer (3 mo free, then $100)\",\n      \"Product\": \"SaaS Subscription\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 900,\n    \"schedule_total\": 900,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Invoice Date is assumed to equal Billing Date for each billing event (monthly in advance).\",\n    \"The promotional offer is represented as a $0 recurring fee for the first 3 monthly service periods (i.e., price is effectively discounted to zero for those months).\",\n    \"Monthly billing periods are aligned to calendar month boundaries from 01/01/2025 through 12/31/2025 with no proration.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "promo-free-months",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:28:21.837Z"
      }
    },
    {
      "id": "7afd5b9e-e486-48ff-8a4f-bf8ba97f0a0b",
      "step_name": "design_subscription",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Solution Architect designing a complete billing and revenue solution. You will create:\n1. **Zuora Billing Subscription** — rate plans, charges, dates, terms\n2. **Zuora Revenue POB Mappings** — template assignments for each charge\n\nBy designing both together, you ensure billing structures align with rev rec requirements and catch mismatches early.\n\n**CRITICAL CONSTRAINT**: You can ONLY use POB identifiers from the \"Available ZR POB templates\" list provided. NEVER invent identifiers.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contract dates** — serviceStart, serviceEnd, termMonths (authoritative)\n- **Billing config** — period, timing, trigger event\n- **Allocations flag** — is_allocations (true/false)\n- **Golden use cases** — matched reference patterns\n- **Reference data** — example subscriptions and charges\n- **POB templates** — the ONLY valid identifiers to use\n\n---\n\n## STEP 1: Design Charges\n\n### Charge Type Decision Tree\n\n```\nIs it a one-time fee?\n  ├─ YES → type: \"OneTime\", model: \"FlatFee\"\n  │        billingPeriod: null\n  │        → Skip to STEP 2 for POB\n  │\n  └─ NO → Is it based on usage/consumption?\n          ├─ YES → type: \"Usage\", model varies\n          │        └─ Per unit? → model: \"PerUnit\"\n          │        └─ Tiered? → model: \"Tiered\"\n          │        └─ Overage? → model: \"Overage\"\n          │        → Skip to STEP 2 for POB\n          │\n          └─ NO → type: \"Recurring\"\n                  └─ Flat amount? → model: \"FlatFee\"\n                  └─ Per seat/unit? → model: \"PerUnit\"\n                  └─ Volume-based? → model: \"Volume\"\n                  → Skip to STEP 2 for POB\n```\n\n### Charge Fields Required\n\n| Field | Recurring | OneTime | Usage |\n|-------|-----------|---------|-------|\n| name | ✓ | ✓ | ✓ |\n| type | \"Recurring\" | \"OneTime\" | \"Usage\" |\n| model | FlatFee/PerUnit/Volume/Tiered | FlatFee | PerUnit/Tiered/Overage |\n| billingPeriod | Month/Quarter/Annual/Semi-Annual | null | Month (rating period) |\n| billingTiming | InAdvance/InArrears | null | InArrears |\n| triggerEvent | ContractEffective | ContractEffective | ContractEffective |\n| quantity | number or null | number or null | null (from usage) |\n| listPrice | $ | $ | $ per unit |\n| sellPrice | $ | $ | $ per unit |\n| effectiveStartDate | MM/DD/YYYY | MM/DD/YYYY | MM/DD/YYYY |\n| effectiveEndDate | MM/DD/YYYY or null | null | MM/DD/YYYY or null |\n\n### Usage Records Generation\n\n**If any Usage charges are present, you MUST generate sample usage records within the subscription term.**\n\nUsage records should:\n- Fall within the charge's effective date range\n- Use the charge's UOM\n- Include realistic quantities based on the use case context\n- Cover multiple periods if the subscription spans multiple billing cycles\n\nExample usage record:\n```json\n{\n  \"chargeName\": \"API Calls\",\n  \"startDate\": \"2026-01-01\",\n  \"endDate\": \"2026-01-31\",\n  \"quantity\": 50000,\n  \"uom\": \"API Call\"\n}\n```\n\n### CRITICAL: Charge Segmentation for Price Changes\n\n**When prices change during the term, create SEPARATE charges for each period.**\n\nPatterns requiring segmentation:\n- Year-over-year ramps (\"Year 1: $100, Year 2: $120\")\n- Introductory pricing (\"First 3 months $15, then $20\")\n- Promotional periods (\"50% off for 6 months\")\n\n**Example:** 12-month contract, $15/mo for months 1-3, $20/mo for months 4-12\n```\nCharge 1: \"Service - Promo\", start: 01/01/2026, end: 03/31/2026, sellPrice: 15\nCharge 2: \"Service - Standard\", start: 04/01/2026, end: 12/31/2026, sellPrice: 20\n```\n\n**DO NOT average prices into a single charge. Each distinct price = separate charge.**\n\n---\n\n## STEP 2: Assign POB Templates\n\nFor EACH charge you created, assign a POB template from the provided list.\n\n### POB Selection Matrix\n\n| Charge Type | Billing Timing | Recognition | → POB Identifier |\n|-------------|---------------|-------------|------------------|\n| Recurring | InAdvance | Over time (standard SaaS) | `BK-OT-RATABLE` |\n| Recurring | InAdvance | Over time with VC | `BK-OT-CONSUMP-RATABLE-VC` |\n| Recurring | InArrears | Over time (invoice ratable) | `BL-OT-INVRATABLE` |\n| OneTime | — | Immediate at booking (start date) | `BK-PIT-STARTDATE` |\n| OneTime | — | Immediate at booking (current period) | `BK-PIT-CURRENT_PERIOD` |\n| OneTime | — | Immediate at billing (start date) | `BL-PIT-STARTDATE` |\n| OneTime | — | Immediate at billing (current period) | `BL-PIT-CURRENT_PERIOD` |\n| OneTime | — | Spread over term | `BK-OT-RATABLE` |\n| OneTime | — | Upon acceptance | `EVT-PIT-ACCEPTAN` |\n| OneTime | — | Upon go-live | `EVT-OT-RATABLE-GOLIVE` |\n| Usage | — | Upon consumption event | `EVT-PIT-CONSUMP-USAGE` |\n| Usage | — | Upon billing | `BL-PIT-CONSUMP-PAYGO` |\n\n### POB Identifier Naming Convention\n\n| Prefix | Meaning |\n|--------|---------|\n| `BK-` | Release upon Booking |\n| `BL-` | Release upon Billing |\n| `EVT-` | Release upon Event |\n| `-OT-` | Over Time (ratable) |\n| `-PIT-` | Point In Time (immediate) |\n\n---\n\n## Special Patterns\n\n### Prepay Drawdown (PPDD)\n\nWhen the use case involves prepaid credits:\n\n| Charge | Type | Model | POB |\n|--------|------|-------|-----|\n| Prepayment | OneTime or Recurring | FlatFee | See below |\n| Drawdown | Usage | PerUnit | `EVT-PIT-CONSUMP-USAGE` |\n| Overage (optional) | Usage | PerUnit | `BL-PIT-CONSUMP-PAYGO` |\n\n**PPDD POB Decision:**\n- \"Recognize ratably over time\" → Prepayment uses `BK-OT-CONSUMP-RATABLE`\n- \"Recognize as credits consumed\" → Prepayment stays deferred, Drawdown triggers recognition via `EVT-PIT-CONSUMP-USAGE`\n\n⚠️ **Critical distinction:** If the use case says revenue is recognized \"as credits are consumed\", \"upon consumption\", or \"as-used\":\n- Do NOT use a ratable template for the prepayment\n- Prepayment revenue stays deferred until consumption occurs\n- The Drawdown charge's consumption events trigger actual recognition\n- Revenue waterfall for prepayment shows $0 until usage posts\n\n**IMPORTANT:** When PPDD charges are present, you MUST generate usage records for the Drawdown charge showing credit consumption events during the subscription term.\n\n### Contract Amendments\n\n**Retrospective (same POB, price/qty change):**\n- Original charge: shorten end date to mod_date - 1\n- New charge: from mod_date to original end\n\n**Prospective (new POB added):**\n- Original charge: unchanged\n- New charge: separate for new deliverable\n\n### Bundle Explosion\n\nWhen one billing line has multiple POBs:\n- Create ONE charge in billing\n- Note in assumptions: \"Bundle explosion applies\"\n- List child components and their POBs in assumptions\n\n---\n\n## Output\n\nReturn JSON with complete structure. Every charge MUST have a corresponding POB mapping.\n\n```json\n{\n  \"subscription\": {\n    \"name\": \"Customer Name - Subscription\",\n    \"termType\": \"TERMED\",\n    \"status\": \"Active\",\n    \"currency\": \"USD\",\n    \"contractEffectiveDate\": \"MM/DD/YYYY\",\n    \"serviceActivationDate\": \"MM/DD/YYYY\",\n    \"customerAcceptanceDate\": \"MM/DD/YYYY\",\n    \"subscriptionStartDate\": \"MM/DD/YYYY\",\n    \"subscriptionEndDate\": \"MM/DD/YYYY or null\",\n    \"initialTerm\": 12,\n    \"initialTermPeriodType\": \"Month\",\n    \"renewalTerm\": 12,\n    \"renewalTermPeriodType\": \"Month\",\n    \"autoRenew\": true\n  },\n  \"rate_plans\": [\n    {\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"charges\": [\n        {\n          \"name\": \"Charge Name\",\n          \"type\": \"Recurring\",\n          \"model\": \"FlatFee\",\n          \"uom\": null,\n          \"billingPeriod\": \"Month\",\n          \"billingTiming\": \"InAdvance\",\n          \"billingDay\": null,\n          \"billingPeriodAlignment\": null,\n          \"listPriceBase\": null,\n          \"triggerEvent\": \"ContractEffective\",\n          \"specificTriggerDate\": null,\n          \"endDateCondition\": null,\n          \"specificEndDate\": null,\n          \"quantity\": 1,\n          \"listPrice\": 100,\n          \"sellPrice\": 100,\n          \"price\": 100,\n          \"effectiveStartDate\": \"MM/DD/YYYY\",\n          \"effectiveEndDate\": \"MM/DD/YYYY or null\",\n          \"chargeFunction\": null,\n          \"isAllocationEligible\": true,\n          \"drawdownType\": null,\n          \"commitmentType\": null,\n          \"prepaymentUOM\": null,\n          \"prepaymentUnits\": null,\n          \"validityPeriod\": null\n        }\n      ]\n    }\n  ],\n  \"usage\": [\n    {\n      \"chargeName\": \"API Calls\",\n      \"startDate\": \"2026-01-01\",\n      \"endDate\": \"2026-01-31\",\n      \"quantity\": 50000,\n      \"uom\": \"API Call\"\n    }\n  ],\n  \"charge_pob_map\": [\n    {\n      \"chargeName\": \"Charge Name\",\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"pob_identifier\": \"BK-OT-RATABLE\",\n      \"pob_name\": \"Template Name\",\n      \"ratable_method\": \"Ratable\",\n      \"release_event\": \"Upon Booking (Full Booking Release)\",\n      \"recognition_window\": {\n        \"start\": \"YYYY-MM-DD\",\n        \"end\": \"YYYY-MM-DD or null\"\n      },\n      \"rationale\": \"Standard SaaS recurring - release at booking, recognize ratably over term\",\n      \"confidence\": 0.95,\n      \"alternatives\": []\n    }\n  ],\n  \"assumptions\": [\"List key assumptions made\"],\n  \"open_questions\": [\"Questions needing customer clarification\"],\n  \"mapping_notes\": [\"POB-specific notes if any\"]\n}\n```\n\n---\n\n## Reference Documentation\n\n- Subscriptions: https://docs.zuora.com/en/zuora-billing/manage-orders/order-actions/create-subscriptions\n- Rate Plan Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/product-catalog-configurations/create-product-rate-plan-charges\n- Tiered Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-pricing\n- Volume Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/volume-pricing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion\n- POB Templates: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/create-pob-template\n- POB Ratable Methods: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/predefined-pob-ratable-methods"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Setup Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Enterprise software with implementation:\\n- One-time setup fee: $5,000 (billed upfront)\\n- Monthly subscription: $500/month\\n- Setup fee revenue recognized over 12-month term\\n- Total contract: $11,000\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"subscription_spec\": {\n    \"subscription\": {\n      \"name\": \"Setup Corp - Subscription\",\n      \"termType\": \"TERMED\",\n      \"status\": \"Active\",\n      \"currency\": \"USD\",\n      \"contractEffectiveDate\": \"01/01/2025\",\n      \"serviceActivationDate\": \"01/01/2025\",\n      \"customerAcceptanceDate\": \"01/01/2025\",\n      \"subscriptionStartDate\": \"01/01/2025\",\n      \"subscriptionEndDate\": \"12/31/2025\",\n      \"initialTerm\": 12,\n      \"initialTermPeriodType\": \"Month\",\n      \"renewalTerm\": 12,\n      \"renewalTermPeriodType\": \"Month\",\n      \"autoRenew\": false\n    },\n    \"rate_plans\": [\n      {\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"charges\": [\n          {\n            \"name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n            \"type\": \"OneTime\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"\",\n            \"billingPeriod\": \"\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"\",\n            \"billingPeriodAlignment\": \"\",\n            \"listPriceBase\": \"\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"\",\n            \"endDateCondition\": \"\",\n            \"specificEndDate\": \"\",\n            \"quantity\": 1,\n            \"listPrice\": 5000,\n            \"sellPrice\": 5000,\n            \"price\": 5000,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"\",\n            \"commitmentType\": \"\",\n            \"prepaymentUOM\": \"\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"\"\n          },\n          {\n            \"name\": \"Monthly Software Subscription\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"\",\n            \"billingPeriodAlignment\": \"\",\n            \"listPriceBase\": \"\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"\",\n            \"endDateCondition\": \"\",\n            \"specificEndDate\": \"\",\n            \"quantity\": 1,\n            \"listPrice\": 500,\n            \"sellPrice\": 500,\n            \"price\": 500,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"\",\n            \"commitmentType\": \"\",\n            \"prepaymentUOM\": \"\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"\"\n          }\n        ]\n      }\n    ],\n    \"usage\": [],\n    \"assumptions\": [\n      \"List price equals sell price for both elements because no separate SSP/list price was provided; Allocation Method = Use List Price will therefore not create any reallocation impact in this specific contract.\",\n      \"CustomerAcceptanceDate and ServiceActivationDate are assumed to be 01/01/2025 (same as ContractEffectiveDate/serviceStart) since no separate dates were provided.\",\n      \"One-time setup fee is modeled as a one-time billing charge with an over-time service period (effectiveEndDate 12/31/2025) to align billing with the stated 12-month revenue recognition requirement.\",\n      \"No explicit discount is modeled because the stated line items already sum to the stated total consideration ($5,000 + $500×12 = $11,000).\"\n    ],\n    \"open_questions\": [\n      \"Should the setup/implementation deliverable be treated as (a) a stand-ready service over 01/01/2025–12/31/2025 (current design), or (b) a milestone-based delivery (e.g., go-live/acceptance) requiring an EVT-* template and event feed?\",\n      \"Do you want auto-renewal enabled after 12/31/2025? (Currently set to autoRenew=false.)\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Setup/implementation consideration is billed upfront but contract requirement states revenue is recognized over the 12-month term; therefore treat as an over-time POB released at booking and recognized ratably over 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.9,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"pob_name\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"why_not\": \"Use only if revenue release/recognition must be gated by a Go-Live Event feed; the stated requirement is simply ratable over the term, not event-gated.\"\n          },\n          {\n            \"pob_identifier\": \"BK-PIT-STARTDATE\",\n            \"pob_name\": \"BK-PIT-STARTDATE\",\n            \"why_not\": \"Not appropriate because PIT would recognize immediately at start date, conflicting with the stated 12-month recognition pattern.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Monthly Software Subscription\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Standard SaaS subscription billed monthly in advance; recognize over time ratably across the service period 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would be used if you require billed-release invoice-ratable behavior (release upon billing) instead of booking-release.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Allocations flag is set via isAllocationEligible=true on both charges so Zuora Revenue can include both in SSP allocation.\",\n      \"Both elements use BK-OT-RATABLE to align with release upon booking and ratable recognition across the term; ensure Revenue is configured to recognize over the charge service period for each line.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "subscription-setup-fee",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:35:34.546Z"
      }
    },
    {
      "id": "2277cdbb-badb-4167-a5d3-177987175568",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Setup Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Enterprise software with implementation:\\n- One-time setup fee: $5,000 (billed upfront)\\n- Monthly subscription: $500/month\\n- Setup fee revenue recognized over 12-month term\\n- Total contract: $11,000\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Setup Corp - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Monthly Software Subscription\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 500,\n        \"Unit Sell Price\": 500,\n        \"Ext List Price\": 6000,\n        \"Ext Sell Price\": 6000,\n        \"SSP Price\": 500,\n        \"Ext SSP Price\": 6000,\n        \"SSP Percent\": 54.545455,\n        \"Ext Allocated Price\": 6000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 6000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Setup Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Software\",\n        \"Product Family\": \"Subscription\"\n      },\n      {\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 2,\n        \"Subscription Name\": \"Setup Corp - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"RPC Type\": \"OneTime\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 5000,\n        \"Unit Sell Price\": 5000,\n        \"Ext List Price\": 5000,\n        \"Ext Sell Price\": 5000,\n        \"SSP Price\": 5000,\n        \"Ext SSP Price\": 5000,\n        \"SSP Percent\": 45.454545,\n        \"Ext Allocated Price\": 5000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 5000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Setup Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Services\",\n        \"Product Family\": \"Implementation\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocation is enabled and SSP is derived using the 'Use List Price' method; Unit List Price equals Unit Sell Price for both lines, so relative SSP allocation does not change the transaction price split.\",\n      \"Monthly subscription unit pricing is represented as $500 per month with Ordered Qty = 12 to reflect the 12 monthly billing periods in the 12-month term (Ext = Unit × Qty).\",\n      \"Setup fee is billed upfront but recognized ratably over the full service period (2025-01-01 to 2025-12-31) per the provided POB mapping.\"\n    ],\n    \"open_questions\": [\n      \"Confirm whether the setup fee has a different standalone list price (SSP) than the invoiced/sell amount ($5,000). If yes, allocation would shift between setup and subscription.\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Setup/implementation consideration is billed upfront but contract requirement states revenue is recognized over the 12-month term; therefore treat as an over-time POB released at booking and recognized ratably over 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.9,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"pob_name\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"why_not\": \"Use only if revenue release/recognition must be gated by a Go-Live Event feed; the stated requirement is simply ratable over the term, not event-gated.\"\n          },\n          {\n            \"pob_identifier\": \"BK-PIT-STARTDATE\",\n            \"pob_name\": \"BK-PIT-STARTDATE\",\n            \"why_not\": \"Not appropriate because PIT would recognize immediately at start date, conflicting with the stated 12-month recognition pattern.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Monthly Software Subscription\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Standard SaaS subscription billed monthly in advance; recognize over time ratably across the service period 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would be used if you require billed-release invoice-ratable behavior (release upon billing) instead of booking-release.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Allocations flag is set via isAllocationEligible=true on both charges so Zuora Revenue can include both in SSP allocation.\",\n      \"Both elements use BK-OT-RATABLE to align with release upon booking and ratable recognition across the term; ensure Revenue is configured to recognize over the charge service period for each line.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "subscription-setup-fee",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:35:52.818Z"
      }
    },
    {
      "id": "24862ecb-b9c9-4360-875b-26239c1a7da5",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Setup Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Enterprise software with implementation:\\n- One-time setup fee: $5,000 (billed upfront)\\n- Monthly subscription: $500/month\\n- Setup fee revenue recognized over 12-month term\\n- Total contract: $11,000\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"revrec_waterfall\": {\n    \"zr_revrec\": [\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 460.27\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 493.15\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"May-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 493.15\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 493.15\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 493.15\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 6000,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 509.59\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 383.56\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 410.96\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"May-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 410.96\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 410.96\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 424.66\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 410.96\n      },\n      {\n        \"Line Item Num\": 2,\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Ext Allocated Price\": 5000,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 424.64\n      }\n    ],\n    \"assumptions\": [\n      \"Ratable POBs (BK-OT-RATABLE) recognized straight-line using daily proration over the full revenue window (2025-01-01 to 2025-12-31 = 365 days).\",\n      \"Monthly amount calculated as (Ext Allocated Price / 365) × (days in each calendar month), rounded to 2 decimals; final month adjusted by rounding residual to ensure each line sums exactly to its Ext Allocated Price.\"\n    ],\n    \"open_questions\": []\n  },\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Monthly Software Subscription\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Setup Corp - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Monthly Software Subscription\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 500,\n        \"Unit Sell Price\": 500,\n        \"Ext List Price\": 6000,\n        \"Ext Sell Price\": 6000,\n        \"SSP Price\": 500,\n        \"Ext SSP Price\": 6000,\n        \"SSP Percent\": 54.545455,\n        \"Ext Allocated Price\": 6000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 6000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Setup Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Software\",\n        \"Product Family\": \"Subscription\"\n      },\n      {\n        \"POB Name\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": false,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 2,\n        \"Subscription Name\": \"Setup Corp - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"RPC Type\": \"OneTime\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 5000,\n        \"Unit Sell Price\": 5000,\n        \"Ext List Price\": 5000,\n        \"Ext Sell Price\": 5000,\n        \"SSP Price\": 5000,\n        \"Ext SSP Price\": 5000,\n        \"SSP Percent\": 45.454545,\n        \"Ext Allocated Price\": 5000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": true,\n        \"Unreleased Revenue\": 5000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Setup Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Services\",\n        \"Product Family\": \"Implementation\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocation is enabled and SSP is derived using the 'Use List Price' method; Unit List Price equals Unit Sell Price for both lines, so relative SSP allocation does not change the transaction price split.\",\n      \"Monthly subscription unit pricing is represented as $500 per month with Ordered Qty = 12 to reflect the 12 monthly billing periods in the 12-month term (Ext = Unit × Qty).\",\n      \"Setup fee is billed upfront but recognized ratably over the full service period (2025-01-01 to 2025-12-31) per the provided POB mapping.\"\n    ],\n    \"open_questions\": [\n      \"Confirm whether the setup fee has a different standalone list price (SSP) than the invoiced/sell amount ($5,000). If yes, allocation would shift between setup and subscription.\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"One-Time Setup Fee (Billed Upfront, Recognized Ratable)\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Setup/implementation consideration is billed upfront but contract requirement states revenue is recognized over the 12-month term; therefore treat as an over-time POB released at booking and recognized ratably over 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.9,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"pob_name\": \"EVT-OT-RATABLE-GOLIVE\",\n            \"why_not\": \"Use only if revenue release/recognition must be gated by a Go-Live Event feed; the stated requirement is simply ratable over the term, not event-gated.\"\n          },\n          {\n            \"pob_identifier\": \"BK-PIT-STARTDATE\",\n            \"pob_name\": \"BK-PIT-STARTDATE\",\n            \"why_not\": \"Not appropriate because PIT would recognize immediately at start date, conflicting with the stated 12-month recognition pattern.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Monthly Software Subscription\",\n        \"productName\": \"Enterprise Software\",\n        \"ratePlanName\": \"Enterprise Subscription + Setup\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Standard SaaS subscription billed monthly in advance; recognize over time ratably across the service period 01/01/2025–12/31/2025.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"Would be used if you require billed-release invoice-ratable behavior (release upon billing) instead of booking-release.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Allocations flag is set via isAllocationEligible=true on both charges so Zuora Revenue can include both in SSP allocation.\",\n      \"Both elements use BK-OT-RATABLE to align with release upon booking and ratable recognition across the term; ensure Revenue is configured to recognize over the charge service period for each line.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "subscription-setup-fee",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:36:49.826Z"
      }
    },
    {
      "id": "9d49e837-55cd-4c71-aa09-6d76965ce54e",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Consumer User\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Consumer streaming service:\\n- $9.99/month subscription\\n- Monthly billing in advance\\n- No allocations required\\n- Simple recurring revenue recognition\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Streaming Subscription - Monthly Fee\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 1,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Consumer User - Streaming Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Streaming Subscription - Monthly Fee\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 119.88,\n        \"Unit Sell Price\": 119.88,\n        \"Ext List Price\": 119.88,\n        \"Ext Sell Price\": 119.88,\n        \"SSP Price\": 119.88,\n        \"Ext SSP Price\": 119.88,\n        \"SSP Percent\": 100,\n        \"Ext Allocated Price\": 119.88,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 119.88,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Consumer User\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Digital Services\",\n        \"Product Family\": \"Streaming\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocations = No, so Ext Allocated Price equals Ext Sell Price for the line.\",\n      \"The stated price of $9.99/month is converted to a 12-month total transaction price: 9.99 × 12 = 119.88; Unit List Price and Unit Sell Price are represented as the total for the full 12-month service period to keep Ext Price formulas (Qty × Unit Price) consistent with the one-line-per-charge requirement.\",\n      \"SSP Price is set equal to List Price for this simple standalone recurring POB (no SSP overrides provided).\"\n    ],\n    \"open_questions\": [\n      \"Confirm whether you want Unit List/Sell Price stored as monthly ($9.99) with a separate field/approach for total contract value, or as the full-term total ($119.88) as assumed here.\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Streaming Subscription - Monthly Fee\",\n        \"productName\": \"Consumer Streaming Service\",\n        \"ratePlanName\": \"Consumer Streaming - Monthly\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Simple consumer recurring subscription billed monthly in advance. Release revenue contract upon booking and recognize ratably over the service period aligned to the charge effective dates.\",\n        \"confidence\": 0.96,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"BL-OT-INVRATABLE\",\n            \"why_not\": \"This would release upon billing and recognize invoice-ratably; the stated pattern is simple recurring with booking-based ratable recognition.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Allocations are disabled (isAllocationEligible=false) per requirement.\",\n      \"Selected POB template BK-OT-RATABLE to support standard over-time SaaS recognition for a recurring in-advance billed charge.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "b2c-monthly-simple",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:39:31.528Z"
      }
    },
    {
      "id": "1a06cc34-0ac3-4e09-8705-b112fd1a12ee",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Consumer User\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Consumer streaming service:\\n- $9.99/month subscription\\n- Monthly billing in advance\\n- No allocations required\\n- Simple recurring revenue recognition\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Streaming Subscription - Monthly Fee\",\n      \"Rate Plan\": \"Consumer Streaming - Monthly\",\n      \"Product\": \"Consumer Streaming Service\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 9.99,\n      \"Amount\": 9.99,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 119.88,\n    \"schedule_total\": 119.88,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Monthly recurring fee is $9.99 per month (quantity = 1) billed In Advance on the first day of each calendar month.\",\n    \"Service term is interpreted as 12 contiguous calendar monthly service periods from 01/01/2025 through 12/31/2025 with no proration required.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "b2c-monthly-simple",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:39:43.748Z"
      }
    },
    {
      "id": "ee22964b-a7dc-440d-b231-f893fa52ddc8",
      "step_name": "contracts_orders",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the RC_LINE (Contracts/Orders) table. This table is the foundation for revenue recognition—every charge becomes a line item with pricing and allocation data.\n\n**Tip**: Use `code_interpreter` for allocation math and validation calculations.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, dates, quantities\n- **POB mapping** — template assignments for each charge (use these exactly)\n- **Contract intel** — dates and terms\n- **Allocation settings** — is_allocations flag and method\n\n---\n\n## Line Item Generation\n\n### One Line Per Charge\n\nCreate exactly ONE row for each charge from the subscription spec:\n\n| Charge in Sub Spec | → Line in Contracts/Orders |\n|-------------------|---------------------------|\n| \"Platform License - Year 1\" | Line 1: Platform License - Year 1 |\n| \"Platform License - Year 2\" | Line 2: Platform License - Year 2 |\n| \"Implementation Fee\" | Line 3: Implementation Fee |\n\n### Line Item Fields\n\nFor each line, populate:\n\n**Identity:**\n- `Line Item Num`: Charge name from subscription spec\n- `POB Name`: Charge name from subscription spec\n- `POB Template`: From POB mapping (exact match)\n- `POB IDENTIFIER`: From POB mapping (exact match)\n- `Customer Name`: From input\n- `Subscription Name`: From subscription spec\n- `Subscription Version`: 1 (for new) or increment for amendments\n\n**Charge Details:**\n- `RPC Segment`: Charge name reference\n- `RPC Type`: Recurring/OneTime/Usage\n- `Billing Period`: Month/Quarter/Annual\n- `Billing Timing`: InAdvance/InArrears\n- `Trigger Event`: From charge\n- `Terms Months`: From contract intel\n\n**Revenue Window:**\n- `Revenue Start Date`: From charge effectiveStartDate (YYYY-MM-DD format)\n- `Revenue End Date`: From charge effectiveEndDate (YYYY-MM-DD format)\n- `Sales Order Date`: Contract effective date (MM/DD/YYYY format)\n\n**Pricing:**\n- `Ordered Qty`: From charge quantity (default 1)\n- `Unit List Price`: From charge listPrice\n- `Unit Sell Price`: From charge sellPrice\n- `Ext List Price`: Qty × Unit List Price\n- `Ext Sell Price`: Qty × Unit Sell Price\n\n**Allocation (see below):**\n- `SSP Price`: Unit SSP (typically = Unit List Price unless override)\n- `Ext SSP Price`: Qty × SSP Price\n- `SSP Percent`: Line Ext SSP / Total Ext SSP × 100\n- `Ext Allocated Price`: Result of allocation calculation\n- `Allocation Eligible Flag`: true if is_allocations=true\n\n**Status:**\n- `Release Event`: From POB mapping\n- `POB Satisfied`: \"Over Time\" or \"Point In Time\" from template\n- `Lead Line`: true for first/main line, false for others\n- `Carves Adjustment`: 0 (unless explicit carve)\n- `Unreleased Revenue`: = Ext Allocated Price (initially)\n- `Released Revenue`: 0 (initially)\n\n**Classification:**\n- `Product Category`: Infer from charge/product name\n- `Product Family`: Infer from charge/product name\n\n---\n\n## Allocation Calculations\n\n### When is_allocations = false\n- `Ext Allocated Price` = `Ext Sell Price`\n- `SSP Percent` = proportional to Ext Sell Price\n- No redistribution\n\n### When is_allocations = true\n\n**Step 1: Calculate SSP totals**\n```\nTotal Ext SSP = Sum of all Ext SSP Price\nTotal Transaction Price = Sum of all Ext Sell Price\n```\n\n**Step 2: Calculate SSP percentages**\n```\nFor each line:\nSSP Percent = (Line Ext SSP Price / Total Ext SSP) × 100\n```\n\n**Step 3: Allocate transaction price**\n```\nFor each line:\nExt Allocated Price = Total Transaction Price × (SSP Percent / 100)\n```\n\n**Step 4: Validate**\n- Sum of Ext Allocated Price must equal Sum of Ext Sell Price\n\n### Ramp Deals (Override Standard Allocation)\n\nWhen charges are ramp segments (same service, different periods/prices):\n\n1. Group ramp charges together\n2. Calculate average price across all ramp periods:\n   - **Term-based**: Simple average of period prices\n   - **Volume-based**: Weighted by quantities\n3. Allocate using average price for each period\n\n**Example:** Year 1: $10,000, Year 2: $12,000, Year 3: $14,000\n- Total: $36,000 over 3 years\n- Term-based average: $12,000/year\n- Each year allocates as if $12,000 (recognition spread evenly)\n\nRef: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals/ramp-allocation-in-zuora-advanced-revenue\n\n### Variable Consideration (VC)\n\nWhen charges have uncertain amounts (rebates, refund rights, performance bonuses):\n\n**VC Allocation Decision (RC-Level 2-Step):**\n1. Compare RC-level Transaction Price % (TP%) with line-level TP% for all lines\n2. If ALL lines within RC TP% range → NO allocation needed\n3. If any line outside range → exclude VC lines, repeat step 2\n4. If still outside after excluding VC → allocate with ALL lines included\n\n**VC Constraint (ASC 606-10-32-11):**\n- Only include VC to extent a significant reversal is NOT probable\n- Consider: likelihood of reversal, magnitude, threshold for constraint\n- If constrained, set VC amount to the constrained estimate\n- When uncertainty resolves, adjust in that period\n\n### Carves (Carve-In / Carve-Out)\n\nWhen specific POBs need revenue adjustment:\n- `Carves Adjustment` reflects movement between POBs\n- Net sum of all carves = 0\n- Carve-out reduces source POB, carve-in increases destination\n\n---\n\n## Special Scenarios\n\n### Bundle Explosion\n\nWhen one billing charge creates multiple revenue lines:\n\n**Example:** \"Enterprise Suite - $50,000\" explodes to:\n| Line | POB Name | Template | Sell $ | Allocated $ |\n|------|----------|----------|--------|-------------|\n| 1 | License (from Bundle) | BK-OT-RATABLE | 30,000 | 30,000 |\n| 2 | Support (from Bundle) | BK-OT-RATABLE | 15,000 | 15,000 |\n| 3 | Training (from Bundle) | GO-LIVE-PIT | 5,000 | 5,000 |\n\n**Key rules:**\n- Each child component gets its own Line Item Num\n- SSP comes from bundle configuration\n- Allocate across components based on relative SSP\n- Sum of child Ext Allocated Price = Original bundle price\n- RPC Segment should reference the parent bundle charge\n\n**Document in assumptions:**\n- \"Bundle explosion applied to [charge name]\"\n- \"SSP percentages: License 60%, Support 30%, Training 10%\"\n\n### Contract Modifications\n\n**New Contract (Version 1):**\n- Fresh allocation across all lines\n\n**Amendment (Version 2+):**\n- Increment Subscription Version\n- Sales Order Date = Amendment effective date\n\n**Retrospective Treatment:**\n- Recalculate ALL lines (existing + modified) from contract inception\n- Ext Allocated Price reflects new allocation\n- Prior period adjustments shown as Released Revenue adjustments\n\n**Prospective Treatment:**\n- Only new/modified lines participate in allocation\n- Existing lines keep their original Ext Allocated Price\n- Unreleased Revenue from existing lines remains unchanged\n\n---\n\n## Output\n\nReturn JSON with ALL fields populated:\n\n```json\n{\n  \"zr_contracts_orders\": [\n    {\n      \"POB Name\": \"Platform License\",\n      \"POB Template\": \"BK-OT-RATABLE\",\n      \"POB Satisfied\": \"Over Time\",\n      \"Release Event\": \"Upon Booking (Full Booking Release)\",\n      \"Billing Period\": \"Month\",\n      \"Billing Timing\": \"InAdvance\",\n      \"Terms Months\": 12,\n      \"Trigger Event\": \"ContractEffective\",\n      \"Lead Line\": true,\n      \"Ordered Qty\": 1,\n      \"Line Item Num\": 1,\n      \"Subscription Name\": \"Acme Corp - Subscription\",\n      \"Subscription Version\": 1,\n      \"Sales Order Date\": \"01/01/2026\",\n      \"RPC Segment\": \"Platform License\",\n      \"RPC Type\": \"Recurring\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Unit List Price\": 1200,\n      \"Unit Sell Price\": 1000,\n      \"Ext List Price\": 1200,\n      \"Ext Sell Price\": 1000,\n      \"SSP Price\": 1200,\n      \"Ext SSP Price\": 1200,\n      \"SSP Percent\": 100,\n      \"Ext Allocated Price\": 1000,\n      \"Carves Adjustment\": 0,\n      \"Allocation Eligible Flag\": true,\n      \"Unreleased Revenue\": 1000,\n      \"Released Revenue\": 0,\n      \"Customer Name\": \"Acme Corp\",\n      \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n      \"Product Category\": \"Software\",\n      \"Product Family\": \"Platform\"\n    }\n  ],\n  \"assumptions\": [\"SSP equals List Price for all lines\"],\n  \"open_questions\": []\n}\n```\n\n**Critical validations before returning:**\n1. Sum(Ext Allocated Price) = Sum(Ext Sell Price) (within $0.01)\n2. Sum(SSP Percent) = 100% for allocation-eligible lines\n3. Revenue Start Date ≤ Revenue End Date for all lines\n4. Every charge from subscription spec has a corresponding line\n5. POB identifiers match the POB mapping exactly\n6. Unreleased + Released = Ext Allocated Price for each line\n7. For bundles: Sum(child Ext Allocated Price) = Parent bundle price\n\n---\n\n## Reference Documentation\n\n- SSP Allocation: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/ssp-assignment-and-allocation\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"European GmbH\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"EUR\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"European SaaS subscription:\\n- €500/month for platform access\\n- Monthly billing in advance\\n- 12-month term\\n- All amounts in EUR\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Platform Access Fee\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"European GmbH - SaaS Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/01/2025\",\n        \"RPC Segment\": \"Platform Access Fee\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-01\",\n        \"Revenue End Date\": \"2025-12-31\",\n        \"Unit List Price\": 500,\n        \"Unit Sell Price\": 500,\n        \"Ext List Price\": 6000,\n        \"Ext Sell Price\": 6000,\n        \"SSP Price\": 500,\n        \"Ext SSP Price\": 6000,\n        \"SSP Percent\": 100,\n        \"Ext Allocated Price\": 6000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 6000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"European GmbH\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Software\",\n        \"Product Family\": \"Platform\"\n      }\n    ],\n    \"assumptions\": [\n      \"No allocations enabled (is_allocations=false), so Ext Allocated Price equals Ext Sell Price.\",\n      \"Monthly price (€500) is used as both Unit List Price and Unit Sell Price because no separate list price/discount details were provided.\",\n      \"Ordered Qty is set to 12 to represent 12 monthly billing periods so that Ext prices follow Ext = Unit × Qty.\"\n    ],\n    \"open_questions\": [\n      \"Do you want Unit List Price to reflect a different (undiscounted) list price than the Unit Sell Price (€500), if your pricing model tracks list vs sell separately?\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Platform Access Fee\",\n        \"productName\": \"European Platform\",\n        \"ratePlanName\": \"Platform Access - Monthly\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Standard SaaS recurring subscription billed monthly in advance; release at booking and recognize ratably over the service period aligned to the charge effective dates (01/01/2025–12/31/2025).\",\n        \"confidence\": 0.97,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"Invoice Ratable (Billed Release)\",\n            \"why_not\": \"Billing timing is InAdvance and the use case does not require billed-release (invoice-ratable) recognition; booking-based ratable is the standard pattern here.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"DS-006 alignment check: recognition_window matches the charge effective service dates (2025-01-01 through 2025-12-31).\",\n      \"No usage/consumption charges are present; therefore no usage records are generated.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "eur-currency-subscription",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:43:36.891Z"
      }
    },
    {
      "id": "b9a31f60-0f2f-4f23-b3c4-7ec353d495f3",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"European GmbH\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"EUR\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"European SaaS subscription:\\n- €500/month for platform access\\n- Monthly billing in advance\\n- 12-month term\\n- All amounts in EUR\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Platform Access Fee\",\n      \"Rate Plan\": \"European Platform\",\n      \"Product\": \"Platform Access\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"EUR\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 6000,\n    \"schedule_total\": 6000,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is interpreted as fixed-fees-only and equals €500 × 12 months = €6,000 (no usage or one-time charges provided).\",\n    \"Monthly billing periods align to calendar months from 01/01/2025 through 12/31/2025; no proration is required because the service start/end align to month boundaries.\",\n    \"Because Billing Timing is explicitly InAdvance, Billing Date is set to the start of each monthly service period.\",\n    \"Invoice Date is assumed to equal Billing Date for each billing event (invoice generated on the period start date).\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "eur-currency-subscription",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:43:51.692Z"
      }
    },
    {
      "id": "92f1b6ca-d84e-4c3d-92f7-c4949b6bba9e",
      "step_name": "design_subscription",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Solution Architect designing a complete billing and revenue solution. You will create:\n1. **Zuora Billing Subscription** — rate plans, charges, dates, terms\n2. **Zuora Revenue POB Mappings** — template assignments for each charge\n\nBy designing both together, you ensure billing structures align with rev rec requirements and catch mismatches early.\n\n**CRITICAL CONSTRAINT**: You can ONLY use POB identifiers from the \"Available ZR POB templates\" list provided. NEVER invent identifiers.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contract dates** — serviceStart, serviceEnd, termMonths (authoritative)\n- **Billing config** — period, timing, trigger event\n- **Allocations flag** — is_allocations (true/false)\n- **Golden use cases** — matched reference patterns\n- **Reference data** — example subscriptions and charges\n- **POB templates** — the ONLY valid identifiers to use\n\n---\n\n## STEP 1: Design Charges\n\n### Charge Type Decision Tree\n\n```\nIs it a one-time fee?\n  ├─ YES → type: \"OneTime\", model: \"FlatFee\"\n  │        billingPeriod: null\n  │        → Skip to STEP 2 for POB\n  │\n  └─ NO → Is it based on usage/consumption?\n          ├─ YES → type: \"Usage\", model varies\n          │        └─ Per unit? → model: \"PerUnit\"\n          │        └─ Tiered? → model: \"Tiered\"\n          │        └─ Overage? → model: \"Overage\"\n          │        → Skip to STEP 2 for POB\n          │\n          └─ NO → type: \"Recurring\"\n                  └─ Flat amount? → model: \"FlatFee\"\n                  └─ Per seat/unit? → model: \"PerUnit\"\n                  └─ Volume-based? → model: \"Volume\"\n                  → Skip to STEP 2 for POB\n```\n\n### Charge Fields Required\n\n| Field | Recurring | OneTime | Usage |\n|-------|-----------|---------|-------|\n| name | ✓ | ✓ | ✓ |\n| type | \"Recurring\" | \"OneTime\" | \"Usage\" |\n| model | FlatFee/PerUnit/Volume/Tiered | FlatFee | PerUnit/Tiered/Overage |\n| billingPeriod | Month/Quarter/Annual/Semi-Annual | null | Month (rating period) |\n| billingTiming | InAdvance/InArrears | null | InArrears |\n| triggerEvent | ContractEffective | ContractEffective | ContractEffective |\n| quantity | number or null | number or null | null (from usage) |\n| listPrice | $ | $ | $ per unit |\n| sellPrice | $ | $ | $ per unit |\n| effectiveStartDate | MM/DD/YYYY | MM/DD/YYYY | MM/DD/YYYY |\n| effectiveEndDate | MM/DD/YYYY or null | null | MM/DD/YYYY or null |\n\n### Usage Records Generation\n\n**If any Usage charges are present, you MUST generate sample usage records within the subscription term.**\n\nUsage records should:\n- Fall within the charge's effective date range\n- Use the charge's UOM\n- Include realistic quantities based on the use case context\n- Cover multiple periods if the subscription spans multiple billing cycles\n\nExample usage record:\n```json\n{\n  \"chargeName\": \"API Calls\",\n  \"startDate\": \"2026-01-01\",\n  \"endDate\": \"2026-01-31\",\n  \"quantity\": 50000,\n  \"uom\": \"API Call\"\n}\n```\n\n### CRITICAL: Charge Segmentation for Price Changes\n\n**When prices change during the term, create SEPARATE charges for each period.**\n\nPatterns requiring segmentation:\n- Year-over-year ramps (\"Year 1: $100, Year 2: $120\")\n- Introductory pricing (\"First 3 months $15, then $20\")\n- Promotional periods (\"50% off for 6 months\")\n\n**Example:** 12-month contract, $15/mo for months 1-3, $20/mo for months 4-12\n```\nCharge 1: \"Service - Promo\", start: 01/01/2026, end: 03/31/2026, sellPrice: 15\nCharge 2: \"Service - Standard\", start: 04/01/2026, end: 12/31/2026, sellPrice: 20\n```\n\n**DO NOT average prices into a single charge. Each distinct price = separate charge.**\n\n---\n\n## STEP 2: Assign POB Templates\n\nFor EACH charge you created, assign a POB template from the provided list.\n\n### POB Selection Matrix\n\n| Charge Type | Billing Timing | Recognition | → POB Identifier |\n|-------------|---------------|-------------|------------------|\n| Recurring | InAdvance | Over time (standard SaaS) | `BK-OT-RATABLE` |\n| Recurring | InAdvance | Over time with VC | `BK-OT-CONSUMP-RATABLE-VC` |\n| Recurring | InArrears | Over time (invoice ratable) | `BL-OT-INVRATABLE` |\n| OneTime | — | Immediate at booking (start date) | `BK-PIT-STARTDATE` |\n| OneTime | — | Immediate at booking (current period) | `BK-PIT-CURRENT_PERIOD` |\n| OneTime | — | Immediate at billing (start date) | `BL-PIT-STARTDATE` |\n| OneTime | — | Immediate at billing (current period) | `BL-PIT-CURRENT_PERIOD` |\n| OneTime | — | Spread over term | `BK-OT-RATABLE` |\n| OneTime | — | Upon acceptance | `EVT-PIT-ACCEPTAN` |\n| OneTime | — | Upon go-live | `EVT-OT-RATABLE-GOLIVE` |\n| Usage | — | Upon consumption event | `EVT-PIT-CONSUMP-USAGE` |\n| Usage | — | Upon billing | `BL-PIT-CONSUMP-PAYGO` |\n\n### POB Identifier Naming Convention\n\n| Prefix | Meaning |\n|--------|---------|\n| `BK-` | Release upon Booking |\n| `BL-` | Release upon Billing |\n| `EVT-` | Release upon Event |\n| `-OT-` | Over Time (ratable) |\n| `-PIT-` | Point In Time (immediate) |\n\n---\n\n## Special Patterns\n\n### Prepay Drawdown (PPDD)\n\nWhen the use case involves prepaid credits:\n\n| Charge | Type | Model | POB |\n|--------|------|-------|-----|\n| Prepayment | OneTime or Recurring | FlatFee | See below |\n| Drawdown | Usage | PerUnit | `EVT-PIT-CONSUMP-USAGE` |\n| Overage (optional) | Usage | PerUnit | `BL-PIT-CONSUMP-PAYGO` |\n\n**PPDD POB Decision:**\n- \"Recognize ratably over time\" → Prepayment uses `BK-OT-CONSUMP-RATABLE`\n- \"Recognize as credits consumed\" → Prepayment stays deferred, Drawdown triggers recognition via `EVT-PIT-CONSUMP-USAGE`\n\n⚠️ **Critical distinction:** If the use case says revenue is recognized \"as credits are consumed\", \"upon consumption\", or \"as-used\":\n- Do NOT use a ratable template for the prepayment\n- Prepayment revenue stays deferred until consumption occurs\n- The Drawdown charge's consumption events trigger actual recognition\n- Revenue waterfall for prepayment shows $0 until usage posts\n\n**IMPORTANT:** When PPDD charges are present, you MUST generate usage records for the Drawdown charge showing credit consumption events during the subscription term.\n\n### Contract Amendments\n\n**Retrospective (same POB, price/qty change):**\n- Original charge: shorten end date to mod_date - 1\n- New charge: from mod_date to original end\n\n**Prospective (new POB added):**\n- Original charge: unchanged\n- New charge: separate for new deliverable\n\n### Bundle Explosion\n\nWhen one billing line has multiple POBs:\n- Create ONE charge in billing\n- Note in assumptions: \"Bundle explosion applies\"\n- List child components and their POBs in assumptions\n\n---\n\n## Output\n\nReturn JSON with complete structure. Every charge MUST have a corresponding POB mapping.\n\n```json\n{\n  \"subscription\": {\n    \"name\": \"Customer Name - Subscription\",\n    \"termType\": \"TERMED\",\n    \"status\": \"Active\",\n    \"currency\": \"USD\",\n    \"contractEffectiveDate\": \"MM/DD/YYYY\",\n    \"serviceActivationDate\": \"MM/DD/YYYY\",\n    \"customerAcceptanceDate\": \"MM/DD/YYYY\",\n    \"subscriptionStartDate\": \"MM/DD/YYYY\",\n    \"subscriptionEndDate\": \"MM/DD/YYYY or null\",\n    \"initialTerm\": 12,\n    \"initialTermPeriodType\": \"Month\",\n    \"renewalTerm\": 12,\n    \"renewalTermPeriodType\": \"Month\",\n    \"autoRenew\": true\n  },\n  \"rate_plans\": [\n    {\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"charges\": [\n        {\n          \"name\": \"Charge Name\",\n          \"type\": \"Recurring\",\n          \"model\": \"FlatFee\",\n          \"uom\": null,\n          \"billingPeriod\": \"Month\",\n          \"billingTiming\": \"InAdvance\",\n          \"billingDay\": null,\n          \"billingPeriodAlignment\": null,\n          \"listPriceBase\": null,\n          \"triggerEvent\": \"ContractEffective\",\n          \"specificTriggerDate\": null,\n          \"endDateCondition\": null,\n          \"specificEndDate\": null,\n          \"quantity\": 1,\n          \"listPrice\": 100,\n          \"sellPrice\": 100,\n          \"price\": 100,\n          \"effectiveStartDate\": \"MM/DD/YYYY\",\n          \"effectiveEndDate\": \"MM/DD/YYYY or null\",\n          \"chargeFunction\": null,\n          \"isAllocationEligible\": true,\n          \"drawdownType\": null,\n          \"commitmentType\": null,\n          \"prepaymentUOM\": null,\n          \"prepaymentUnits\": null,\n          \"validityPeriod\": null\n        }\n      ]\n    }\n  ],\n  \"usage\": [\n    {\n      \"chargeName\": \"API Calls\",\n      \"startDate\": \"2026-01-01\",\n      \"endDate\": \"2026-01-31\",\n      \"quantity\": 50000,\n      \"uom\": \"API Call\"\n    }\n  ],\n  \"charge_pob_map\": [\n    {\n      \"chargeName\": \"Charge Name\",\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"pob_identifier\": \"BK-OT-RATABLE\",\n      \"pob_name\": \"Template Name\",\n      \"ratable_method\": \"Ratable\",\n      \"release_event\": \"Upon Booking (Full Booking Release)\",\n      \"recognition_window\": {\n        \"start\": \"YYYY-MM-DD\",\n        \"end\": \"YYYY-MM-DD or null\"\n      },\n      \"rationale\": \"Standard SaaS recurring - release at booking, recognize ratably over term\",\n      \"confidence\": 0.95,\n      \"alternatives\": []\n    }\n  ],\n  \"assumptions\": [\"List key assumptions made\"],\n  \"open_questions\": [\"Questions needing customer clarification\"],\n  \"mapping_notes\": [\"POB-specific notes if any\"]\n}\n```\n\n---\n\n## Reference Documentation\n\n- Subscriptions: https://docs.zuora.com/en/zuora-billing/manage-orders/order-actions/create-subscriptions\n- Rate Plan Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/product-catalog-configurations/create-product-rate-plan-charges\n- Tiered Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-pricing\n- Volume Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/volume-pricing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion\n- POB Templates: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/create-pob-template\n- POB Ratable Methods: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/predefined-pob-ratable-methods"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Upgrade Customer\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"SaaS subscription with mid-term upgrade:\\n- Original: Basic tier at $100/month (Jan-Jun)\\n- Amendment: Upgrade to Pro tier at $200/month (Jul-Dec)\\n- Amendment effective July 1, 2025\\n- Co-termed to original end date\\n- Prorate any billing adjustments\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"subscription_spec\": {\n    \"subscription\": {\n      \"name\": \"Upgrade Customer - Subscription\",\n      \"termType\": \"TERMED\",\n      \"status\": \"Active\",\n      \"currency\": \"USD\",\n      \"contractEffectiveDate\": \"01/01/2025\",\n      \"serviceActivationDate\": \"01/01/2025\",\n      \"customerAcceptanceDate\": \"01/01/2025\",\n      \"subscriptionStartDate\": \"01/01/2025\",\n      \"subscriptionEndDate\": \"12/31/2025\",\n      \"initialTerm\": 12,\n      \"initialTermPeriodType\": \"Month\",\n      \"renewalTerm\": 12,\n      \"renewalTermPeriodType\": \"Month\",\n      \"autoRenew\": false\n    },\n    \"rate_plans\": [\n      {\n        \"productName\": \"SaaS Platform\",\n        \"ratePlanName\": \"Basic Tier\",\n        \"charges\": [\n          {\n            \"name\": \"Basic Tier - Monthly Fee\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"\",\n            \"billingPeriodAlignment\": \"\",\n            \"listPriceBase\": \"\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"\",\n            \"endDateCondition\": \"\",\n            \"specificEndDate\": \"\",\n            \"quantity\": 1,\n            \"listPrice\": 100,\n            \"sellPrice\": 100,\n            \"price\": 100,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"06/30/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"\",\n            \"commitmentType\": \"\",\n            \"prepaymentUOM\": \"\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"\"\n          }\n        ]\n      },\n      {\n        \"productName\": \"SaaS Platform\",\n        \"ratePlanName\": \"Pro Tier\",\n        \"charges\": [\n          {\n            \"name\": \"Pro Tier - Monthly Fee\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"\",\n            \"billingPeriodAlignment\": \"\",\n            \"listPriceBase\": \"\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"\",\n            \"endDateCondition\": \"\",\n            \"specificEndDate\": \"\",\n            \"quantity\": 1,\n            \"listPrice\": 200,\n            \"sellPrice\": 200,\n            \"price\": 200,\n            \"effectiveStartDate\": \"07/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"\",\n            \"commitmentType\": \"\",\n            \"prepaymentUOM\": \"\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"\"\n          }\n        ]\n      }\n    ],\n    \"usage\": [],\n    \"assumptions\": [\n      \"Upgrade effective date is exactly 07/01/2025 (start of a monthly billing period), so there is no partial-month proration within July itself; any adjustments would be limited to timing of invoice generation (credit/debit if July was previously billed at the Basic rate).\",\n      \"No discounts, credits, or separate proration adjustment charges were explicitly provided; only the stated $100/mo (Jan–Jun) and $200/mo (Jul–Dec) fees are modeled.\",\n      \"DO ALLOCATIONS = false, so isAllocationEligible is set to false for all charges and no SSP allocation assumptions are applied.\"\n    ],\n    \"open_questions\": [\n      \"Should auto-renew be enabled after 12/31/2025? (Set to false by default here.)\",\n      \"Will the amendment be created after an in-advance invoice for the July 2025 period has already posted, requiring an explicit proration credit/debit on the invoice, or will billing be run after the amendment so invoices are cleanly at $200/mo starting July?\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Basic Tier - Monthly Fee\",\n        \"productName\": \"SaaS Platform\",\n        \"ratePlanName\": \"Basic Tier\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-06-30\"\n        },\n        \"rationale\": \"Recurring SaaS fee billed monthly in advance; release upon booking and recognize ratably over the charge’s service period (pre-upgrade segment).\",\n        \"confidence\": 0.95,\n        \"alternatives\": []\n      },\n      {\n        \"chargeName\": \"Pro Tier - Monthly Fee\",\n        \"productName\": \"SaaS Platform\",\n        \"ratePlanName\": \"Pro Tier\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-07-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Recurring SaaS fee billed monthly in advance; upgrade is a prospective contract modification and is recognized ratably over the post-upgrade service period (co-termed).\",\n        \"confidence\": 0.95,\n        \"alternatives\": []\n      }\n    ],\n    \"mapping_notes\": [\n      \"Mid-term upgrade is modeled as two recurring charge segments with aligned effective dates to avoid revenue window misalignment.\",\n      \"Revenue treatment uses BK-OT-RATABLE for both segments (in-advance recurring SaaS). The contract modification is prospective: shorten the original segment end date to 06/30/2025 and start the new segment on 07/01/2025, co-termed to 12/31/2025.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "amendment-upgrade",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:47:26.742Z"
      }
    },
    {
      "id": "823b79cd-1d21-413b-96a2-adc77cac5869",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Upgrade Customer\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"SaaS subscription with mid-term upgrade:\\n- Original: Basic tier at $100/month (Jan-Jun)\\n- Amendment: Upgrade to Pro tier at $200/month (Jul-Dec)\\n- Amendment effective July 1, 2025\\n- Co-termed to original end date\\n- Prorate any billing adjustments\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Basic Tier - Monthly Fee\",\n      \"Rate Plan\": \"Basic Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Pro Tier - Monthly Fee\",\n      \"Rate Plan\": \"Pro Tier\",\n      \"Product\": \"SaaS Platform\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 200,\n      \"Amount\": 200,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1800,\n    \"schedule_total\": 1800,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is interpreted as fixed-fees-only for the 12-month term (no usage, no one-time charges, no discounts): (6 × $100) + (6 × $200) = $1,800.\",\n    \"Billing is Monthly InAdvance with invoice/billing date equal to each monthly service period start date.\",\n    \"Upgrade amendment is effective on 07/01/2025 (a billing period boundary), so no proration/credit-debit adjustments are required.\"\n  ],\n  \"open_questions\": []\n}"
        }
      ],
      "metadata": {
        "test_case_id": "amendment-upgrade",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:52:44.126Z"
      }
    },
    {
      "id": "d1c5ed5a-dd8f-413e-8d4a-cc976ea162f6",
      "step_name": "billings",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Billing expert generating the complete invoice schedule. For each charge in the subscription, calculate when invoices are generated and for what amounts.\n\n**Tip**: Use `code_interpreter` for date arithmetic and amount calculations if helpful.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Subscription spec** — charges with pricing, billing period, billing timing\n- **Contract intel** — serviceStart, serviceEnd, termMonths\n\n---\n\n## Billing Schedule Generation\n\n### By Charge Type\n\n**Recurring Charges:**\nGenerate one billing row per billing period from effectiveStartDate to effectiveEndDate.\n\n**OneTime Charges:**\nGenerate one billing row on the trigger date.\n\n**Usage Charges:**\n- If usage records provided: Calculate billing per usage period\n- If no usage: Note in open_questions that usage billing is TBD\n\n---\n\n## Billing Date Calculation\n\n### Billing Timing Rules\n\n| billingTiming | Billing Date | Service Covered |\n|---------------|--------------|-----------------|\n| InAdvance | Period Start | Start → End of period |\n| InArrears | Period End | Start → End of period |\n\n### Billing Period Lengths\n\n| billingPeriod | Duration |\n|---------------|----------|\n| Month | 1 month |\n| Quarter | 3 months |\n| Semi-Annual | 6 months |\n| Annual | 12 months |\n\n---\n\n## Step-by-Step for Recurring Charges\n\n1. **Identify billing periods:**\n   - Start at charge effectiveStartDate\n   - End at charge effectiveEndDate (or subscriptionEndDate if null)\n   - Divide into periods based on billingPeriod\n\n2. **Calculate billing dates:**\n   - InAdvance: billing date = period start date\n   - InArrears: billing date = period end date\n\n3. **Calculate amounts:**\n   - Full period: Amount = quantity × unitPrice\n   - Partial period (proration): Amount = fullAmount × (days in partial / days in full period)\n\n### Proration Rules\n\nProrate when:\n- First period starts mid-period (e.g., Jan 15 for monthly billing)\n- Last period ends mid-period (e.g., ends June 15 for monthly billing)\n- Charge effectiveDates don't align with billing period boundaries\n\n**Proration calculation:**\n```\nProrated Amount = Full Period Amount × (Actual Days / Full Period Days)\n```\n\n---\n\n## Examples\n\n### Example 1: Monthly In Advance, 12 months\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | 01/01/2026 | 01/31/2026 | $100 |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 |\n| ... | ... | ... | ... | $100 |\n| 12/01/2026 | 12/01/2026 | 12/01/2026 | 12/31/2026 | $100 |\n\n### Example 2: Quarterly In Arrears\n- Contract: 01/01/2026 - 12/31/2026\n- Charge: $3,000/quarter, Quarterly, InArrears\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount |\n|--------------|--------------|--------------|------------|--------|\n| 03/31/2026 | 03/31/2026 | 01/01/2026 | 03/31/2026 | $3,000 |\n| 06/30/2026 | 06/30/2026 | 04/01/2026 | 06/30/2026 | $3,000 |\n| 09/30/2026 | 09/30/2026 | 07/01/2026 | 09/30/2026 | $3,000 |\n| 12/31/2026 | 12/31/2026 | 10/01/2026 | 12/31/2026 | $3,000 |\n\n### Example 3: Annual In Advance, One-Time Fee\n- Contract: 01/01/2026 - 12/31/2026\n- Charge 1: Annual license $12,000, Annual, InAdvance\n- Charge 2: Implementation $5,000, OneTime\n\n| Invoice Date | Billing Date | Charge Name | Period Start | Period End | Amount |\n|--------------|--------------|-------------|--------------|------------|--------|\n| 01/01/2026 | 01/01/2026 | Annual License | 01/01/2026 | 12/31/2026 | $12,000 |\n| 01/01/2026 | 01/01/2026 | Implementation | 01/01/2026 | 01/01/2026 | $5,000 |\n\n### Example 4: Proration (Mid-Month Start)\n- Contract: 01/15/2026 - 12/31/2026\n- Charge: $100/month, Monthly, InAdvance\n\n| Invoice Date | Billing Date | Period Start | Period End | Amount | Notes |\n|--------------|--------------|--------------|------------|--------|-------|\n| 01/15/2026 | 01/15/2026 | 01/15/2026 | 01/31/2026 | $54.84 | 17/31 days |\n| 02/01/2026 | 02/01/2026 | 02/01/2026 | 02/28/2026 | $100 | Full month |\n| ... | ... | ... | ... | $100 | Full months |\n\n---\n\n## Contract Value Reconciliation (TCV Check) — REQUIRED\n\nBefore finalizing the invoice schedule, you MUST reconcile totals against the contract's Total Contract Value (TCV).\n\n1) **Determine the target TCV definition** (state it explicitly in the output):\n   - If the input provides **Gross TCV / Net TCV / discount %**, treat **Net TCV as the target**.\n   - If the contract includes **usage/drawdown/overage**, clarify whether TCV **includes an estimate of usage** or is **fixed-fees-only**:\n     - If an explicit usage estimate/bucket amount is provided, include it in the target.\n     - If no estimate is provided, **exclude usage from the target** and record an item in `open_questions`.\n\n2) **Compute an internal check-sum**:\n   - `schedule_total = sum(all invoice line amounts, including discounts or negative lines)`\n   - `delta = target_tcv - schedule_total`\n\n3) **Hard rule:** the final schedule MUST satisfy `abs(delta) <= $0.01`.\n   - If not, you must **recalculate** (correct unit prices, quantities, proration day-counts, discounts, drawdown/overage logic) until it matches.\n   - If matching is impossible due to missing/ambiguous inputs, do NOT guess; put the discrepancy and the missing assumption(s) in `open_questions` and provide the closest schedule with `delta` shown.\n\n4) **Discount handling:**\n   - Apply discounts either (a) as a separate negative invoice line item, or (b) by reducing each affected charge, but ensure the **net total equals Net TCV**.\n\n5) **Output requirement:** include a `totals` block showing `target_tcv`, `schedule_total`, and `delta`.\n\n---\n\n## Output\n\nReturn JSON with complete billing schedule:\n\n```json\n{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2026\",\n      \"Billing Date\": \"01/01/2026\",\n      \"Charge Name\": \"Platform License\",\n      \"Rate Plan\": \"Standard Plan\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2026\",\n      \"Billing Period End\": \"01/31/2026\",\n      \"Quantity\": 1,\n      \"Unit Price\": 100,\n      \"Amount\": 100,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 1200,\n    \"schedule_total\": 1200,\n    \"delta\": 0\n  },\n  \"assumptions\": [\"All dates are based on calendar month boundaries\"],\n  \"open_questions\": []\n}\n```\n\n**Date formats:**\n- All dates in output: `MM/DD/YYYY`\n\n**Validation before returning:**\n1. Every charge from subscription spec has billing rows\n2. Billing periods are contiguous (no gaps)\n3. Total billed per charge = quantity × unitPrice × number of periods\n4. Proration math is correct for partial periods\n5. **TCV reconciliation: schedule_total matches target_tcv (delta ≤ $0.01)**\n\n---\n\n## Reference Documentation\n\n- Billing Timing: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/billing-timing\n- Proration Overview: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/proration-overview\n- Partial Period Proration: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/proration/calculate-total-with-partial-period-proration\n- Usage Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-with-overage-charges\n- Invoice Management: https://docs.zuora.com/en/zuora-billing/manage-billing-documents/manage-invoices/invoice-management-overview\n- Bill Run Target Date: https://docs.zuora.com/en/zuora-billing/manage-bill-runs/bill-run-target-date"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Overage Corp\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Platform with committed usage:\\n- Base fee: $500/month (includes 10,000 transactions)\\n- Overage: $0.10 per transaction above 10,000\\n- Unused transactions do not roll over\\n- Base billed in advance, overage in arrears\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"zb_billings\": [\n    {\n      \"Invoice Date\": \"01/01/2025\",\n      \"Billing Date\": \"01/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"01/01/2025\",\n      \"Billing Period End\": \"01/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"02/01/2025\",\n      \"Billing Date\": \"02/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"02/01/2025\",\n      \"Billing Period End\": \"02/28/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"03/01/2025\",\n      \"Billing Date\": \"03/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"03/01/2025\",\n      \"Billing Period End\": \"03/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"04/01/2025\",\n      \"Billing Date\": \"04/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"04/01/2025\",\n      \"Billing Period End\": \"04/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"05/01/2025\",\n      \"Billing Date\": \"05/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"05/01/2025\",\n      \"Billing Period End\": \"05/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"06/01/2025\",\n      \"Billing Date\": \"06/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"06/01/2025\",\n      \"Billing Period End\": \"06/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"07/01/2025\",\n      \"Billing Date\": \"07/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"07/01/2025\",\n      \"Billing Period End\": \"07/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"08/01/2025\",\n      \"Billing Date\": \"08/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"08/01/2025\",\n      \"Billing Period End\": \"08/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"09/01/2025\",\n      \"Billing Date\": \"09/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"09/01/2025\",\n      \"Billing Period End\": \"09/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"10/01/2025\",\n      \"Billing Date\": \"10/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"10/01/2025\",\n      \"Billing Period End\": \"10/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"11/01/2025\",\n      \"Billing Date\": \"11/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"11/01/2025\",\n      \"Billing Period End\": \"11/30/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    },\n    {\n      \"Invoice Date\": \"12/01/2025\",\n      \"Billing Date\": \"12/01/2025\",\n      \"Charge Name\": \"Platform Base Fee (Includes 10,000 Transactions/Month)\",\n      \"Rate Plan\": \"Overage Platform/Platform - Base + Included Txns + Overage\",\n      \"Product\": \"Platform\",\n      \"Billing Period Start\": \"12/01/2025\",\n      \"Billing Period End\": \"12/31/2025\",\n      \"Quantity\": 1,\n      \"Unit Price\": 500,\n      \"Amount\": 500,\n      \"Currency\": \"USD\"\n    }\n  ],\n  \"totals\": {\n    \"target_tcv\": 6000,\n    \"schedule_total\": 6000,\n    \"delta\": 0\n  },\n  \"assumptions\": [\n    \"Target TCV is defined as fixed-fees-only for the 12-month term (Base Fee $500/month × 12 = $6,000) and excludes any usage overage because no usage estimate/bucket amount was provided.\",\n    \"Monthly billing periods align to calendar months with no proration (service start 01/01/2025, service end 12/31/2025).\",\n    \"Invoice Date is assumed to equal Billing Date for each billing event.\",\n    \"Overage is a monthly usage/overage charge billed in arrears; no invoice schedule rows are generated for overage without actual usage quantities.\"\n  ],\n  \"open_questions\": [\n    \"Provide actual monthly transaction counts (or rated usage results) for 01/01/2025–12/31/2025 so the monthly overage invoices can be calculated and billed in arrears.\",\n    \"Is there an expected/committed overage estimate that should be included in the contract’s target TCV, or is TCV intended to be fixed-fees-only ($6,000) with overage billed purely as incurred?\"\n  ]\n}"
        }
      ],
      "metadata": {
        "test_case_id": "usage-overage",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T20:56:45.854Z"
      }
    },
    {
      "id": "43b17d69-950c-4002-949a-31e6f9137a52",
      "step_name": "design_subscription",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Solution Architect designing a complete billing and revenue solution. You will create:\n1. **Zuora Billing Subscription** — rate plans, charges, dates, terms\n2. **Zuora Revenue POB Mappings** — template assignments for each charge\n\nBy designing both together, you ensure billing structures align with rev rec requirements and catch mismatches early.\n\n**CRITICAL CONSTRAINT**: You can ONLY use POB identifiers from the \"Available ZR POB templates\" list provided. NEVER invent identifiers.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contract dates** — serviceStart, serviceEnd, termMonths (authoritative)\n- **Billing config** — period, timing, trigger event\n- **Allocations flag** — is_allocations (true/false)\n- **Golden use cases** — matched reference patterns\n- **Reference data** — example subscriptions and charges\n- **POB templates** — the ONLY valid identifiers to use\n\n---\n\n## STEP 1: Design Charges\n\n### Charge Type Decision Tree\n\n```\nIs it a one-time fee?\n  ├─ YES → type: \"OneTime\", model: \"FlatFee\"\n  │        billingPeriod: null\n  │        → Skip to STEP 2 for POB\n  │\n  └─ NO → Is it based on usage/consumption?\n          ├─ YES → type: \"Usage\", model varies\n          │        └─ Per unit? → model: \"PerUnit\"\n          │        └─ Tiered? → model: \"Tiered\"\n          │        └─ Overage? → model: \"Overage\"\n          │        → Skip to STEP 2 for POB\n          │\n          └─ NO → type: \"Recurring\"\n                  └─ Flat amount? → model: \"FlatFee\"\n                  └─ Per seat/unit? → model: \"PerUnit\"\n                  └─ Volume-based? → model: \"Volume\"\n                  → Skip to STEP 2 for POB\n```\n\n### Charge Fields Required\n\n| Field | Recurring | OneTime | Usage |\n|-------|-----------|---------|-------|\n| name | ✓ | ✓ | ✓ |\n| type | \"Recurring\" | \"OneTime\" | \"Usage\" |\n| model | FlatFee/PerUnit/Volume/Tiered | FlatFee | PerUnit/Tiered/Overage |\n| billingPeriod | Month/Quarter/Annual/Semi-Annual | null | Month (rating period) |\n| billingTiming | InAdvance/InArrears | null | InArrears |\n| triggerEvent | ContractEffective | ContractEffective | ContractEffective |\n| quantity | number or null | number or null | null (from usage) |\n| listPrice | $ | $ | $ per unit |\n| sellPrice | $ | $ | $ per unit |\n| effectiveStartDate | MM/DD/YYYY | MM/DD/YYYY | MM/DD/YYYY |\n| effectiveEndDate | MM/DD/YYYY or null | null | MM/DD/YYYY or null |\n\n### Usage Records Generation\n\n**If any Usage charges are present, you MUST generate sample usage records within the subscription term.**\n\nUsage records should:\n- Fall within the charge's effective date range\n- Use the charge's UOM\n- Include realistic quantities based on the use case context\n- Cover multiple periods if the subscription spans multiple billing cycles\n\nExample usage record:\n```json\n{\n  \"chargeName\": \"API Calls\",\n  \"startDate\": \"2026-01-01\",\n  \"endDate\": \"2026-01-31\",\n  \"quantity\": 50000,\n  \"uom\": \"API Call\"\n}\n```\n\n### CRITICAL: Charge Segmentation for Price Changes\n\n**When prices change during the term, create SEPARATE charges for each period.**\n\nPatterns requiring segmentation:\n- Year-over-year ramps (\"Year 1: $100, Year 2: $120\")\n- Introductory pricing (\"First 3 months $15, then $20\")\n- Promotional periods (\"50% off for 6 months\")\n\n**Example:** 12-month contract, $15/mo for months 1-3, $20/mo for months 4-12\n```\nCharge 1: \"Service - Promo\", start: 01/01/2026, end: 03/31/2026, sellPrice: 15\nCharge 2: \"Service - Standard\", start: 04/01/2026, end: 12/31/2026, sellPrice: 20\n```\n\n**DO NOT average prices into a single charge. Each distinct price = separate charge.**\n\n---\n\n## STEP 2: Assign POB Templates\n\nFor EACH charge you created, assign a POB template from the provided list.\n\n### POB Selection Matrix\n\n| Charge Type | Billing Timing | Recognition | → POB Identifier |\n|-------------|---------------|-------------|------------------|\n| Recurring | InAdvance | Over time (standard SaaS) | `BK-OT-RATABLE` |\n| Recurring | InAdvance | Over time with VC | `BK-OT-CONSUMP-RATABLE-VC` |\n| Recurring | InArrears | Over time (invoice ratable) | `BL-OT-INVRATABLE` |\n| OneTime | — | Immediate at booking (start date) | `BK-PIT-STARTDATE` |\n| OneTime | — | Immediate at booking (current period) | `BK-PIT-CURRENT_PERIOD` |\n| OneTime | — | Immediate at billing (start date) | `BL-PIT-STARTDATE` |\n| OneTime | — | Immediate at billing (current period) | `BL-PIT-CURRENT_PERIOD` |\n| OneTime | — | Spread over term | `BK-OT-RATABLE` |\n| OneTime | — | Upon acceptance | `EVT-PIT-ACCEPTAN` |\n| OneTime | — | Upon go-live | `EVT-OT-RATABLE-GOLIVE` |\n| Usage | — | Upon consumption event | `EVT-PIT-CONSUMP-USAGE` |\n| Usage | — | Upon billing | `BL-PIT-CONSUMP-PAYGO` |\n\n### POB Identifier Naming Convention\n\n| Prefix | Meaning |\n|--------|---------|\n| `BK-` | Release upon Booking |\n| `BL-` | Release upon Billing |\n| `EVT-` | Release upon Event |\n| `-OT-` | Over Time (ratable) |\n| `-PIT-` | Point In Time (immediate) |\n\n---\n\n## Special Patterns\n\n### Prepay Drawdown (PPDD)\n\nWhen the use case involves prepaid credits:\n\n| Charge | Type | Model | POB |\n|--------|------|-------|-----|\n| Prepayment | OneTime or Recurring | FlatFee | See below |\n| Drawdown | Usage | PerUnit | `EVT-PIT-CONSUMP-USAGE` |\n| Overage (optional) | Usage | PerUnit | `BL-PIT-CONSUMP-PAYGO` |\n\n**PPDD POB Decision:**\n- \"Recognize ratably over time\" → Prepayment uses `BK-OT-CONSUMP-RATABLE`\n- \"Recognize as credits consumed\" → Prepayment stays deferred, Drawdown triggers recognition via `EVT-PIT-CONSUMP-USAGE`\n\n⚠️ **Critical distinction:** If the use case says revenue is recognized \"as credits are consumed\", \"upon consumption\", or \"as-used\":\n- Do NOT use a ratable template for the prepayment\n- Prepayment revenue stays deferred until consumption occurs\n- The Drawdown charge's consumption events trigger actual recognition\n- Revenue waterfall for prepayment shows $0 until usage posts\n\n**IMPORTANT:** When PPDD charges are present, you MUST generate usage records for the Drawdown charge showing credit consumption events during the subscription term.\n\n### Contract Amendments\n\n**Retrospective (same POB, price/qty change):**\n- Original charge: shorten end date to mod_date - 1\n- New charge: from mod_date to original end\n\n**Prospective (new POB added):**\n- Original charge: unchanged\n- New charge: separate for new deliverable\n\n### Bundle Explosion\n\nWhen one billing line has multiple POBs:\n- Create ONE charge in billing\n- Note in assumptions: \"Bundle explosion applies\"\n- List child components and their POBs in assumptions\n\n---\n\n## Output\n\nReturn JSON with complete structure. Every charge MUST have a corresponding POB mapping.\n\n```json\n{\n  \"subscription\": {\n    \"name\": \"Customer Name - Subscription\",\n    \"termType\": \"TERMED\",\n    \"status\": \"Active\",\n    \"currency\": \"USD\",\n    \"contractEffectiveDate\": \"MM/DD/YYYY\",\n    \"serviceActivationDate\": \"MM/DD/YYYY\",\n    \"customerAcceptanceDate\": \"MM/DD/YYYY\",\n    \"subscriptionStartDate\": \"MM/DD/YYYY\",\n    \"subscriptionEndDate\": \"MM/DD/YYYY or null\",\n    \"initialTerm\": 12,\n    \"initialTermPeriodType\": \"Month\",\n    \"renewalTerm\": 12,\n    \"renewalTermPeriodType\": \"Month\",\n    \"autoRenew\": true\n  },\n  \"rate_plans\": [\n    {\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"charges\": [\n        {\n          \"name\": \"Charge Name\",\n          \"type\": \"Recurring\",\n          \"model\": \"FlatFee\",\n          \"uom\": null,\n          \"billingPeriod\": \"Month\",\n          \"billingTiming\": \"InAdvance\",\n          \"billingDay\": null,\n          \"billingPeriodAlignment\": null,\n          \"listPriceBase\": null,\n          \"triggerEvent\": \"ContractEffective\",\n          \"specificTriggerDate\": null,\n          \"endDateCondition\": null,\n          \"specificEndDate\": null,\n          \"quantity\": 1,\n          \"listPrice\": 100,\n          \"sellPrice\": 100,\n          \"price\": 100,\n          \"effectiveStartDate\": \"MM/DD/YYYY\",\n          \"effectiveEndDate\": \"MM/DD/YYYY or null\",\n          \"chargeFunction\": null,\n          \"isAllocationEligible\": true,\n          \"drawdownType\": null,\n          \"commitmentType\": null,\n          \"prepaymentUOM\": null,\n          \"prepaymentUnits\": null,\n          \"validityPeriod\": null\n        }\n      ]\n    }\n  ],\n  \"usage\": [\n    {\n      \"chargeName\": \"API Calls\",\n      \"startDate\": \"2026-01-01\",\n      \"endDate\": \"2026-01-31\",\n      \"quantity\": 50000,\n      \"uom\": \"API Call\"\n    }\n  ],\n  \"charge_pob_map\": [\n    {\n      \"chargeName\": \"Charge Name\",\n      \"productName\": \"Product Name\",\n      \"ratePlanName\": \"Rate Plan Name\",\n      \"pob_identifier\": \"BK-OT-RATABLE\",\n      \"pob_name\": \"Template Name\",\n      \"ratable_method\": \"Ratable\",\n      \"release_event\": \"Upon Booking (Full Booking Release)\",\n      \"recognition_window\": {\n        \"start\": \"YYYY-MM-DD\",\n        \"end\": \"YYYY-MM-DD or null\"\n      },\n      \"rationale\": \"Standard SaaS recurring - release at booking, recognize ratably over term\",\n      \"confidence\": 0.95,\n      \"alternatives\": []\n    }\n  ],\n  \"assumptions\": [\"List key assumptions made\"],\n  \"open_questions\": [\"Questions needing customer clarification\"],\n  \"mapping_notes\": [\"POB-specific notes if any\"]\n}\n```\n\n---\n\n## Reference Documentation\n\n- Subscriptions: https://docs.zuora.com/en/zuora-billing/manage-orders/order-actions/create-subscriptions\n- Rate Plan Charges: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/product-catalog-configurations/create-product-rate-plan-charges\n- Tiered Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/tiered-pricing\n- Volume Pricing: https://docs.zuora.com/en/zuora-billing/manage-product-catalog/charge-model-configurations/volume-pricing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Bundle Explosion: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/bundle-explosion\n- POB Templates: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/create-pob-template\n- POB Ratable Methods: https://docs.zuora.com/en/zuora-revenue/getting-started/policy-management/performance-obligations-processing/predefined-pob-ratable-methods"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Everything Inc\",\n  \"contract_start_date\": \"01/01/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": true,\n  \"allocation_method\": \"Use List Price\",\n  \"use_case_description\": \"Complete platform deal:\\n- Platform License: $1,000/month recurring\\n- Implementation: $15,000 one-time (Month 1)\\n- Training: $5,000 one-time (Month 2)\\n- API Usage: $0.01 per call (est. 100,000/month)\\n- Storage: $0.05 per GB (est. 500 GB/month)\\n- Premium Support: $200/month recurring\\n- Mixed billing: advance for recurring, arrears for usage\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"subscription_spec\": {\n    \"subscription\": {\n      \"name\": \"Everything Inc - Complete Platform Deal (2025)\",\n      \"termType\": \"TERMED\",\n      \"status\": \"Active\",\n      \"currency\": \"USD\",\n      \"contractEffectiveDate\": \"01/01/2025\",\n      \"serviceActivationDate\": \"01/01/2025\",\n      \"customerAcceptanceDate\": \"01/01/2025\",\n      \"subscriptionStartDate\": \"01/01/2025\",\n      \"subscriptionEndDate\": \"12/31/2025\",\n      \"initialTerm\": 12,\n      \"initialTermPeriodType\": \"Month\",\n      \"renewalTerm\": 12,\n      \"renewalTermPeriodType\": \"Month\",\n      \"autoRenew\": false\n    },\n    \"rate_plans\": [\n      {\n        \"productName\": \"Everything Platform\",\n        \"ratePlanName\": \"Platform & Support (Recurring)\",\n        \"charges\": [\n          {\n            \"name\": \"Platform License\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"SubscriptionStart\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"FixedPeriod\",\n            \"specificEndDate\": \"12/31/2025\",\n            \"quantity\": 1,\n            \"listPrice\": 1000,\n            \"sellPrice\": 1000,\n            \"price\": 1000,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"SubscriptionTerm\"\n          },\n          {\n            \"name\": \"Premium Support\",\n            \"type\": \"Recurring\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"SubscriptionStart\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"FixedPeriod\",\n            \"specificEndDate\": \"12/31/2025\",\n            \"quantity\": 1,\n            \"listPrice\": 200,\n            \"sellPrice\": 200,\n            \"price\": 200,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"SubscriptionTerm\"\n          }\n        ]\n      },\n      {\n        \"productName\": \"Everything Services\",\n        \"ratePlanName\": \"Professional Services (One-Time)\",\n        \"charges\": [\n          {\n            \"name\": \"Implementation\",\n            \"type\": \"OneTime\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"ChargeTrigger\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"01/01/2025\",\n            \"quantity\": 1,\n            \"listPrice\": 15000,\n            \"sellPrice\": 15000,\n            \"price\": 15000,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"01/01/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          },\n          {\n            \"name\": \"Training\",\n            \"type\": \"OneTime\",\n            \"model\": \"FlatFee\",\n            \"uom\": \"Each\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InAdvance\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"ChargeTrigger\",\n            \"listPriceBase\": \"Per Billing Period\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"02/01/2025\",\n            \"endDateCondition\": \"SpecificEndDate\",\n            \"specificEndDate\": \"02/01/2025\",\n            \"quantity\": 1,\n            \"listPrice\": 5000,\n            \"sellPrice\": 5000,\n            \"price\": 5000,\n            \"effectiveStartDate\": \"02/01/2025\",\n            \"effectiveEndDate\": \"02/01/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": true,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          }\n        ]\n      },\n      {\n        \"productName\": \"Everything Consumption\",\n        \"ratePlanName\": \"Usage (In Arrears)\",\n        \"charges\": [\n          {\n            \"name\": \"API Usage\",\n            \"type\": \"Usage\",\n            \"model\": \"PerUnit\",\n            \"uom\": \"API Call\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InArrears\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"SubscriptionStart\",\n            \"listPriceBase\": \"Per Unit\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"FixedPeriod\",\n            \"specificEndDate\": \"12/31/2025\",\n            \"quantity\": 1200000,\n            \"listPrice\": 0.01,\n            \"sellPrice\": 0.01,\n            \"price\": 0.01,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          },\n          {\n            \"name\": \"Storage\",\n            \"type\": \"Usage\",\n            \"model\": \"PerUnit\",\n            \"uom\": \"GB\",\n            \"billingPeriod\": \"Month\",\n            \"billingTiming\": \"InArrears\",\n            \"billingDay\": \"Default\",\n            \"billingPeriodAlignment\": \"SubscriptionStart\",\n            \"listPriceBase\": \"Per Unit\",\n            \"triggerEvent\": \"ContractEffective\",\n            \"specificTriggerDate\": \"01/01/2025\",\n            \"endDateCondition\": \"FixedPeriod\",\n            \"specificEndDate\": \"12/31/2025\",\n            \"quantity\": 6000,\n            \"listPrice\": 0.05,\n            \"sellPrice\": 0.05,\n            \"price\": 0.05,\n            \"effectiveStartDate\": \"01/01/2025\",\n            \"effectiveEndDate\": \"12/31/2025\",\n            \"chargeFunction\": \"None\",\n            \"isAllocationEligible\": false,\n            \"drawdownType\": \"None\",\n            \"commitmentType\": \"None\",\n            \"prepaymentUOM\": \"None\",\n            \"prepaymentUnits\": 0,\n            \"validityPeriod\": \"None\"\n          }\n        ]\n      }\n    ],\n    \"usage\": [\n      {\n        \"Date\": \"2025-01-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-02-28\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-03-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-04-30\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-05-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-06-30\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-07-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-08-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-09-30\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-10-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-11-30\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-12-31\",\n        \"UOM\": \"API Call\",\n        \"Quantity\": 100000,\n        \"Charge Name\": \"API Usage\",\n        \"Amount\": 1000\n      },\n      {\n        \"Date\": \"2025-01-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-02-28\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-03-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-04-30\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-05-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-06-30\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-07-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-08-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-09-30\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-10-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-11-30\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      },\n      {\n        \"Date\": \"2025-12-31\",\n        \"UOM\": \"GB\",\n        \"Quantity\": 500,\n        \"Charge Name\": \"Storage\",\n        \"Amount\": 25\n      }\n    ],\n    \"assumptions\": [\n      \"No discounts or bundle credits were provided; listPrice equals sellPrice for all charges (allocation method: Use List Price as SSP).\",\n      \"Implementation is delivered as a point-in-time obligation in Month 1 on 01/01/2025; Training is delivered as a point-in-time obligation in Month 2 on 02/01/2025.\",\n      \"Usage estimates are constant each month (API Calls: 100,000/month; Storage: 500 GB/month) and the generated usage feed reflects those estimates; usage charge quantities equal the sum of the generated usage records (API: 1,200,000; Storage: 6,000).\",\n      \"Allocation eligibility: fixed consideration deliverables (platform, support, implementation, training) are allocation-eligible; usage is treated as variable consideration and is not included in upfront allocation (isAllocationEligible=false).\",\n      \"Mixed billing is implemented at the charge level: recurring charges billed InAdvance; usage charges billed InArrears.\"\n    ],\n    \"open_questions\": [\n      \"Confirm the exact delivery/recognition dates for Implementation and Training (are they truly point-in-time on 01/01/2025 and 02/01/2025, or should they be recognized upon Completion/Acceptance events?).\",\n      \"For usage revenue policy, should revenue be recognized upon consumption (usage events) or only upon billing (invoice-driven PayGo)?\",\n      \"Confirm how Storage is measured for usage (e.g., average GB-month, peak GB, or end-of-month GB) to ensure the usage feed date/quantity convention matches operations.\",\n      \"Should the subscription auto-renew after 12/31/2025? (Currently set to autoRenew=false.)\"\n    ]\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Platform License\",\n        \"productName\": \"Everything Platform\",\n        \"ratePlanName\": \"Platform & Support (Recurring)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Stand-ready platform access billed monthly in advance; release upon booking and recognize ratably over the contractual service period.\",\n        \"confidence\": 0.95,\n        \"alternatives\": []\n      },\n      {\n        \"chargeName\": \"Premium Support\",\n        \"productName\": \"Everything Platform\",\n        \"ratePlanName\": \"Platform & Support (Recurring)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Support is a stand-ready service billed monthly in advance; release upon booking and recognize ratably over the service period.\",\n        \"confidence\": 0.94,\n        \"alternatives\": []\n      },\n      {\n        \"chargeName\": \"Implementation\",\n        \"productName\": \"Everything Services\",\n        \"ratePlanName\": \"Professional Services (One-Time)\",\n        \"pob_identifier\": \"BK-PIT-STARTDATE\",\n        \"pob_name\": \"BK-PIT-STARTDATE\",\n        \"ratable_method\": \"Immediate Using Start Date\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-01-01\"\n        },\n        \"rationale\": \"One-time implementation deliverable treated as point-in-time in Month 1 (01/01/2025). Revenue recognized immediately on the start/delivery date.\",\n        \"confidence\": 0.78,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-PIT-COMPLETION\",\n            \"pob_name\": \"EVT-PIT-COMPLETION\",\n            \"why_not\": \"Use if implementation recognition must be driven by a formal completion event feed rather than the service start/delivery date.\"\n          },\n          {\n            \"pob_identifier\": \"EVT-PIT-ACCEPTAN\",\n            \"pob_name\": \"EVT-PIT-ACCEPTAN\",\n            \"why_not\": \"Use if customer acceptance is required to recognize implementation revenue, and an Acceptance event process exists.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Training\",\n        \"productName\": \"Everything Services\",\n        \"ratePlanName\": \"Professional Services (One-Time)\",\n        \"pob_identifier\": \"BK-PIT-STARTDATE\",\n        \"pob_name\": \"BK-PIT-STARTDATE\",\n        \"ratable_method\": \"Immediate Using Start Date\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-02-01\",\n          \"end\": \"2025-02-01\"\n        },\n        \"rationale\": \"One-time training deliverable treated as point-in-time in Month 2 (02/01/2025). Revenue recognized immediately on the start/delivery date.\",\n        \"confidence\": 0.78,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"EVT-PIT-COMPLETION\",\n            \"pob_name\": \"EVT-PIT-COMPLETION\",\n            \"why_not\": \"Use if training recognition must be driven by a completion event rather than the delivery date.\"\n          },\n          {\n            \"pob_identifier\": \"EVT-PIT-ACCEPTAN\",\n            \"pob_name\": \"EVT-PIT-ACCEPTAN\",\n            \"why_not\": \"Use if acceptance is required to recognize training revenue, and an Acceptance event process exists.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"API Usage\",\n        \"productName\": \"Everything Consumption\",\n        \"ratePlanName\": \"Usage (In Arrears)\",\n        \"pob_identifier\": \"EVT-PIT-CONSUMP-USAGE\",\n        \"pob_name\": \"Consumption By Usage Event\",\n        \"ratable_method\": \"Immediate Using Open Period\",\n        \"release_event\": \"Upon Consumption\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Metered API consumption billed in arrears; recognize as usage occurs using usage events (point-in-time per consumption period).\",\n        \"confidence\": 0.86,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-PIT-CONSUMP-PAYGO\",\n            \"pob_name\": \"Consumption PayGo Billing\",\n            \"why_not\": \"Use if policy is to release/recognize only upon billing (invoice-driven) rather than upon usage consumption events.\"\n          }\n        ]\n      },\n      {\n        \"chargeName\": \"Storage\",\n        \"productName\": \"Everything Consumption\",\n        \"ratePlanName\": \"Usage (In Arrears)\",\n        \"pob_identifier\": \"EVT-PIT-CONSUMP-USAGE\",\n        \"pob_name\": \"Consumption By Usage Event\",\n        \"ratable_method\": \"Immediate Using Open Period\",\n        \"release_event\": \"Upon Consumption\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-01\",\n          \"end\": \"2025-12-31\"\n        },\n        \"rationale\": \"Metered storage consumption billed in arrears; recognize as usage occurs using usage events (point-in-time per consumption period).\",\n        \"confidence\": 0.86,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-PIT-CONSUMP-PAYGO\",\n            \"pob_name\": \"Consumption PayGo Billing\",\n            \"why_not\": \"Use if storage should be recognized upon billing rather than consumption events.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"Recurring charges mapped to BK-OT-RATABLE to align with billed-in-advance SaaS (release at booking, ratable over 01/01/2025–12/31/2025).\",\n      \"One-time services mapped to BK-PIT-STARTDATE to avoid overstating the service period (effectiveEndDate equals the delivery date).\",\n      \"Usage charges mapped to EVT-PIT-CONSUMP-USAGE to recognize as consumed; ensure a consistent usage/event feed is integrated to drive recognition for each period.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "hybrid-all-charge-types",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T21:02:16.008Z"
      }
    },
    {
      "id": "1108da33-8e43-4d75-83ff-d14a533522e8",
      "step_name": "revrec_waterfall",
      "source": "evaluation_pass",
      "messages": [
        {
          "role": "system",
          "content": "You are a Zuora Revenue expert generating the monthly recognition waterfall. For each line from Contracts/Orders, calculate how revenue is recognized over time.\n\n**Tip**: Use `code_interpreter` for date arithmetic and validation calculations.\n\n---\n\n## CRITICAL: Follow WATERFALL INSTRUCTIONS\n\nEach POB in the input includes **WATERFALL INSTRUCTIONS**. These are AUTHORITATIVE. Follow them exactly:\n\n- If instructions say \"ratable\" → spread evenly over revenue window\n- If instructions say \"point-in-time\" → recognize 100% in one period\n- If instructions say \"event-driven\" → recognize ONLY when events occur\n\n**For event-driven POBs (EVT-PIT-*):** If no usage/event data provided, set Amount = $0 for all periods and add open question.\n\n---\n\n## Input Context\n\nYou will receive:\n- **Contracts/Orders table** — Line items with Ext Allocated Price, revenue dates\n- **POB mappings** — Template and WATERFALL INSTRUCTIONS for each line\n- **Contract intel** — dates and terms\n\n---\n\n## Recognition Patterns\n\n### Pattern 1: Ratable (Over Time)\n\n**POB templates:** BK-OT-*, BL-OT-* (any with \"-OT-\")\n\n**Calculation:**\n```\nDaily Rate = Ext Allocated Price / Total Days in Revenue Window\nMonthly Amount = Daily Rate × Days in Month\n```\n\n**Output:** One row per month in the revenue window.\n\n**Example:** $12,000 allocated, Jan 1 - Dec 31 (365 days)\n- Daily rate: $12,000 / 365 = $32.88/day\n- Jan (31 days): $32.88 × 31 = $1,019.18\n- Feb (28 days): $32.88 × 28 = $920.55\n- ... etc.\n\n### Pattern 2: Point-in-Time (Immediate)\n\n**POB templates:** BK-PIT-*, BL-PIT-* (any with \"-PIT-\")\n\n**Calculation:**\n```\n100% recognized in ONE period\n```\n\n**Which period?**\n| Release Event | Period |\n|--------------|--------|\n| Upon Booking | Month of Sales Order Date |\n| Upon Billing | Month of first invoice |\n| Acceptance | Month of Customer Acceptance Date |\n| Go-Live | Month of Service Activation Date |\n\n**Output:** ONE row with full Ext Allocated Price.\n\n### Pattern 3: Event-Driven (Consumption)\n\n**POB templates:** EVT-PIT-CONSUMP-*, EVT-PIT-USAGE, EVT-PIT-QTY\n\n**Calculation:**\n```\nAmount = 0 until event occurs\nWhen event: Amount = Event Quantity × Unit Rate\n```\n\n**CRITICAL:** Do NOT spread ratably. Revenue = $0 until consumption events.\n\n**If no event data provided:** All periods show $0, add open question asking for usage data.\n\n---\n\n## Ramp Deals\n\nWhen charges are ramp segments (Year 1, Year 2, Year 3 at different prices):\n\n1. Calculate average rate: Total Value / Total Months\n2. Recognize using average rate each month (consistent amounts)\n\n**Example:** Y1: $10,000, Y2: $12,000, Y3: $14,000\n- Total: $36,000 / 36 months = $1,000/month\n- Every month recognizes $1,000 (not billing amounts)\n\n---\n\n## Contract Modifications\n\n### Determination: Retrospective vs Prospective\n\n**Use Retrospective (Cumulative Catch-up) when:**\n- Change in PRICE for the SAME POB (scope unchanged)\n- Change in TERM for the SAME POB\n- No new distinct goods/services added\n\n**Use Prospective (No Restatement) when:**\n- Adding NEW distinct goods/services mid-term\n- Terminating/removing goods/services\n- The new POB should be treated separately\n\n### How ZR Structures Modifications\n\nIn Zuora Revenue, contract modifications create TWO lines in RC_LINE:\n1. **Line 1 (Original)**: End date shortened to mod date - 1\n2. **Line 2 (Post-Mod)**: From mod date to original end date\n3. Both lines share the SAME POB and are treated as ONE obligation for recognition\n\n### Retrospective (Same POB, Price/Term Change)\n\nWhen price changes on existing POB:\n\n1. Calculate NEW average rate: New Total Value / Total Months\n2. Apply to ALL periods (including closed)\n3. Catch-up = (New Rate - Old Rate) × Closed Months\n4. Show catch-up in MODIFICATION PERIOD\n\n**Example:** $5,000/mo × 24 mo → after 6 mo, increases to $6,000/mo\n- New Total: $30K + $108K = $138K\n- New Rate: $138K / 24 = $5,750/mo\n- Closed (6 mo): Should have been $5,750 × 6 = $34,500\n- Was recognized: $5,000 × 6 = $30,000\n- Catch-up in Month 7: $4,500\n\n**Waterfall output (both ZR lines, consistent avg rate):**\n| Line | POB Name | Period | Amount | Notes |\n|------|----------|--------|--------|-------|\n| 1 | Platform (Original) | Jan-25 | $5,750 | Restated |\n| 1 | Platform (Original) | ... | $5,750 | ... |\n| 1 | Platform (Original) | Jun-25 | $5,750 | Last closed |\n| 2 | Platform (Post-Mod) | Jul-25 | $10,250 | $5,750 + $4,500 catch-up |\n| 2 | Platform (Post-Mod) | Aug-25 | $5,750 | Avg rate continues |\n\nRef: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications/accounting-treatments\n\n### Prospective (New POB Added)\n\nWhen new distinct deliverable added:\n- Existing POB: unchanged recognition\n- New POB: separate allocation and recognition\n\n---\n\n## Variable Consideration (VC) in Waterfall\n\nFor charges with uncertain amounts:\n\n1. Recognize only the CONSTRAINED estimate initially\n2. When uncertainty resolves, recognize adjustment in that period\n3. VC adjustments may result in catch-up or reduction entries\n\n**VC Types and Recognition:**\n| Type | Recognition Pattern |\n|------|-------------------|\n| Rebates | Reduce revenue ratably or at rebate event |\n| Performance Bonus | Recognize when probable and estimable |\n| Right of Return | Defer portion until return period expires |\n| Usage Uncertainty | Recognize as usage becomes known |\n\n---\n\n## Prepay Drawdown (PPDD)\n\nPPDD has two recognition patterns based on POB template:\n\n### Ratable Recognition (BK-OT-CONSUMP-RATABLE)\n- Prepaid amount spread evenly over term\n- Recognition NOT tied to consumption\n- Example: $12,000 prepaid / 12 months = $1,000/month\n\n### Consumption Recognition (EVT-PIT-CONSUMP-USAGE)\n- Revenue = $0 until consumption events occur\n- Each consumption event: Amount = Units × Unit Rate\n- **CRITICAL:** Do NOT spread ratably—this is event-driven\n\n**Example:** $50,000 prepaid for 500K API calls @ $0.10/call\n| Month | Calls | Revenue |\n|-------|-------|---------|\n| Jan | 30,000 | $3,000 |\n| Feb | 30,000 | $3,000 |\n| Mar | 40,000 | $4,000 |\n| ... | ... | ... |\n| Dec | 20,000 | $2,000 |\n| **Total** | 500,000 | **$50,000** |\n\n**Overage** (only after prepaid exhausted): Additional calls × Overage Rate\n\n**If no consumption data provided:** Show $0 for all periods, add open question asking for usage schedule.\n\n### Key PPDD Principles\n1. Check POB template to determine pattern (ratable vs consumption)\n2. Deferred revenue created at prepayment billing\n3. Overage only occurs AFTER prepaid balance exhausted\n4. If no usage data for consumption-based: ask in open questions\n\n---\n\n## Output\n\nGenerate one row per Line Item per Period:\n\n```json\n{\n  \"zr_revrec\": [\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Jan-26\",\n      \"Amount\": 1019.18\n    },\n    {\n      \"Line Item Num\": 1,\n      \"POB Name\": \"Platform License\",\n      \"Event Name\": \"Upon Booking\",\n      \"Revenue Start Date\": \"2026-01-01\",\n      \"Revenue End Date\": \"2026-12-31\",\n      \"Ext Allocated Price\": 12000,\n      \"Period\": \"Feb-26\",\n      \"Amount\": 920.55\n    }\n  ],\n  \"assumptions\": [\"Daily proration method used\"],\n  \"open_questions\": []\n}\n```\n\n**Period format:** \"MMM-YY\" (e.g., \"Jan-26\", \"Feb-26\")\n\n**Validation before returning:**\n1. Sum of all Amount for each Line Item = Ext Allocated Price\n2. Periods cover Revenue Start to Revenue End with no gaps\n3. Event-driven charges show $0 when no events provided\n4. POB Name and Event Name match the POB mapping\n\n---\n\n## Reference Documentation\n\n- Revenue Waterfall: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/waterfall-summary\n- Contract Modifications: https://docs.zuora.com/en/zuora-revenue/advanced-revenue-operations/contract-modifications\n- Ramp Deals: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/ramp-deals\n- VC Processing: https://docs.zuora.com/en/zuora-revenue/day-to-day-operation/variable-consideration-processing\n- Prepaid with Drawdown: https://docs.zuora.com/en/zuora-billing/manage-subscriptions/prepaid-with-drawdown"
        },
        {
          "role": "user",
          "content": "{\n  \"customer_name\": \"Mid-Month Corp\",\n  \"contract_start_date\": \"01/15/2025\",\n  \"terms_months\": 12,\n  \"transaction_currency\": \"USD\",\n  \"billing_period\": \"Monthly\",\n  \"is_allocations\": false,\n  \"use_case_description\": \"Subscription starting mid-month:\\n- Start date: January 15, 2025\\n- Monthly fee: $1,000/month\\n- First month prorated: 17 days = ~$548.39\\n- Full months February through December\\n- Last month: January 1-14, 2026 = ~$451.61\\n\"\n}"
        },
        {
          "role": "assistant",
          "content": "{\n  \"revrec_waterfall\": {\n    \"zr_revrec\": [\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jan-25\",\n        \"Amount\": 558.9\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Feb-25\",\n        \"Amount\": 920.55\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Mar-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Apr-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"May-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jun-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jul-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Aug-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Sep-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Oct-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Nov-25\",\n        \"Amount\": 986.3\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Dec-25\",\n        \"Amount\": 1019.18\n      },\n      {\n        \"Line Item Num\": 1,\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"Event Name\": \"Upon Booking\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Ext Allocated Price\": 12000,\n        \"Period\": \"Jan-26\",\n        \"Amount\": 460.27\n      }\n    ],\n    \"assumptions\": [\n      \"Ratable straight-line daily recognition per WATERFALL INSTRUCTIONS (Daily Rate = 12000 / 365 days).\",\n      \"Revenue window treated as inclusive of both Revenue Start Date (2025-01-15) and Revenue End Date (2026-01-14).\",\n      \"Monthly amounts rounded to 2 decimals; rounding produced an exact tie-out to $12,000.00 for the line item.\"\n    ],\n    \"open_questions\": []\n  },\n  \"contracts_orders\": {\n    \"zr_contracts_orders\": [\n      {\n        \"POB Name\": \"Monthly Subscription Fee\",\n        \"POB Template\": \"BK-OT-RATABLE\",\n        \"POB Satisfied\": \"Over Time\",\n        \"Release Event\": \"Upon Booking (Full Booking Release)\",\n        \"Billing Period\": \"Month\",\n        \"Billing Timing\": \"InAdvance\",\n        \"Terms Months\": 12,\n        \"Trigger Event\": \"ContractEffective\",\n        \"Lead Line\": true,\n        \"Ordered Qty\": 12,\n        \"Line Item Num\": 1,\n        \"Subscription Name\": \"Mid-Month Corp - Subscription\",\n        \"Subscription Version\": 1,\n        \"Sales Order Date\": \"01/15/2025\",\n        \"RPC Segment\": \"Monthly Subscription Fee\",\n        \"RPC Type\": \"Recurring\",\n        \"Revenue Start Date\": \"2025-01-15\",\n        \"Revenue End Date\": \"2026-01-14\",\n        \"Unit List Price\": 1000,\n        \"Unit Sell Price\": 1000,\n        \"Ext List Price\": 12000,\n        \"Ext Sell Price\": 12000,\n        \"SSP Price\": 1000,\n        \"Ext SSP Price\": 12000,\n        \"SSP Percent\": 100,\n        \"Ext Allocated Price\": 12000,\n        \"Carves Adjustment\": 0,\n        \"Allocation Eligible Flag\": false,\n        \"Unreleased Revenue\": 12000,\n        \"Released Revenue\": 0,\n        \"Customer Name\": \"Mid-Month Corp\",\n        \"POB IDENTIFIER\": \"BK-OT-RATABLE\",\n        \"Product Category\": \"Software\",\n        \"Product Family\": \"SaaS Subscription\"\n      }\n    ],\n    \"assumptions\": [\n      \"Allocations = No, so Ext Allocated Price equals Ext Sell Price for each line.\",\n      \"Single-charge contract: SSP fields are populated for completeness; SSP Percent = 100% because there is only one line.\",\n      \"The Monthly Subscription Fee is represented as one RC line for the full service window (2025-01-15 to 2026-01-14) with total transaction price = $12,000, reflecting proration: 01/15–01/31 = $548.39 (17/31 of $1,000) + Feb–Dec (11 full months) = $11,000 + 01/01–01/14 = $451.61 (14/31 of $1,000).\",\n      \"Ordered Qty is set to 12 to align Ext Sell Price (12,000) with the $1,000 monthly rate while still producing exactly one Contracts/Orders line for this charge.\"\n    ],\n    \"open_questions\": []\n  },\n  \"pob_mapping\": {\n    \"charge_pob_map\": [\n      {\n        \"chargeName\": \"Monthly Subscription Fee\",\n        \"productName\": \"Mid-Month SaaS\",\n        \"ratePlanName\": \"Monthly Subscription (Prorated First/Last Month)\",\n        \"pob_identifier\": \"BK-OT-RATABLE\",\n        \"pob_name\": \"BK-OT-RATABLE\",\n        \"ratable_method\": \"Ratable\",\n        \"release_event\": \"Upon Booking (Full Booking Release)\",\n        \"recognition_window\": {\n          \"start\": \"2025-01-15\",\n          \"end\": \"2026-01-14\"\n        },\n        \"rationale\": \"Standard SaaS stand-ready access billed monthly in advance; recognize ratably over the contractual service period (mid-month start through mid-month end). Billing may prorate the first and last invoice periods, but revenue recognition remains straight-line across 2025-01-15 to 2026-01-14.\",\n        \"confidence\": 0.95,\n        \"alternatives\": [\n          {\n            \"pob_identifier\": \"BL-OT-INVRATABLE\",\n            \"pob_name\": \"Invoice Ratable\",\n            \"why_not\": \"Would defer release until billing events; use only if revenue policy requires billed-release instead of booking-release.\"\n          }\n        ]\n      }\n    ],\n    \"mapping_notes\": [\n      \"No price ramp/segmentation is required because the contractual price is constant ($1,000/month). Proration is handled by billing proration rules rather than by creating separate price segments.\",\n      \"Allocations are disabled (isAllocationEligible=false) per DO ALLOCATIONS = false.\"\n    ]\n  }\n}"
        }
      ],
      "metadata": {
        "test_case_id": "mid-month-start",
        "run_id": "3c245414-2baa-45d3-96b0-8f20145b9322",
        "created_at": "2025-12-31T21:18:00.967Z"
      }
    }
  ]
}